---
title: "Biomass Plots"
author: "Kara Dobson"
date: "3/14/2022"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# TITLE:          Biomass plots
# AUTHORS:        Kara Dobson
# COLLABORATORS:  Phoebe Zarnetske, Moriah Young, Mark Hammond, Pat Bills
# DATA INPUT:     Data imported as csv files from shared Google drive L0 folder
# DATA OUTPUT:    Visualizations of biomass data
# PROJECT:        warmXtrophic
# DATE:           March 2022

```{r}
# Clear all existing data
rm(list=ls())

#Load packages
library(tidyverse)
library(plotrix)
library(ggpubr)
library(emmeans)

# Get data
Sys.getenv("L1DIR")
L1_dir<-Sys.getenv("L1DIR")
list.files(L1_dir)
kbs_biomass_21 <- read.csv(file.path(L1_dir, "ANPP/kbs_biomass_2021_L1.csv"))
umbs_biomass_21 <- read.csv(file.path(L1_dir, "ANPP/umbs_biomass_2021_L1.csv"))
kbs_biomass_21 <- kbs_biomass_21 %>% dplyr::select(-X) # get rid of "X" column that shows up (could fix this in cleaning script)
umbs_biomass_21 <- umbs_biomass_21 %>% dplyr::select(-X)

# making separate dataframe for biomass - easier in plots
kbs_biomass_only <- kbs_biomass_21 %>%
        select(-cover) %>%
        drop_na(weight_g)
umbs_biomass_only <- umbs_biomass_21 %>%
        select(-cover) %>%
        drop_na(weight_g)

# remove uninformative species
kbs_biomass_live <- kbs_biomass_only[!grepl("Litter", kbs_biomass_only$species),]
umbs_biomass_live <- umbs_biomass_only[!grepl("Litter", umbs_biomass_only$species),]
umbs_biomass_live <- umbs_biomass_live[!grepl("Standing_Dead", umbs_biomass_live$species),]
umbs_biomass_live <- umbs_biomass_live[!grepl("Surface_Litter", umbs_biomass_live$species),]

# keeping species found only in w and a
kbs_biomass_live2 <- kbs_biomass_live %>%
        group_by(species) %>% 
        filter(all(c('warmed', 'ambient') %in% state))
umbs_biomass_live2 <- umbs_biomass_live %>%
        group_by(species) %>% 
        filter(all(c('warmed', 'ambient') %in% state))

### Overall averages btwn treatments - barplot
biomass_sum_k <- kbs_biomass_live %>%
        group_by(state) %>%
        summarize(avg_weight = mean(weight_g, na.rm = TRUE),
                  se = std.error(weight_g, na.rm = TRUE))
ggplot(biomass_sum_k, aes(x = state, y = avg_weight, fill = state)) +
        geom_bar(position = "identity", stat = "identity", col = "black") +
        geom_errorbar(aes(ymin = avg_weight - se, ymax = avg_weight + se), width = 0.2,
                      position = "identity") +
        labs(title="KBS") +
        scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
        scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
        theme_classic()

biomass_sum_u <- umbs_biomass_live %>%
        group_by(state) %>%
        summarize(avg_weight = mean(weight_g, na.rm = TRUE),
                  se = std.error(weight_g, na.rm = TRUE))
ggplot(biomass_sum_u, aes(x = state, y = avg_weight, fill = state)) +
        geom_bar(position = "identity", stat = "identity", col = "black") +
        geom_errorbar(aes(ymin = avg_weight - se, ymax = avg_weight + se), width = 0.2,
                      position = "identity") +
        labs(title="UMBS")+
        scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
        scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
        theme_classic()


### Overall averages btwn treatments - boxplot
ggplot(kbs_biomass_live, aes(x = state, y = weight_g, fill=state)) +
        geom_boxplot(outlier.shape=NA, alpha=0.7) +
        geom_jitter(aes(alpha=0.6, color=state, fill=state), shape=16, size=2) +
        scale_color_manual(values = c("#a6bddb", "#fb6a4a")) +
        scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
        labs(title="KBS")+
        scale_x_discrete(labels=c("ambient" = "Ambient", "warmed" = "Warmed")) +
        theme_classic()
ggplot(umbs_biomass_live, aes(x = state, y = weight_g, fill=state)) +
        geom_boxplot(outlier.shape=NA, alpha=0.7) +
        geom_jitter(aes(alpha=0.6, color=state, fill=state), shape=16, size=2) +
        scale_color_manual(values = c("#a6bddb", "#fb6a4a")) +
        scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
        labs(title="UMBS")+
        scale_x_discrete(labels=c("ambient" = "Ambient", "warmed" = "Warmed")) +
        theme_classic()

### Line plot of species responses to warming
mod11_k <- lm(log(weight_g) ~ state * species, kbs_biomass_live2)
emmip(mod11_k, species~state) +
        labs(title="KBS")
mod11_u <- lm(log(weight_g) ~ state * species, umbs_biomass_live2)
emmip(mod11_u, species~state)+
        labs(title="UMBS")

### Differences between warmed and ambient at a species level
biomass_spp_k <- kbs_biomass_live2 %>%
        group_by(species, state) %>%
        summarize(avg_weight = mean(weight_g, na.rm = TRUE),
                  se = std.error(weight_g, na.rm = TRUE))
ggplot(biomass_spp_k, aes(x = species, y = avg_weight, fill = state)) +
        geom_bar(position = "dodge", stat = "identity", col = "black") +
        geom_errorbar(aes(ymin = avg_weight - se, ymax = avg_weight + se), width = 0.2,
                      position = position_dodge(0.9)) +
        labs(title="KBS") +
        scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
        scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
        theme_classic()

biomass_spp_u <- umbs_biomass_live2 %>%
        group_by(species, state) %>%
        summarize(avg_weight = mean(weight_g, na.rm = TRUE),
                  se = std.error(weight_g, na.rm = TRUE))
ggplot(biomass_spp_u, aes(x = species, y = avg_weight, fill = state)) +
        geom_bar(position = "dodge", stat = "identity", col = "black") +
        geom_errorbar(aes(ymin = avg_weight - se, ymax = avg_weight + se), width = 0.2,
                      position = position_dodge(0.9)) +
        labs(title="UMBS") +
        scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
        scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
        theme_classic()
```
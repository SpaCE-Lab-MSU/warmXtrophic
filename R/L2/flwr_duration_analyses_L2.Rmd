---
title: "warmXtrophic Project: Flowering Duration Phenology Analyses"
author: "Moriah Young, Kara Dobson"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=80),tidy=TRUE)
```

# Load in packages & data
```{r, message = F}
# clear all existing data
rm(list=ls())

#Load packages
library(tidyverse)
library(ggplot2)
library(lme4)
library(lmerTest)
library(emmeans)
library(vegan)
library(car)
library(rstatix)
library(scales)
library(fitdistrplus)
library(moments)# for calculating skewness of data
library(ggpubr)
library(jtools) # summ() function
library(predictmeans)
library(olsrr)
library(car)
library(fitdistrplus)
library(ggpubr)
library(interactions)
library(sjPlot)
library(effects)
library(glmmTMB)
library(GGally) # ggpairs() function
library(bbmle) # AICtab() function

# Set working directory
Sys.getenv("L1DIR")
L0_dir <- Sys.getenv("L0DIR")
L1_dir <- Sys.getenv("L1DIR")
L2_dir <- Sys.getenv("L2DIR")

# Set ggplot2 plotting
# This code for ggplot2 sets the theme to mostly black and white 
# (Arial font, and large font, base size=24)
theme_set(theme_bw(14))
theme_update(axis.text.x = element_text(size = 12, angle = 90),
             axis.text.y = element_text(size = 12))

# Read in data
flwr_species <- read.csv(file.path(L2_dir, "phenology/final_flwr_species_L2.csv")) # species level data
flwr_plot <- read.csv(file.path(L2_dir, "phenology/final_flwr_plot_L2.csv")) # plot level data
flwr_plot_origin <- read.csv(file.path(L2_dir, "phenology/final_flwr_plot_origin_L2.csv")) # plot level data for origin
flwr_plot_growthhabit <- read.csv(file.path(L2_dir, "phenology/final_flwr_plot_growthhabit_L2.csv")) # plot level data for growth habit

# get rid of "X" column that shows up
flwr_species$X <- NULL
flwr_plot$X <- NULL
flwr_plot_origin$X <- NULL
flwr_plot_growthhabit$X <- NULL

# Order warmed and ambient so that warmed shows up first in plotting (and is default is red = warmed; blue = ambient). First make it a factor
flwr_species$state <- as.factor(flwr_species$state)
levels(flwr_species$state)
# [1] "ambient" "warmed" 
flwr_species$state <- factor(flwr_species$state, levels(flwr_species$state)[c(2,1)])
levels(flwr_species$state)
# [1] "warmed"  "ambient"

# again for plot level data
flwr_plot$state <- as.factor(flwr_plot$state)
levels(flwr_plot$state)
# [1] "ambient" "warmed" 
flwr_plot$state <- factor(flwr_plot$state, levels(flwr_plot$state)[c(2,1)])
levels(flwr_plot$state)
# [1] "warmed"  "ambient"

flwr_species$flwr_duration <- as.numeric(as.character(flwr_species$flwr_duration))
flwr_plot$flwr_duration <- as.numeric(as.character(flwr_plot$flwr_duration))
flwr_plot_origin$flwr_duration <- as.numeric(as.character(flwr_plot_origin$flwr_duration))
flwr_plot_growthhabit$flwr_duration <- as.numeric(as.character(flwr_plot_growthhabit$flwr_duration))

# Kara's edits:
# adding 1 to each occurrence in the flwr_duration column so everything is scaled up the same & removes 0's
flwr_plot$flwr_duration_scaled <- flwr_plot$flwr_duration+1
flwr_species$flwr_duration_scaled <- flwr_species$flwr_duration+1
flwr_plot_origin$flwr_duration_scaled <- flwr_plot_origin$flwr_duration+1
flwr_plot_growthhabit$flwr_duration_scaled <- flwr_plot_growthhabit$flwr_duration+1

umbs_flwr_plot <- subset(flwr_plot, site == "umbs") # pull out umbs only data at plot level
umbs_flwr_spp <- subset(flwr_species, site == "umbs") # pull out umbs only data at species level
kbs_flwr_plot <- subset(flwr_plot, site == "kbs") # pull out kbs only data at plot level
kbs_flwr_spp <- subset(flwr_species, site == "kbs") # pull out kbs only data at species level
kbs_flwr_plot_origin <- subset(flwr_plot_origin, site == "kbs")
kbs_flwr_plot_growthhabit <- subset(flwr_plot_growthhabit, site == "kbs")
umbs_flwr_plot_origin <- subset(flwr_plot_origin, site == "umbs")
umbs_flwr_plot_growthhabit <- subset(flwr_plot_growthhabit, site == "umbs")

```

# KBS SPECIES LEVEL - Looking at DURATION of flowering
```{r, warning=F, error=TRUE}
### KBS ###
# Kara editing: I didn't change these below to the flwr_duration_scaled column, but they'd probably look about the same
hist(kbs_flwr_spp$flwr_duration_scaled)
qqnorm(kbs_flwr_spp$flwr_duration_scaled)
shapiro.test(kbs_flwr_spp$flwr_duration) # pvalue is < 0.05 so we reject the null hypothesis that the data is normal (aka not normally distributed)

# Kara editing: maybe log transforming or log transforming the data could help here since its right skewed
kbs_flwr_spp$flwr_log <- log(kbs_flwr_spp$flwr_duration_scaled)
hist(kbs_flwr_spp$flwr_log)
qqnorm(kbs_flwr_spp$flwr_log)
shapiro.test(kbs_flwr_spp$flwr_log) #eh, not great

# Visualizing median Julian date for umbs at the PLOT LEVEL
ggplot(kbs_flwr_spp, aes(flwr_duration_scaled, fill = plot)) + 
        geom_histogram(binwidth = 0.5) + 
        facet_grid(year ~ site, margins = TRUE, scales = "free")

ggplot(kbs_flwr_spp, aes(flwr_duration_scaled, fill = as.factor(plot))) + geom_histogram(binwidth = 0.5) + 
        facet_grid(state~year, margins = TRUE, scales = "free")

ggplot(kbs_flwr_spp, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1)

ggplot(kbs_flwr_spp, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1) +
        facet_wrap(~year)

ggplot(kbs_flwr_spp, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1) +
        facet_wrap(~year + plot)

# Exploring distributions for these right-skewed data:
descdist(kbs_flwr_spp$flwr_duration_scaled, discrete = FALSE)

# Gamma distribution 
fit.gamma <- fitdist(kbs_flwr_spp$flwr_duration_scaled, "gamma")
plot(fit.gamma)

# Weibull distribution
fit.weibull  <- fitdist(kbs_flwr_spp$flwr_duration_scaled, "weibull")
plot(fit.weibull)

# Lognormal distribution 
fit.ln <- fitdist(kbs_flwr_spp$flwr_duration_scaled, "lnorm")
plot(fit.ln)

par(mfrow=c(2,2))
plot.legend <- c("Gamma", "Weibull", "Log Normal")
denscomp(list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
cdfcomp (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
qqcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
ppcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)

# Goodness of fit comparisons across fits (can't include the log normal bc it becomes diff response values)
gofstat(list(fit.gamma, fit.weibull, fit.ln), fitnames = c("Gamma", "Weibull", "Log Normal"))
# weibull best fit
```

# KBS PLOT LEVEL - Looking at DURATION of flowering
```{r, warning=F, error=TRUE}
### KBS ###
hist(kbs_flwr_plot$flwr_duration_scaled)
qqnorm(kbs_flwr_plot$flwr_duration_scaled)
shapiro.test(kbs_flwr_plot$flwr_duration_scaled) # pvalue is > 0.05 so we do not reject the null hypothesis that the data is normal (aka normally distributed)

# Visualizing median Julian date for umbs at the PLOT LEVEL
ggplot(kbs_flwr_plot, aes(flwr_duration_scaled, fill = plot)) + 
        geom_histogram(binwidth = 0.5) + 
        facet_grid(year ~ site, margins = TRUE, scales = "free")

ggplot(kbs_flwr_plot, aes(flwr_duration_scaled, fill = as.factor(plot))) + geom_histogram(binwidth = 0.5) + 
        facet_grid(state~year, margins = TRUE, scales = "free")

ggplot(kbs_flwr_plot, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1)

ggplot(kbs_flwr_plot, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1) +
        facet_wrap(~year)

ggplot(kbs_flwr_plot, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1) +
        facet_wrap(~year + plot)

# Exploring distributions for these data:
descdist(kbs_flwr_plot$flwr_duration_scaled, discrete = FALSE)

# Gamma distribution 
fit.gamma <- fitdist(kbs_flwr_plot$flwr_duration_scaled, "gamma")
plot(fit.gamma)

# Weibull distribution
fit.weibull  <- fitdist(kbs_flwr_plot$flwr_duration_scaled, "weibull")
plot(fit.weibull)

# Lognormal distribution 
fit.ln <- fitdist(kbs_flwr_plot$flwr_duration_scaled, "lnorm")
plot(fit.ln)

par(mfrow=c(2,2))
plot.legend <- c("Gamma", "Weibull", "Log Normal")
denscomp(list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
cdfcomp (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
qqcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
ppcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)

# Goodness of fit comparisons across fits (can't include the log normal bc it becomes diff response values)
gofstat(list(fit.gamma, fit.weibull, fit.ln), fitnames = c("Gamma", "Weibull", "Log Normal"))
# weibull
```

# KBS PLOT LEVEL ORIGIN - Looking at DURATION of flowering
```{r, warning=F, error=TRUE}
### KBS ###
hist(kbs_flwr_plot_origin$flwr_duration_scaled)
qqnorm(kbs_flwr_plot_origin$flwr_duration_scaled)
shapiro.test(kbs_flwr_plot_origin$flwr_duration_scaled) # pvalue is < 0.05 so we reject the null hypothesis that the data is normal (aka not normally distributed) 

# Visualizing median Julian date for umbs at the PLOT LEVEL
ggplot(kbs_flwr_plot_origin, aes(flwr_duration_scaled, fill = plot)) + 
        geom_histogram(binwidth = 0.5) + 
        facet_grid(year ~ site, margins = TRUE, scales = "free")

ggplot(kbs_flwr_plot_origin, aes(flwr_duration_scaled, fill = as.factor(plot))) + geom_histogram(binwidth = 0.5) + 
        facet_grid(state~year, margins = TRUE, scales = "free")

ggplot(kbs_flwr_plot_origin, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1)

ggplot(kbs_flwr_plot_origin, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1) +
        facet_wrap(~year)

ggplot(kbs_flwr_plot_origin, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1) +
        facet_wrap(~year + plot)

# Exploring distributions for these data:
descdist(kbs_flwr_plot_origin$flwr_duration_scaled, discrete = FALSE)

# Gamma distribution 
fit.gamma <- fitdist(kbs_flwr_plot_origin$flwr_duration_scaled, "gamma")
plot(fit.gamma)

# Weibull distribution
fit.weibull  <- fitdist(kbs_flwr_plot_origin$flwr_duration_scaled, "weibull")
plot(fit.weibull)

# Lognormal distribution 
fit.ln <- fitdist(kbs_flwr_plot_origin$flwr_duration_scaled, "lnorm")
plot(fit.ln)

par(mfrow=c(2,2))
plot.legend <- c("Gamma", "Weibull", "Log Normal")
denscomp(list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
cdfcomp (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
qqcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
ppcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)

# Goodness of fit comparisons across fits (can't include the log normal bc it becomes diff response values)
gofstat(list(fit.gamma, fit.weibull, fit.ln), fitnames = c("Gamma", "Weibull", "Log Normal"))
# weibull
```

# KBS PLOT LEVEL GROWTH HABIT - Looking at DURATION of flowering
```{r, warning=F, error=TRUE}
### KBS ###
hist(kbs_flwr_plot_growthhabit$flwr_duration_scaled)
qqnorm(kbs_flwr_plot_growthhabit$flwr_duration_scaled)
shapiro.test(kbs_flwr_plot_growthhabit$flwr_duration_scaled) # pvalue is < 0.05 so we reject the null hypothesis that the data is normal (aka not normally distributed) 

# Visualizing median Julian date for umbs at the PLOT LEVEL
ggplot(kbs_flwr_plot_growthhabit, aes(flwr_duration_scaled, fill = plot)) + 
        geom_histogram(binwidth = 0.5) + 
        facet_grid(year ~ site, margins = TRUE, scales = "free")

ggplot(kbs_flwr_plot_growthhabit, aes(flwr_duration_scaled, fill = as.factor(plot))) + geom_histogram(binwidth = 0.5) + 
        facet_grid(state~year, margins = TRUE, scales = "free")

ggplot(kbs_flwr_plot_growthhabit, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1)

ggplot(kbs_flwr_plot_growthhabit, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1) +
        facet_wrap(~year)

ggplot(kbs_flwr_plot_growthhabit, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1) +
        facet_wrap(~year + plot)

# Exploring distributions for these data:
descdist(kbs_flwr_plot_growthhabit$flwr_duration_scaled, discrete = FALSE)

# Gamma distribution 
fit.gamma <- fitdist(kbs_flwr_plot_growthhabit$flwr_duration, "gamma")
plot(fit.gamma)

# Weibull distribution
fit.weibull  <- fitdist(kbs_flwr_plot_growthhabit$flwr_duration, "weibull")
plot(fit.weibull)

# Lognormal distribution 
fit.ln <- fitdist(kbs_flwr_plot_growthhabit$flwr_duration, "lnorm")
plot(fit.ln)

par(mfrow=c(2,2))
plot.legend <- c("Gamma", "Weibull", "Log Normal")
denscomp(list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
cdfcomp (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
qqcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
ppcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)

# Goodness of fit comparisons across fits (can't include the log normal bc it becomes diff response values)
gofstat(list(fit.gamma, fit.weibull, fit.ln), fitnames = c("Gamma", "Weibull", "Log Normal"))
# weibull
```

# UMBS SPECIES LEVEL - Looking at DURATION of flowering
```{r, warning=F, error=TRUE}
### UMBS ###
hist(umbs_flwr_spp$flwr_duration_scaled)
qqnorm(umbs_flwr_spp$flwr_duration_scaled)
shapiro.test(umbs_flwr_spp$flwr_duration_scaled) # pvalue is < 0.05 so we reject the null hypothesis that the data is normal (aka not normally distributed)

# Visualizing median Julian date for umbs at the PLOT LEVEL
ggplot(umbs_flwr_spp, aes(flwr_duration_scaled, fill = plot)) + 
        geom_histogram(binwidth = 0.5) + 
        facet_grid(year ~ site, margins = TRUE, scales = "free")

ggplot(umbs_flwr_spp, aes(flwr_duration_scaled, fill = as.factor(plot))) + geom_histogram(binwidth = 0.5) + 
        facet_grid(state~year, margins = TRUE, scales = "free")

ggplot(umbs_flwr_spp, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1)

ggplot(umbs_flwr_spp, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1) +
        facet_wrap(~year)

ggplot(umbs_flwr_spp, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1) +
        facet_wrap(~year + plot)

# Exploring distributions for these right-skewed data:
descdist(umbs_flwr_spp$flwr_duration_scaled, discrete = FALSE)

# Gamma distribution 
fit.gamma <- fitdist(umbs_flwr_spp$flwr_duration_scaled, "gamma")
plot(fit.gamma)

# Weibull distribution
fit.weibull  <- fitdist(umbs_flwr_spp$flwr_duration_scaled, "weibull")
plot(fit.weibull)

# Lognormal distribution 
fit.ln <- fitdist(umbs_flwr_spp$flwr_duration_scaled, "lnorm")
plot(fit.ln)

par(mfrow=c(2,2))
plot.legend <- c("Gamma", "Weibull", "Log Normal")
denscomp(list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
cdfcomp (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
qqcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
ppcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)

# Goodness of fit comparisons across fits (can't include the log normal bc it becomes diff response values)
gofstat(list(fit.gamma, fit.weibull, fit.ln), fitnames = c("Gamma", "Weibull", "Log Normal"))
# weibull
```

# UMBS PLOT LEVEL - Looking at DURATION of flowering
```{r, warning=F, error=TRUE}
### UMBS ###
hist(umbs_flwr_plot$flwr_duration_scaled)
qqnorm(umbs_flwr_plot$flwr_duration_scaled)
shapiro.test(umbs_flwr_plot$flwr_duration_scaled) # pvalue is > 0.05 so we accept the null hypothesis that the data is normally distributed! WOO

# Visualizing median Julian date for umbs at the PLOT LEVEL
ggplot(umbs_flwr_plot, aes(flwr_duration_scaled, fill = plot)) + 
        geom_histogram(binwidth = 0.5) + 
        facet_grid(year ~ site, margins = TRUE, scales = "free")

ggplot(umbs_flwr_plot, aes(flwr_duration_scaled, fill = as.factor(plot))) + geom_histogram(binwidth = 0.5) + 
        facet_grid(state~year, margins = TRUE, scales = "free")

ggplot(umbs_flwr_plot, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1)

ggplot(umbs_flwr_plot, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1) +
        facet_wrap(~year)

ggplot(umbs_flwr_plot, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1) +
        facet_wrap(~year + plot)

# Exploring distributions for these data:
descdist(umbs_flwr_plot$flwr_duration_scaled, discrete = FALSE)

# Gamma distribution 
fit.gamma <- fitdist(umbs_flwr_plot$flwr_duration_scaled, "gamma")
plot(fit.gamma)

# Weibull distribution
fit.weibull  <- fitdist(umbs_flwr_plot$flwr_duration_scaled, "weibull")
plot(fit.weibull)

# Lognormal distribution 
fit.ln <- fitdist(umbs_flwr_plot$flwr_duration_scaled, "lnorm")
plot(fit.ln)

par(mfrow=c(2,2))
plot.legend <- c("Gamma", "Weibull", "Log Normal")
denscomp(list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
cdfcomp (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
qqcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
ppcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)

# Goodness of fit comparisons across fits (can't include the log normal bc it becomes diff response values)
gofstat(list(fit.gamma, fit.weibull, fit.ln), fitnames = c("Gamma", "Weibull", "Log Normal"))
# Weibull 
```

# UMBS PLOT LEVEL ORIGIN - Looking at DURATION of flowering
```{r, warning=F, error=TRUE}
### UMBS ###
hist(umbs_flwr_plot_origin$flwr_duration_scaled)
qqnorm(umbs_flwr_plot_origin$flwr_duration_scaled)
shapiro.test(kbs_flwr_plot_origin$flwr_duration_scaled) # pvalue is < 0.05 so we reject the null hypothesis that the data is normal (aka not normally distributed) 

# Visualizing median Julian date for umbs at the PLOT LEVEL
ggplot(umbs_flwr_plot_origin, aes(flwr_duration_scaled, fill = plot)) + 
        geom_histogram(binwidth = 0.5) + 
        facet_grid(year ~ site, margins = TRUE, scales = "free")

ggplot(umbs_flwr_plot_origin, aes(flwr_duration_scaled, fill = as.factor(plot))) + geom_histogram(binwidth = 0.5) + 
        facet_grid(state~year, margins = TRUE, scales = "free")

ggplot(umbs_flwr_plot_origin, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1)

ggplot(umbs_flwr_plot_origin, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1) +
        facet_wrap(~year)

ggplot(umbs_flwr_plot_origin, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1) +
        facet_wrap(~year + plot)

# Exploring distributions for these data:
descdist(umbs_flwr_plot_origin$flwr_duration_scaled, discrete = FALSE)

# Gamma distribution 
fit.gamma <- fitdist(umbs_flwr_plot_origin$flwr_duration_scaled, "gamma")
plot(fit.gamma)

# Weibull distribution
fit.weibull  <- fitdist(umbs_flwr_plot_origin$flwr_duration_scaled, "weibull")
plot(fit.weibull)

# Lognormal distribution 
fit.ln <- fitdist(umbs_flwr_plot_origin$flwr_duration_scaled, "lnorm")
plot(fit.ln)

par(mfrow=c(2,2))
plot.legend <- c("Gamma", "Weibull", "Log Normal")
denscomp(list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
cdfcomp (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
qqcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
ppcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)

# Goodness of fit comparisons across fits (can't include the log normal bc it becomes diff response values)
gofstat(list(fit.gamma, fit.weibull, fit.ln), fitnames = c("Gamma", "Weibull", "Log Normal"))
# weibull
```

# UMBS PLOT LEVEL GROWTH HABIT - Looking at DURATION of flowering
```{r, warning=F, error=TRUE}
### KBS ###
hist(umbs_flwr_plot_growthhabit$flwr_duration_scaled)
qqnorm(umbs_flwr_plot_growthhabit$flwr_duration_scaled)
shapiro.test(umbs_flwr_plot_growthhabit$flwr_duration_scaled) # pvalue is < 0.05 so we reject the null hypothesis that the data is normal (aka not normally distributed) 

# Visualizing median Julian date for umbs at the PLOT LEVEL
ggplot(umbs_flwr_plot_growthhabit, aes(flwr_duration_scaled, fill = plot)) + 
        geom_histogram(binwidth = 0.5) + 
        facet_grid(year ~ site, margins = TRUE, scales = "free")

ggplot(umbs_flwr_plot_growthhabit, aes(flwr_duration_scaled, fill = as.factor(plot))) + geom_histogram(binwidth = 0.5) + facet_grid(state~year, margins = TRUE, scales = "free")

ggplot(umbs_flwr_plot_growthhabit, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1)

ggplot(umbs_flwr_plot_growthhabit, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1) +
        facet_wrap(~year)

ggplot(umbs_flwr_plot_growthhabit, aes(flwr_duration_scaled, fill = plot, color=plot)) +
        geom_density(alpha = 0.1) +
        facet_wrap(~year + plot)

# Exploring distributions for these data:
descdist(umbs_flwr_plot_growthhabit$flwr_duration_scaled, discrete = FALSE)

# none of these work below and idk why
# Gamma distribution 
fit.gamma <- fitdist(umbs_flwr_plot_growthhabit$flwr_duration_scaled, "gamma")
plot(fit.gamma)

# Weibull distribution
fit.weibull  <- fitdist(umbs_flwr_plot_growthhabit$flwr_duration_scaled, "weibull")
plot(fit.weibull)

# Lognormal distribution 
fit.ln <- fitdist(umbs_flwr_plot_growthhabit$flwr_duration_scaled, "lnorm")
plot(fit.ln)

par(mfrow=c(2,2))
plot.legend <- c("Gamma", "Weibull", "Log Normal")
denscomp(list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
cdfcomp (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
qqcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
ppcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)

# Goodness of fit comparisons across fits (can't include the log normal bc it becomes diff response values)
gofstat(list(fit.gamma, fit.weibull, fit.ln), fitnames = c("Gamma", "Weibull", "Log Normal"))
# weibull
```

# Leverage plots and detecting Outliers. https://www.statmethods.net/stats/rdiagnostics.html
# These illustrate whether certain data points have more leverage (more influence), and thus could be outliers. It's a way of detecting outliers. Leverage plots can help identify whether a point has high or low influence, based on its leverage and residual and determining model fit with and without the point in question. Ultimately you decide whether the points are outliers or not, based on the knowledge of the system and how much it changes the model when included vs. excluded from the data used to fit the model. Here is a good overview of the combination of leverage and residual: scroll down to sections beginning at "13.3 Unusual Observations": https://daviddalpiaz.github.io/appliedstats/model-diagnostics.html

# KBS
```{r}
# species level data
# KBS State-only model
fit_spp_state_kbs <- lm(log(flwr_duration_scaled) ~ state, data = kbs_flwr_spp)
outlierTest(fit_spp_state_kbs) # no outliers
qqPlot(fit_spp_state_kbs, main="QQ Plot") 
hist(fit_spp_state_kbs$residuals)
leveragePlots(fit_spp_state_kbs)
ols_test_normality(fit_spp_state_kbs)

# KBS State and year model
fit_spp_stateyear_kbs <- lm(log(flwr_duration_scaled) ~ state + year_factor, data = kbs_flwr_spp)
outlierTest(fit_spp_stateyear_kbs) # no outliers
qqPlot(fit_spp_stateyear_kbs, main="QQ Plot") 
hist(fit_spp_stateyear_kbs$residuals)
leveragePlots(fit_spp_stateyear_kbs)
ols_test_normality(fit_spp_stateyear_kbs)

# Interaction plot (ignore for now the repeated measures with species); see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(log(flwr_duration_scaled) ~ state + year_factor + species, data = kbs_flwr_spp)
interact_plot(fit3, pred = year_factor, modx = state)
fit4 <- lm(log(flwr_duration_scaled) ~ state * year_factor + species, data = kbs_flwr_spp)
interact_plot(fit4, pred = year_factor, modx = state, mod2 = species)
```

```{r}
# Plot level data
# KBS State-only model
fit_plot_state_kbs <- lm(log(flwr_duration_scaled) ~ state, data = kbs_flwr_plot)
outlierTest(fit_plot_state_kbs) # outliers
qqPlot(fit_plot_state_kbs, main="QQ Plot") 
hist(fit_plot_state_kbs$residuals)
leveragePlots(fit_plot_state_kbs)
ols_test_normality(fit_plot_state_kbs) # looks ok besides Kolmogorov-Smirnov test

# KBS State and year model
fit_plot_stateyear_kbs <- lm(log(flwr_duration_scaled) ~ state + year_factor, data = kbs_flwr_plot)
outlierTest(fit_plot_stateyear_kbs) # outliers
qqPlot(fit_plot_stateyear_kbs, main="QQ Plot") 
hist(fit_plot_stateyear_kbs$residuals)
leveragePlots(fit_plot_stateyear_kbs)
ols_test_normality(fit_plot_stateyear_kbs) # a couple tests say not normal 

# Interaction plot (ignore for now the repeated measures with species); see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(log(flwr_duration_scaled) ~ state * year_factor, data = kbs_flwr_plot)
interact_plot(fit3, pred = year_factor, modx = state) # this looks very strange to me
```

```{r}
# Plot level ORIGIN data
# KBS State-only model
fit_plot_state_kbs_origin <- lm(flwr_duration_scaled ~ state, data = kbs_flwr_plot_origin)
outlierTest(fit_plot_state_kbs_origin) # no outliers
qqPlot(fit_plot_state_kbs_origin, main="QQ Plot") 
hist(fit_plot_state_kbs_origin$residuals)
leveragePlots(fit_plot_state_kbs_origin)
ols_test_normality(fit_plot_state_kbs_origin) # looks ok besides Kolmogorov-Smirnov test

# KBS State and year model
fit_plot_stateyear_kbs_origin <- lm(flwr_duration_scaled ~ state + year_factor, data = kbs_flwr_plot_origin)
outlierTest(fit_plot_stateyear_kbs_origin) # no outliers
qqPlot(fit_plot_stateyear_kbs_origin, main="QQ Plot") 
hist(fit_plot_stateyear_kbs_origin$residuals)
leveragePlots(fit_plot_stateyear_kbs_origin)
ols_test_normality(fit_plot_stateyear_kbs_origin) # a couple tests say not normal 

# Interaction plot (ignore for now the repeated measures with species); see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(flwr_duration_scaled ~ state * year_factor, data = kbs_flwr_plot_origin)
interact_plot(fit3, pred = year_factor, modx = state) # this looks very strange to me
```

```{r}
# Plot level GROWTH HABIT data
# KBS State-only model
fit_plot_state_kbs_gh <- lm(flwr_duration_scaled ~ state, data = kbs_flwr_plot_growthhabit)
outlierTest(fit_plot_state_kbs_gh) # no outliers
qqPlot(fit_plot_state_kbs_gh, main="QQ Plot") 
hist(fit_plot_state_kbs_gh$residuals)
leveragePlots(fit_plot_state_kbs_gh)
ols_test_normality(fit_plot_state_kbs_gh) # looks ok besides Kolmogorov-Smirnov test

# KBS State and year model
fit_plot_stateyear_kbs_gh <- lm(flwr_duration_scaled ~ state + year_factor, data = kbs_flwr_plot_growthhabit)
outlierTest(fit_plot_stateyear_kbs_gh) # no outliers
qqPlot(fit_plot_stateyear_kbs_gh, main="QQ Plot") 
hist(fit_plot_stateyear_kbs_gh$residuals)
leveragePlots(fit_plot_stateyear_kbs_gh)
ols_test_normality(fit_plot_stateyear_kbs_gh) # a couple tests say not normal 

# Interaction plot (ignore for now the repeated measures with species); see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(flwr_duration_scaled ~ state * year_factor, data = kbs_flwr_plot_growthhabit)
interact_plot(fit3, pred = year_factor, modx = state) # this looks very strange to me
```

# UMBS
```{r}
# log transformation wont work because we have zeros in the data so I'm going to square root the response variable since the data is skewed to the right.
# species level data
# UMBS State-only model
fit_spp_state_umbs <- lm(log(flwr_duration_scaled) ~ state, data = umbs_flwr_spp)
outlierTest(fit_spp_state_umbs) # no outliers
qqPlot(fit_spp_state_umbs, main="QQ Plot") 
hist(fit_spp_state_umbs$residuals)
leveragePlots(fit_spp_state_umbs)
ols_test_normality(fit_spp_state_umbs) # ok except Kol-Smir test

# UMBS State and year model
fit_spp_stateyear_umbs <- lm(log(flwr_duration_scaled) ~ state + year_factor, data = umbs_flwr_spp)
outlierTest(fit_spp_stateyear_umbs) # no outliers
qqPlot(fit_spp_stateyear_umbs, main="QQ Plot") 
hist(fit_spp_stateyear_umbs$residuals)
leveragePlots(fit_spp_stateyear_umbs)
ols_test_normality(fit_spp_stateyear_umbs) # ok except Kol-Smir test

# Interaction plot (ignore for now the repeated measures with species); see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(log(flwr_duration_scaled) ~ state + year_factor + species, data = umbs_flwr_spp)
interact_plot(fit3, pred = year_factor, modx = state)
fit4 <- lm(log(flwr_duration_scaled) ~ state * year_factor + species, data = umbs_flwr_spp)
interact_plot(fit4, pred = year_factor, modx = state, mod2 = species)
```

```{r}
# Plot level data
# UMBS State-only model
fit_plot_state_umbs <- lm(flwr_duration_scaled ~ state, data = umbs_flwr_plot)
outlierTest(fit_plot_state_umbs) # no outliers
qqPlot(fit_plot_state_umbs, main="QQ Plot") 
hist(fit_plot_state_umbs$residuals)
leveragePlots(fit_plot_state_umbs)
ols_test_normality(fit_plot_state_umbs) # these don't look great...

# UMBS State and year model
fit_plot_stateyear_umbs <- lm(flwr_duration_scaled ~ state + year_factor, data = umbs_flwr_plot)
outlierTest(fit_plot_stateyear_umbs) # no outliers
qqPlot(fit_plot_stateyear_umbs, main="QQ Plot") 
hist(fit_plot_stateyear_umbs$residuals)
leveragePlots(fit_plot_stateyear_umbs)
ols_test_normality(fit_plot_stateyear_umbs) # these don't look great either

# Interaction plot (ignore for now the repeated measures with species); see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(flwr_duration_scaled ~ state * year_factor, data = umbs_flwr_plot)
interact_plot(fit3, pred = year_factor, modx = state)
```

```{r}
# Plot level ORIGIN data
# UMBS State-only model
fit_plot_state_umbs_origin <- lm(flwr_duration_scaled ~ state, data = umbs_flwr_plot_origin)
outlierTest(fit_plot_state_umbs_origin) # no outliers
qqPlot(fit_plot_state_umbs_origin, main="QQ Plot") 
hist(fit_plot_state_umbs_origin$residuals)
leveragePlots(fit_plot_state_umbs_origin)
ols_test_normality(fit_plot_state_umbs_origin) # these don't look great...

# UMBS State and year model
fit_plot_stateyear_umbs_origin <- lm(flwr_duration_scaled ~ state + year_factor, data = umbs_flwr_plot_origin)
outlierTest(fit_plot_stateyear_umbs_origin) # no outliers
qqPlot(fit_plot_stateyear_umbs_origin, main="QQ Plot") 
hist(fit_plot_stateyear_umbs_origin$residuals)
leveragePlots(fit_plot_stateyear_umbs_origin)
ols_test_normality(fit_plot_stateyear_umbs_origin) # these don't look great either

# Interaction plot (ignore for now the repeated measures with species); see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(flwr_duration_scaled ~ state * year_factor, data = umbs_flwr_plot_origin)
interact_plot(fit3, pred = year_factor, modx = state)
```

```{r}
# Plot level GROWTH HABIT data
# UMBS State-only model
fit_plot_state_umbs_gh <- lm(flwr_duration_scaled ~ state, data = umbs_flwr_plot_growthhabit)
outlierTest(fit_plot_state_umbs_gh) # no outliers
qqPlot(fit_plot_state_umbs_gh, main="QQ Plot") 
hist(fit_plot_state_umbs_gh$residuals)
leveragePlots(fit_plot_state_umbs_gh)
ols_test_normality(fit_plot_state_umbs_gh) # these don't look great...

# UMBS State and year model
fit_plot_stateyear_umbs_gh <- lm(flwr_duration_scaled ~ state + year_factor, data = umbs_flwr_plot_growthhabit)
outlierTest(fit_plot_stateyear_umbs_gh) # no outliers
qqPlot(fit_plot_stateyear_umbs_gh, main="QQ Plot") 
hist(fit_plot_stateyear_umbs_gh$residuals)
leveragePlots(fit_plot_stateyear_umbs_gh)
ols_test_normality(fit_plot_stateyear_umbs_gh) # these don't look great either

# Interaction plot (ignore for now the repeated measures with species); see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(flwr_duration_scaled ~ state * year_factor, data = umbs_flwr_plot_growthhabit)
interact_plot(fit3, pred = year_factor, modx = state)
```

MIXED EFFECT MODELS

KBS
```{r, error=TRUE}
# KBS SPECIES LEVEL - Looking at DURATION of flowering
mod1 <- lmer(log(flwr_duration_scaled) ~ state*year_factor + insecticide*year_factor + (1|species) + (1|plot), kbs_flwr_spp, REML = FALSE)
ggplot(kbs_flwr_spp,aes(x=plot,y=flwr_duration_scaled,col=species)) + geom_jitter() + geom_boxplot(alpha=0.2) + facet_wrap(~plot)

# Check Assumptions:
# (1) Linearity: if covariates are not categorical (year isn't)
# (2) Homogeneity: Need to Check by plotting residuals vs predicted values.
par(mfrow=c(1,2))
plot(mod1) # the ones in the data are making this look weird - idk this doesn't look great
# Homogeneity of variance looks weird here 
# Check for homogeneity of variances (true if p>0.05). If the result is not significant, the assumption of equal variances (homoscedasticity) is met (no significant difference between the group variances).
# *****Levene’s Test - tests whether or not the variance among two or more groups is equal - If the p-value is less than our chosen significance level, we can reject the null hypothesis and conclude that we have enough evidence to state that the variance among the groups is not equal (which we want).

leveneTest(residuals(mod1) ~ kbs_flwr_spp$state)
# Assumption not met
leveneTest(residuals(mod1) ~ kbs_flwr_spp$species)
# Assumption met
leveneTest(residuals(mod1) ~ kbs_flwr_spp$insecticide) 
# Assumption not met - this seems weird
leveneTest(residuals(mod1) ~ kbs_flwr_spp$plot)
# Assumption not met

# (3) Normality of error term: need to check by histogram, QQplot of residuals, could do Kolmogorov-Smirnov test.
# Check for normal residuals
qqPlot(resid(mod1))
hist(residuals(mod1))
shapiro.test(resid(mod1)) # not normally distributed resids bc p<0.05
outlierTest(mod1) # no outliers

# (4) Normality of random effect: Get the estimate of random effect (e.g., random intercepts), and check them as you would check the residual. 
require(lme4)
r_int<- ranef(mod1)$plot$`(Intercept)`
qqnorm(r_int)
# qqline(r_int) doesn't work
shapiro.test(r_int) 
# Not normally distributed random effect - p-value = 0.0015
```

```{r, error=TRUE}
# Do we need to include plot as a random effect with the KBS models?   
mod1 <- lmer(log(flwr_duration_scaled) ~ state*year_factor + insecticide*year_factor + (1|species) + (1|plot), kbs_flwr_spp, REML = FALSE)
mod2 <- lmer(log(flwr_duration_scaled) ~ state*year_factor + insecticide*year_factor + (1|species), kbs_flwr_spp, REML=FALSE)
# Run analysis of variance on each model (see this for more explanation on how anova on a linear mixed effects model is similar to an anove on a regular linear model: https://m-clark.github.io/docs/mixedModels/anovamixed.html)
anova(mod1)
anova(mod2)

anova(mod1, mod2) # Go with model 2 since pvalue >0.05, aka more complex model does not have something in it that matters (the two models are essentially the same so go w model with fewer parameters)
summ(mod1) 
summ(mod2)
AICctab(mod1, mod2, weights=T)

# Plot the fixed effects estimates for different models
# these are the fixed effects estimates from summary(mod1)
plot_model(mod2, sort.est = TRUE)
# these are the fixed predicted values:
plot_model(mod2, type = "pred", terms = c("year_factor", "state", "insecticide"))
# these are the random effects estimates
plot_model(mod2, type = "re", terms = c("species"))

# Do we need to include insecticide? (dropping insecticide from the model)
# mod2 <- lmer(log(relabun) ~ state*year_factor + insecticide*year_factor + (1|species), comp_kbs_spp, REML=FALSE)
mod3 <- lmer(log(flwr_duration_scaled) ~ state*year_factor + (1|species), kbs_flwr_spp, REML=FALSE)
anova(mod2, mod3)

AICctab(mod2, mod3, weights=T)
# Looks like no, pvalue > 0.05, so insecticide does not improve model fit so we will go with mod 3

# Does year need to be interactive with insecticide? - already removed insecticide
# mod4 <- lmer(log(julian_median) ~ state*year_factor + insecticide + (1|species) + (1|plot), umbs_flwr_spp, REML=FALSE)

# Does year need to be interactive with state?
mod5 <- lmer(log(flwr_duration_scaled) ~ state + year_factor + (1|species), kbs_flwr_spp, REML=FALSE)
anova(mod3, mod5)
# No, P>0.05 so state*year_factor doesn't strongly improve model fit so we will shift to mod5, but AIC values are super close!!

# Plot the fixed effects estimates for different models
# these are the fixed effects estimates from summary(mod5)
plot_model(mod5, sort.est = TRUE)
# these are the fixed predicted values:
plot_model(mod5, type = "pred", terms = c("year_factor", "state"))
# these are the random effects estimates
plot_model(mod5, type = "re", terms = c("species"))

# If we wanted to include plots nested within year it would look like this:
mod6 <- lmer(log(flwr_duration_scaled) ~ state + year_factor + (1|species) + (1 + year_factor|plot), kbs_flwr_spp, REML=FALSE)
anova(mod5, mod6)
AICctab(mod5, mod6, weights=T)
anova(mod5)


# We can consider an alternative model that's simpler to understand and also one that provides more insight about the species. That would be something like this:
mod7 <- lmer(log(flwr_duration_scaled) ~ state + species + (1+factor(year_factor)|plot), kbs_flwr_spp, REML=FALSE)
mod7a <- lmer(log(flwr_duration_scaled)  ~ state + species + factor(year_factor) + (1|plot), kbs_flwr_spp, REML=FALSE)
mod7b <- lmer(log(flwr_duration_scaled)  ~ state * factor(year_factor) + species + (1|plot), kbs_flwr_spp, REML=FALSE)
mod7c <- lmer(log(flwr_duration_scaled)  ~ state + species + factor(year_factor) + insecticide + (1|plot), kbs_flwr_spp, REML=FALSE)
anova(mod5, mod7) # model 7 is a better fit to data
anova(mod7, mod7a) #mod 7a
anova(mod7a, mod7b) #mod 7a - interaction between state and year does not improve model go with simpler model (mod7a)
anova(mod7a, mod7c) #models are not different than one another, go with simpler model = mod7a
summary(mod7a)
anova(mod7a) # investigates whether at least one of the levels within each factor is significantly different.
# Yes, at least one of the species is different (they do not all have the same relative abundances). 
emmeans(mod7c, list(pairwise ~ state + year_factor), adjust = "tukey")
emmeans(mod7c, list(pairwise ~ year_factor), adjust = "tukey")
emmeans(mod7c, list(pairwise ~ species), adjust = "tukey")
emmeans(mod7c, list(pairwise ~ insecticide), adjust = "tukey")

# Take a look at the estimates for each fixed effect. These are the estimates from summary(mod7a). You'll see that species vary a lot - and many of them are different from zero (meaning their half cover date is significantly different from zero).
plot_model(mod7a, sort.est = TRUE)
# if you want to standardize the estimates:
plot_model(mod7a, sort.est = TRUE, type="std") 
# these are the fixed predicted values: - note this is a new plot
plot_model(mod7a, type = "pred", terms = c("species", "state", "year_factor"))
# these are the random effects estimates
plot_model(mod7a, type = "re")

# including native vs. exotic
kbs_flwr_spp <- within(kbs_flwr_spp, origin <- relevel(factor(origin), ref = "Native")) # releveling so native is the reference
mod8 <- lmer(log(flwr_duration_scaled) ~ state * origin + (1+factor(year_factor)|plot), kbs_flwr_spp, REML=FALSE)
mod9 <- lmer(log(flwr_duration_scaled) ~ state + origin + (1+factor(year_factor)|plot), kbs_flwr_spp, REML=FALSE)
mod9a <- lmer(log(flwr_duration_scaled) ~ state + origin + factor(year_factor) + (1|plot), kbs_flwr_spp, REML=FALSE)
anova(mod8, mod9) # model 9 is a better fit to data
anova(mod9, mod9a) # mod 9a
summary(mod9a)
anova(mod9a)
emmeans(mod9a, list(pairwise ~ state + origin + year_factor), adjust = "tukey")
emmeans(mod9a, list(pairwise ~ origin), adjust = "tukey")
emmeans(mod9a, list(pairwise ~ year_factor), adjust = "tukey")

# including growth form - first with interaction term
kbs_flwr_spp <- within(kbs_flwr_spp, growth_habit <- relevel(factor(growth_habit), ref = "Forb")) # releveling so forb is the reference
mod10 <- lmer(log(flwr_duration_scaled) ~ state * growth_habit + (1+factor(year_factor)|plot), kbs_flwr_spp, REML=FALSE)
mod11 <- lmer(log(flwr_duration_scaled) ~ state + growth_habit + (1+factor(year_factor)|plot), kbs_flwr_spp, REML=FALSE)
mod11a <- lmer(log(flwr_duration_scaled) ~ state + growth_habit + factor(year_factor) + (1|plot), kbs_flwr_spp, REML=FALSE)
anova(mod10, mod11) # model 11 is a better fit to data
anova(mod11, mod11a) # model 11a is still a better fit to data
summary(mod11a)
anova(mod11a)
emmeans(mod11a, list(pairwise ~ factor(year_factor)), adjust = "tukey")
emmeans(mod11a, list(pairwise ~ growth_habit), adjust = "tukey")

# New version of our model incorporating interaction term and species within year so that there is a separate intercept and slope for each species. The issue here is that there are some species that are not found each year. Easiest to remove those from another version of this dataframe before running below. Otherwise, it's not a balanced design.
# updated mod4
mod12 <- lmer(log(flwr_duration_scaled) ~ state * factor(year_factor) + (1+factor(year_factor)|species), kbs_flwr_spp)

# So another version of this model would include the interaction but not include the nesting (and thus would assume that species aren't observed ea yr)
# updated mod5
mod13 <- lmer(log(flwr_duration_scaled) ~ state * factor(year_factor) + (1|species), kbs_flwr_spp)

# All the models ran:
mod1 <- lmer(log(flwr_duration_scaled) ~ state*year_factor + insecticide*year_factor + (1|species) + (1|plot), kbs_flwr_spp, REML=FALSE)
mod2 <- lmer(log(flwr_duration_scaled) ~ state*year_factor + insecticide*year_factor + (1|species), kbs_flwr_spp, REML=FALSE)
mod3 <- lmer(log(flwr_duration_scaled) ~ state*year_factor + (1|species), kbs_flwr_spp, REML=FALSE)
mod4 <- lmer(log(flwr_duration_scaled) ~ state*year_factor + insecticide + (1|species) + (1|plot), kbs_flwr_spp, REML=FALSE)
mod5 <- lmer(log(flwr_duration_scaled) ~ state + year_factor + (1|species), kbs_flwr_spp, REML=FALSE)
mod6 <- lmer(log(flwr_duration_scaled) ~ state + year_factor + (1|species) + (1 + year|plot), kbs_flwr_spp, REML=FALSE)
mod7 <- lmer(log(flwr_duration_scaled) ~ state + species + (1+factor(year_factor)|plot), kbs_flwr_spp, REML=FALSE)
mod7a <- lmer(log(flwr_duration_scaled) ~ state + species + factor(year_factor) + (1|plot), kbs_flwr_spp, REML=FALSE)
mod7b <- lmer(log(flwr_duration_scaled) ~ state * factor(year_factor) + species + (1|plot), kbs_flwr_spp, REML=FALSE)
mod7c <- lmer(log(flwr_duration_scaled) ~ state + species + factor(year_factor) + insecticide + (1|plot), kbs_flwr_spp, REML=FALSE)
mod8 <- lmer(log(flwr_duration_scaled) ~ state * origin + (1+factor(year_factor)|plot), kbs_flwr_spp, REML=FALSE)
mod9 <- lmer(log(flwr_duration_scaled) ~ state + origin + (1+factor(year_factor)|plot), kbs_flwr_spp, REML=FALSE)
mod9a <- lmer(log(flwr_duration_scaled) ~ state + origin + factor(year_factor) + (1|plot), kbs_flwr_spp, REML=FALSE)
mod10 <- lmer(log(flwr_duration_scaled) ~ state * growth_habit + (1+factor(year_factor)|plot), kbs_flwr_spp, REML=FALSE)
mod11 <- lmer(log(flwr_duration_scaled) ~ state + growth_habit + (1+factor(year_factor)|plot), kbs_flwr_spp, REML=FALSE)
mod11a <- lmer(log(flwr_duration_scaled) ~ state + growth_habit + factor(year_factor) + (1|plot), kbs_flwr_spp, REML=FALSE)
mod12 <- lmer(log(flwr_duration_scaled) ~ state * factor(year_factor) + (1+factor(year_factor)|species), kbs_flwr_spp, REML=FALSE)
# mod13 <- lmer(log(flwr_duration_scaled) ~ state * factor(year_factor) + (1|species), kbs_flwr_spp, REML=FALSE)
AICctab(mod1, mod2, mod3, mod5, mod7, mod7a, mod7b, mod7c, mod8, mod9, mod9a, mod10, mod11, mod11a, mod12, mod13, weights=T) # mod7a is the best fitting model (took out mod12 bc it wouldn't run)
# not sure why the above code wont work - all the data looks identical to me despite what error says??
summary(mod7a)
anova(mod7a)
```

# KBS Plot-level Mixed Effects Models:
```{r, error=TRUE}
mod1p <- lmer(flwr_duration_scaled ~ state + (1|plot), kbs_flwr_plot, REML=FALSE)
mod2p <- lmer(flwr_duration_scaled ~ insecticide + (1|plot), kbs_flwr_plot, REML=FALSE)
mod3p <- lmer(flwr_duration_scaled ~ insecticide + state + (1|plot), kbs_flwr_plot, REML=FALSE)
mod4p <- lmer(flwr_duration_scaled ~ insecticide * state + (1|plot), kbs_flwr_plot, REML=FALSE)
mod5p <- lmer(flwr_duration_scaled ~ state + year_factor + (1|plot), kbs_flwr_plot, REML=FALSE)
mod6p <- lmer(flwr_duration_scaled ~ state + year_factor + insecticide + (1|plot), kbs_flwr_plot, REML=FALSE)
mod7p <- lmer(flwr_duration_scaled ~ state * year_factor + (1|plot), kbs_flwr_plot, REML=FALSE)
mod8p <- lmer(flwr_duration_scaled ~ state * year_factor + insecticide + (1|plot), kbs_flwr_plot, REML=FALSE)
mod9p <- lmer(flwr_duration_scaled ~ state * insecticide + year_factor + (1|plot), kbs_flwr_plot, REML=FALSE)
mod10p <- lmer(flwr_duration_scaled ~ state + insecticide * year_factor + (1|plot), kbs_flwr_plot, REML=FALSE)
mod11p <- lmer(flwr_duration_scaled ~ state * year_factor * insecticide + (1|plot), kbs_flwr_plot, REML=FALSE)
AICctab(mod1p, mod2p, mod3p, mod4p, mod5p, mod6p, mod7p, mod8p, mod9p, mod10p, mod11p, weights=T) # model 5p and 7p are the top models
anova(mod1p, mod2p) # go with 1p
AICctab(mod1p, mod2p, weights=T)
summ(mod1p)
summary(mod1p)
emmeans(mod1p, list(pairwise ~ state), adjust = "tukey")

# including native vs. exotic
kbs_flwr_plot_origin <- within(kbs_flwr_plot_origin, origin <- relevel(factor(origin), ref = "Native")) # releveling so native is the reference
mod12p <- lmer(log(flwr_duration_scaled) ~ state * origin + (1+year_factor|plot), kbs_flwr_plot_origin, REML=FALSE)
mod13p <- lmer(log(flwr_duration_scaled) ~ state + origin + (1+year_factor|plot), kbs_flwr_plot_origin, REML=FALSE)
mod14p <- lmer(log(flwr_duration_scaled) ~ state + origin + year_factor + (1|plot), kbs_flwr_plot_origin, REML=FALSE)
anova(mod12p, mod13p) # go with model 13p
anova(mod13p, mod14p) 
AICctab(mod12p, mod13p, mod14p, weights=T) #model 13p
summary(mod13p)
summ(mod13p)
anova(mod13p)
emmeans(mod13p, list(pairwise ~ state), adjust = "tukey")
emmeans(mod13p, list(pairwise ~ origin), adjust = "tukey")

# including growth form - first with interaction term
kbs_flwr_plot_growthhabit <- within(kbs_flwr_plot_growthhabit, growth_habit <- relevel(factor(growth_habit), ref = "Forb")) # releveling so forb is the reference
mod15p <- lmer(log(flwr_duration_scaled) ~ state * growth_habit + (1+year_factor|plot), kbs_flwr_plot_growthhabit, REML=FALSE)
mod16p <- lmer(log(flwr_duration_scaled) ~ state + growth_habit + (1+year_factor|plot), kbs_flwr_plot_growthhabit, REML=FALSE)
mod17p <- lmer(log(flwr_duration_scaled) ~ state + growth_habit + year_factor + (1|plot), kbs_flwr_plot_growthhabit, REML=FALSE)
anova(mod15p, mod16p) # go with model 16p
anova(mod16p, mod17p) # mod 17p
AICctab(mod15p, mod16p, mod17p, weights=T)
summary(mod17p)
summ(mod17p)
anova(mod17p)
emmeans(mod17p, list(pairwise ~ state + growth_habit), adjust = "tukey")
emmeans(mod17p, list(pairwise ~ growth_habit), adjust = "tukey")
emmeans(mod17p, list(pairwise ~ growth_habit + year_factor), adjust = "tukey")
```

UMBS
```{r}
# UMBS SPECIES LEVEL - Looking at DURATION of flowering
mod1u <- lmer(log(flwr_duration_scaled) ~ state*year_factor + insecticide*year_factor + (1|species) + (1|plot), umbs_flwr_spp, REML = FALSE)
ggplot(umbs_flwr_spp,aes(x=plot,y=flwr_duration_scaled,col=species)) + geom_jitter() + geom_boxplot(alpha=0.2) + facet_wrap(~plot)

# Check Assumptions:
# (1) Linearity: if covariates are not categorical (year isn't)
# (2) Homogeneity: Need to Check by plotting residuals vs predicted values.
par(mfrow=c(1,2))
plot(mod1u) # the zeros in the data are making this look weird
# Homogeneity of variance is ok here (increasing variance in resids is not increasing with fitted values)
# Check for homogeneity of variances (true if p>0.05). If the result is not significant, the assumption of equal variances (homoscedasticity) is met (no significant difference between the group variances).
# *****Levene’s Test - tests whether or not the variance among two or more groups is equal - If the p-value is less than our chosen significance level, we can reject the null hypothesis and conclude that we have enough evidence to state that the variance among the groups is not equal (which we want).

leveneTest(residuals(mod1u) ~ umbs_flwr_spp$state)
# Assumption not met
leveneTest(residuals(mod1u) ~ umbs_flwr_spp$species)
# Assumption met
leveneTest(residuals(mod1u) ~ umbs_flwr_spp$insecticide) 
# Assumption not met 
leveneTest(residuals(mod1u) ~ umbs_flwr_spp$plot)
# Assumption not met

# (3) Normality of error term: need to check by histogram, QQplot of residuals, could do Kolmogorov-Smirnov test.
# Check for normal residuals
qqPlot(resid(mod1u))
hist(residuals(mod1u))
shapiro.test(resid(mod1u)) # not normally distributed resids bc p<0.05
outlierTest(mod1u) # outliers

# (4) Normality of random effect: Get the estimate of random effect (e.g., random intercepts), and check them as you would check the residual. 
require(lme4)
r_int <- ranef(mod1u)$plot$`(Intercept)`
qqnorm(r_int)
# qqline(r_int) doesn't work
# shapiro.test(r_int)  # this doesnt work
```

```{r, error=TRUE}
# Do we need to include plot as a random effect with the KBS models?   
mod1u <- lmer(log(flwr_duration_scaled) ~ state*year_factor + insecticide*year_factor + (1|species) + (1|plot), umbs_flwr_spp, REML = FALSE)
mod2u <- lmer(log(flwr_duration_scaled) ~ state*year_factor + insecticide*year_factor + (1|species), umbs_flwr_spp, REML=FALSE)
# Run analysis of variance on each model (see this for more explanation on how anova on a linear mixed effects model is similar to an anove on a regular linear model: https://m-clark.github.io/docs/mixedModels/anovamixed.html)
anova(mod1u)
anova(mod2u)

anova(mod1u, mod2u) # Go with model 2 since pvalue >0.05, aka more complex model does not have something in it that matters (the two models are essentially the same so go w model with fewer parameters)
summ(mod1u) 
summ(mod2u)
AICctab(mod1u, mod2u, weights=T)

# Plot the fixed effects estimates for different models
# these are the fixed effects estimates from summary(mod1)
plot_model(mod2u, sort.est = TRUE)
# these are the fixed predicted values:
plot_model(mod2u, type = "pred", terms = c("year_factor", "state", "insecticide"))
# these are the random effects estimates
plot_model(mod2u, type = "re", terms = c("species"))

# Do we need to include insecticide? (dropping insecticide from the model)
# mod2 <- lmer(log(relabun) ~ state*year_factor + insecticide*year_factor + (1|species), comp_kbs_spp, REML=FALSE)
mod3u <- lmer(log(flwr_duration_scaled) ~ state*year_factor + (1|species), umbs_flwr_spp, REML=FALSE)
anova(mod2u, mod3u)

AICctab(mod2u, mod3u, weights=T) # go with model 3u
# Looks like no, pvalue > 0.05, so insecticide does not improve model fit so we will go with mod 3

# Does year need to be interactive with insecticide? - already removed insecticide
# mod4 <- lmer(log(julian_median) ~ state*year_factor + insecticide + (1|species) + (1|plot), umbs_flwr_spp, REML=FALSE)

# Does year need to be interactive with state?
mod5u <- lmer(log(flwr_duration_scaled) ~ state + year_factor + (1|species), umbs_flwr_spp, REML=FALSE)
anova(mod3u, mod5u)
# No, P>0.05 so state*year_factor doesn't strongly improve model fit so we will shift to mod5, but AIC values are super close!!

# Plot the fixed effects estimates for different models
# these are the fixed effects estimates from summary(mod5)
plot_model(mod5u, sort.est = TRUE)
# these are the fixed predicted values:
plot_model(mod5u, type = "pred", terms = c("year_factor", "state"))
# these are the random effects estimates
plot_model(mod5u, type = "re", terms = c("species"))

# If we wanted to include plots nested within year it would look like this:
mod6u <- lmer(log(flwr_duration_scaled) ~ state + year_factor + (1|species) + (1 + year_factor|plot), umbs_flwr_spp, REML=FALSE)
# Model failed to converge with 1 negative eigenvalue: -1.9e+00
anova(mod5u, mod6u)
anova(mod5u)

# mod4 (and mod5) are pretty complex in terms of interpretation (they actually don't have many parameters though). We could consider an alternative model that's simpler to understand and also one that provides more insight about the species. That would be something like this:
mod7u <- lmer(log(flwr_duration_scaled) ~ state + species + (1+factor(year_factor)|plot), umbs_flwr_spp, REML=FALSE)
mod7au <- lmer(log(flwr_duration_scaled)  ~ state + species + factor(year_factor) + (1|plot), umbs_flwr_spp, REML=FALSE)
mod7bu <- lmer(log(flwr_duration_scaled)  ~ state * factor(year_factor) + species + (1|plot), umbs_flwr_spp, REML=FALSE)
mod7cu <- lmer(log(flwr_duration_scaled)  ~ state + species + factor(year_factor) + insecticide + (1|plot), umbs_flwr_spp, REML=FALSE)
anova(mod5u, mod7u) # model 7 is a better fit to data
anova(mod7u, mod7au) #mod 7a
anova(mod7au, mod7bu) #mod 7a - interaction between state and year does not improve model go with simpler model (mod7a)
anova(mod7au, mod7cu) #models are not different than one another, go with simpler model = mod7a
summary(mod7au)
anova(mod7au) # investigates whether at least one of the levels within each factor is significantly different.
# Yes, at least one of the species is different (they do not all have the same relative abundances). 
emmeans(mod7au, list(pairwise ~ state + year_factor), adjust = "tukey")
emmeans(mod7au, list(pairwise ~ year_factor), adjust = "tukey")
emmeans(mod7au, list(pairwise ~ species), adjust = "tukey")

# Take a look at the estimates for each fixed effect. These are the estimates from summary(mod7a). You'll see that species vary a lot - and many of them are different from zero (meaning their half cover date is significantly different from zero).
plot_model(mod7au, sort.est = TRUE)
# if you want to standardize the estimates:
plot_model(mod7au, sort.est = TRUE, type="std") 
# these are the fixed predicted values: - note this is a new plot
plot_model(mod7au, type = "pred", terms = c("species", "state", "year_factor"))
# these are the random effects estimates
plot_model(mod7au, type = "re")

# including native vs. exotic
umbs_flwr_spp <- within(umbs_flwr_spp, origin <- relevel(factor(origin), ref = "Native")) # releveling so native is the reference
mod8u <- lmer(log(flwr_duration_scaled) ~ state * origin + (1+factor(year_factor)|plot), umbs_flwr_spp, REML=FALSE)
mod9u <- lmer(log(flwr_duration_scaled) ~ state + origin + (1+factor(year_factor)|plot), umbs_flwr_spp, REML=FALSE)
mod9au <- lmer(log(flwr_duration_scaled) ~ state + origin + factor(year_factor) + (1|plot), umbs_flwr_spp, REML=FALSE)
anova(mod8u, mod9u) # model 9 is a better fit to data
anova(mod9u, mod9au) # mod 9a
summary(mod9au)
anova(mod9au)
emmeans(mod9au, list(pairwise ~ state + origin), adjust = "tukey")
emmeans(mod9au, list(pairwise ~ origin), adjust = "tukey")
emmeans(mod9au, list(pairwise ~ factor(year_factor)), adjust = "tukey")

# including growth form - first with interaction term
umbs_flwr_spp <- within(umbs_flwr_spp, growth_habit <- relevel(factor(growth_habit), ref = "Forb")) # releveling so forb is the reference
mod10u <- lmer(log(flwr_duration_scaled) ~ state * growth_habit + (1+factor(year_factor)|plot), umbs_flwr_spp, REML=FALSE)
mod11u <- lmer(log(flwr_duration_scaled) ~ state + growth_habit + (1+factor(year_factor)|plot), umbs_flwr_spp, REML=FALSE)
mod11au <- lmer(log(flwr_duration_scaled) ~ state + growth_habit + factor(year_factor) + (1|plot), umbs_flwr_spp, REML=FALSE)
anova(mod10u, mod11u) # model 11 is a better fit to data
anova(mod11u, mod11au) # model 11a 
summary(mod11au)
anova(mod11au)
emmeans(mod11au, list(pairwise ~ factor(year_factor)), adjust = "tukey")
emmeans(mod11au, list(pairwise ~ growth_habit), adjust = "tukey")
emmeans(mod11au, list(pairwise ~ state + growth_habit), adjust = "tukey")

# New version of our model incorporating interaction term and species within year so that there is a separate intercept and slope for each species. The issue here is that there are some species that are not found each year. Easiest to remove those from another version of this dataframe before running below. Otherwise, it's not a balanced design.
# updated mod4
mod12u <- lmer(log(flwr_duration_scaled) ~ state * factor(year_factor) + (1+factor(year_factor)|species), umbs_flwr_spp)

# So another version of this model would include the interaction but not include the nesting (and thus would assume that species aren't observed ea yr)
# updated mod5
mod13u <- lmer(log(flwr_duration_scaled) ~ state * factor(year_factor) + (1|species), umbs_flwr_spp)

# All the models ran:
mod1u <- lmer(log(flwr_duration_scaled) ~ state*year_factor + insecticide*year_factor + (1|species) + (1|plot), umbs_flwr_spp, REML=FALSE)
mod2u <- lmer(log(flwr_duration_scaled) ~ state*year_factor + insecticide*year_factor + (1|species), umbs_flwr_spp, REML=FALSE)
mod3u <- lmer(log(flwr_duration_scaled) ~ state*year_factor + (1|species), umbs_flwr_spp, REML=FALSE)
mod4u <- lmer(log(flwr_duration_scaled) ~ state*year_factor + insecticide + (1|species) + (1|plot), umbs_flwr_spp, REML=FALSE)
mod5u <- lmer(log(flwr_duration_scaled) ~ state + year_factor + (1|species), umbs_flwr_spp, REML=FALSE)
mod6u <- lmer(log(flwr_duration_scaled) ~ state + year_factor + (1|species) + (1 + year|plot), umbs_flwr_spp, REML=FALSE)
mod7u <- lmer(log(flwr_duration_scaled) ~ state + species + (1+factor(year_factor)|plot), umbs_flwr_spp, REML=FALSE)
mod7au <- lmer(log(flwr_duration_scaled) ~ state + species + factor(year_factor) + (1|plot), umbs_flwr_spp, REML=FALSE)
mod7bu <- lmer(log(flwr_duration_scaled) ~ state * factor(year_factor) + species + (1|plot), umbs_flwr_spp, REML=FALSE)
mod7cu <- lmer(log(flwr_duration_scaled) ~ state + species + factor(year_factor) + insecticide + (1|plot), umbs_flwr_spp, REML=FALSE)
mod8u <- lmer(log(flwr_duration_scaled) ~ state * origin + (1+factor(year_factor)|plot), umbs_flwr_spp, REML=FALSE)
mod9u <- lmer(log(flwr_duration_scaled) ~ state + origin + (1+factor(year_factor)|plot), umbs_flwr_spp, REML=FALSE)
mod9au <- lmer(log(flwr_duration_scaled) ~ state + origin + factor(year_factor) + (1|plot), umbs_flwr_spp, REML=FALSE)
mod10u <- lmer(log(flwr_duration_scaled) ~ state * growth_habit + (1+factor(year_factor)|plot), umbs_flwr_spp, REML=FALSE)
mod11u <- lmer(log(flwr_duration_scaled) ~ state + growth_habit + (1+factor(year_factor)|plot), umbs_flwr_spp, REML=FALSE)
mod11au <- lmer(log(flwr_duration_scaled) ~ state + growth_habit + factor(year_factor) + (1|plot), umbs_flwr_spp, REML=FALSE)
mod12u <- lmer(log(flwr_duration_scaled) ~ state * factor(year_factor) + (1+factor(year_factor)|species), umbs_flwr_spp, REML=FALSE)
mod13u <- lmer(log(flwr_duration_scaled) ~ state * factor(year_factor) + (1|species), umbs_flwr_spp, REML=FALSE)
AICctab(mod1u, mod2u, mod3u, mod5u, mod6u, mod7u, mod7au, mod7bu, mod7cu, mod8u, mod9u, mod9au, mod10u, mod11u, mod11au, mod12u, mod13u, weights=T) # mod7a is the best fitting model (took out mod12 bc it wouldn't run)
AICctab(mod12u, mod7au, weights=T)
summary(mod12u)
anova(mod12u)

```

# UMBS Plot-level Mixed Effects Models:
```{r}
mod1up <- lmer(flwr_duration_scaled ~ state + (1|plot), umbs_flwr_plot, REML=FALSE)
mod2up <- lmer(flwr_duration_scaled ~ insecticide + (1|plot), umbs_flwr_plot, REML=FALSE)
mod3up <- lmer(flwr_duration_scaled ~ insecticide + state + (1|plot), umbs_flwr_plot, REML=FALSE)
mod4up <- lmer(flwr_duration_scaled ~ insecticide * state + (1|plot), umbs_flwr_plot, REML=FALSE)
mod5up <- lmer(flwr_duration_scaled ~ state + year_factor + (1|plot), umbs_flwr_plot, REML=FALSE)
mod6up <- lmer(flwr_duration_scaled ~ state + year_factor + insecticide + (1|plot), umbs_flwr_plot, REML=FALSE)
mod7up <- lmer(flwr_duration_scaled ~ state * year_factor + (1|plot), umbs_flwr_plot, REML=FALSE)
mod8up <- lmer(flwr_duration_scaled ~ state * year_factor + insecticide + (1|plot), umbs_flwr_plot, REML=FALSE)
mod9up <- lmer(flwr_duration_scaled ~ state * insecticide + year_factor + (1|plot), umbs_flwr_plot, REML=FALSE)
mod10up <- lmer(flwr_duration_scaled ~ state + insecticide * year_factor + (1|plot), umbs_flwr_plot, REML=FALSE)
mod11up <- lmer(flwr_duration_scaled ~ state * year_factor * insecticide + (1|plot), umbs_flwr_plot, REML=FALSE)
AICctab(mod1up, mod2up, mod3up, mod4up, mod5up, mod6up, mod7up, mod8up, mod9up, mod10up, mod11up, weights=T)
anova(mod1up, mod2up) # go with simpler model 1up
AICctab(mod1up, mod2up, weights=T)
summ(mod1up)
summary(mod1up)
emmeans(mod1up, list(pairwise ~ state), adjust = "tukey")

# including native vs. exotic
umbs_flwr_plot_origin <- within(umbs_flwr_plot_origin, origin <- relevel(factor(origin), ref = "Native")) # releveling so native is the reference
mod12up <- lmer(log(flwr_duration_scaled) ~ state * origin + (1+year_factor|plot), umbs_flwr_plot_origin, REML=FALSE)
mod13up <- lmer(log(flwr_duration_scaled) ~ state + origin + (1+year_factor|plot), umbs_flwr_plot_origin, REML=FALSE)
mod14up <- lmer(log(flwr_duration_scaled) ~ state + origin + year_factor + (1|plot), umbs_flwr_plot_origin, REML=FALSE)
anova(mod12up, mod13up) # go with model 13p
anova(mod13up, mod14up) 
AICctab(mod12up, mod13up, mod14up, weights=T) #model 13p
summary(mod14up)
summ(mod14up)
anova(mod14up)
emmeans(mod14up, list(pairwise ~ state), adjust = "tukey")
emmeans(mod14up, list(pairwise ~ origin), adjust = "tukey")

# including growth form - first with interaction term
umbs_flwr_plot_growthhabit <- within(umbs_flwr_plot_growthhabit, growth_habit <- relevel(factor(growth_habit), ref = "Forb")) # releveling so forb is the reference
mod15up <- lmer(log(flwr_duration_scaled) ~ state * growth_habit + (1+year_factor|plot), umbs_flwr_plot_growthhabit, REML=FALSE)
mod16up <- lmer(log(flwr_duration_scaled) ~ state + growth_habit + (1+year_factor|plot), umbs_flwr_plot_growthhabit, REML=FALSE)
mod17up <- lmer(log(flwr_duration_scaled) ~ state + growth_habit + year_factor + (1|plot), umbs_flwr_plot_growthhabit, REML=FALSE)
anova(mod15up, mod16up) # go with model 16p
anova(mod16up, mod17up) # mod 17p
AICctab(mod15up, mod16up, mod17up, weights=T)
summary(mod17up)
summ(mod17up)
anova(mod17up)
emmeans(mod17up, list(pairwise ~ state + growth_habit), adjust = "tukey")
emmeans(mod17up, list(pairwise ~ growth_habit), adjust = "tukey")
emmeans(mod17up, list(pairwise ~ growth_habit + year_factor), adjust = "tukey")
```




---
title: "Greenup Plots"
author: "Kara Dobson"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

COLLABORATORS: Phoebe Zarnetske, Mark Hammond, Pat Bills, Moriah Young  
DATA INPUT: Plot and species level greenup files from warmX Google drive  
DATA OUTPUT: Plots of greenup at KBS and UMBS - Rmd and PDF located in Github folder
PROJECT: warmXtrophic  


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Clear all existing data
rm(list=ls())

# Load packages
library(plotrix)
library(tidyverse)
library(ggpubr)
library(hrbrthemes)

# Set working directory
#Sys.getenv("L1DIR")
L1_dir<-Sys.getenv("L1DIR")
L2_dir<-Sys.getenv("L2DIR")
#list.files(L1_dir)

# Read in data
gr_plot <- read.csv(file.path(L2_dir, "greenup/final_greenup_plot_L2.csv"))
# plot-level green-up V2 (below) takes the median half cover date of all species per plot
# whereas the first plot-level file finds the overall half cover date for the entire plot, regardless of species
gr_plot_v2 <- read.csv(file.path(L2_dir, "greenup/final_greenup_plot_V2_L2.csv"))
gr_species <- read.csv(file.path(L2_dir, "greenup/final_greenup_species_L2.csv"))
gr_growth <- read.csv(file.path(L2_dir, "greenup/final_greenup_growthhabit_L2.csv"))
gr_origin <- read.csv(file.path(L2_dir, "greenup/final_greenup_origin_L2.csv"))

flwr_spp <- read.csv(file.path(L2_dir, "phenology/final_flwr_species_L2.csv"))
flwr_plot <- read.csv(file.path(L2_dir, "phenology/final_flwr_plot_L2.csv"))
sd_spp <- read.csv(file.path(L2_dir, "phenology/final_sd_species_L2.csv"))
sd_plot <- read.csv(file.path(L2_dir, "phenology/final_sd_plot_L2.csv"))

# read in GDD and temp data
GDD_KBS <- read.csv(file.path(L1_dir, "HOBO_data/KBS_GDD_L1.csv"))
temps_KBS <- read.csv(file.path(L1_dir, "HOBO_data/KBS_greenup_temps_L1.csv"))
GDD_UMBS <- read.csv(file.path(L1_dir, "HOBO_data/UMBS_GDD_L1.csv"))
temps_UMBS <- read.csv(file.path(L1_dir, "HOBO_data/UMBS_greenup_temps_L1.csv"))

# making site names capital for cleaner plots
change_site <- function(df){
  df$site[df$site == "umbs"] <- "UMBS"
  df$site[df$site == "kbs"] <- "KBS"
  return(df)
}
gr_plot <- change_site(gr_plot)
gr_plot_v2 <- change_site(gr_plot_v2)
sd_plot <- change_site(sd_plot)
flwr_plot <- change_site(flwr_plot)
gr_species <- change_site(gr_species)

# creating a vector with cleaned up insecticide labels for plotting
insect_labels <- c("insects" = "Herbivory", "no_insects" = "Reduced Herbivory")

# note: figures for GDD and temp comparisons are at the end of the script

# filter data to contain the averages and std error for each site & species
sum_green_spp <- gr_species %>%
  group_by(site, state, species) %>%
  summarize(avg_julian = mean(spp_half_cover_date, na.rm = TRUE),
            se = std.error(spp_half_cover_date, na.rm = TRUE))

# averages + std error for plot level data
sum_green_plot <- gr_plot %>%
  group_by(site, state, year) %>%
  summarize(avg_julian = mean(plot_half_cover_date, na.rm = TRUE),
            se = std.error(plot_half_cover_date, na.rm = TRUE))
sum_green_plot_v2 <- gr_plot_v2 %>%
  group_by(site, state, year) %>%
  summarize(avg_julian = mean(med_half_cover_date, na.rm = TRUE),
            se = std.error(med_half_cover_date, na.rm = TRUE))
sum_flwr_plot <- flwr_plot %>%
  group_by(site, state, year) %>%
  summarize(avg_julian = mean(julian_median, na.rm = TRUE),
            se = std.error(julian_median, na.rm = TRUE))
sum_sd_plot <- sd_plot %>%
  group_by(site, state, year) %>%
  summarize(avg_julian = mean(julian_min, na.rm = TRUE),
            se = std.error(julian_min, na.rm = TRUE))

# averages + std error for plot level data + insecticide treatment
sum_green_plot_i <- gr_plot %>%
  group_by(site, state, insecticide, year) %>%
  summarize(avg_julian = mean(plot_half_cover_date, na.rm = TRUE),
            se = std.error(plot_half_cover_date, na.rm = TRUE))
sum_green_plot_i_v2 <- gr_plot_v2 %>%
  group_by(site, state, insecticide, year) %>%
  summarize(avg_julian = mean(med_half_cover_date, na.rm = TRUE),
            se = std.error(med_half_cover_date, na.rm = TRUE))
sum_flwr_plot_i <- flwr_plot %>%
  group_by(site, state, insecticide, year) %>%
  summarize(avg_julian = mean(julian_median, na.rm = TRUE),
            se = std.error(julian_median, na.rm = TRUE))
sum_sd_plot_i <- sd_plot %>%
  group_by(site, state, insecticide, year) %>%
  summarize(avg_julian = mean(julian_min, na.rm = TRUE),
            se = std.error(julian_min, na.rm = TRUE))

# filter data to contain the averages and std error for each site - half cover
sum_green_site <- gr_species %>%
  group_by(site, state, year) %>%
  summarize(avg_julian = mean(spp_half_cover_date, na.rm = TRUE),
            se = std.error(spp_half_cover_date, na.rm = TRUE))

# filter data to contain the averages and std error for each site - minimum greenup date
sum_green_site_min <- gr_species %>%
  group_by(site, state, year) %>%
  summarize(avg_julian = mean(min_green_date, na.rm = TRUE),
            se = std.error(min_green_date, na.rm = TRUE))

# by plant origin (native/exotic)
sum_green_org <- gr_species %>%
  group_by(site, origin, state) %>%
  summarize(avg_julian = mean(spp_half_cover_date, na.rm = TRUE),
            se = std.error(spp_half_cover_date, na.rm = TRUE))
sum_green_org <- subset(sum_green_org, origin == "Exotic" | origin == "Native")

# by plant growth type (forb, graminoid, shrub)
sum_green_habit <- gr_species %>%
  group_by(site, growth_habit, state) %>%
  summarize(avg_julian = mean(spp_half_cover_date, na.rm = TRUE),
            se = std.error(spp_half_cover_date, na.rm = TRUE))
sum_green_habit <- subset(sum_green_habit, growth_habit == "Forb" | growth_habit == "Graminoid" | growth_habit == "Shrub")

# trying to add empty values for 2015 to kbs greenup so the x-axis matches the other plots
gr_plot2 <- gr_plot
de<-data.frame(NA,"KBS",NA,"2015",NA,"ambient","insects",NA,NA)
names(de)<-c("X","site","plot","year","treatment_key","state","insecticide","plot_half_cover_date","min_green_date")
gr_plot3 <- rbind(gr_plot2, de)
sum_green_plot2 <- gr_plot3 %>%
  group_by(site, year, state) %>%
  summarize(avg_julian = mean(plot_half_cover_date, na.rm = TRUE),
            se = std.error(plot_half_cover_date, na.rm = TRUE))
sum_green_plot_i2 <- gr_plot3 %>%
  group_by(site, state, insecticide, year) %>%
  summarize(avg_julian = mean(plot_half_cover_date, na.rm = TRUE),
            se = std.error(plot_half_cover_date, na.rm = TRUE))

gr_plot_v2.2 <- gr_plot_v2
de2<-data.frame(NA,"KBS",NA,"2015","ambient","insects",NA)
names(de2)<-c("X","site","plot","year","state","insecticide","med_half_cover_date")
gr_plot_v2.3 <- rbind(gr_plot_v2.2, de2)
sum_green_plot2_v2 <- gr_plot_v2.3 %>%
  group_by(site, year, state) %>%
  summarize(avg_julian = mean(med_half_cover_date, na.rm = TRUE),
            se = std.error(med_half_cover_date, na.rm = TRUE))
sum_green_plot_i2_v2 <- gr_plot_v2.3 %>%
  group_by(site, state, insecticide, year) %>%
  summarize(avg_julian = mean(med_half_cover_date, na.rm = TRUE),
            se = std.error(med_half_cover_date, na.rm = TRUE))
```

## Bar plot for greenup for KBS and UMBS - Species half cover date
```{r, echo = F}
greenup_plot_all <- function(loc) { 
  greenup_spp <- subset(sum_green_site, site == loc)
  return(ggplot(greenup_spp, aes(x = state, y = avg_julian, fill = state)) +
           facet_grid(.~year) +
           geom_bar(position = "identity", stat = "identity", color = "black") +
           geom_errorbar(aes(ymin = avg_julian - se, ymax = avg_julian + se), width = 0.2,
                         position = "identity") +
           labs(x = "State", y = "Julian Day of Greenup", title = loc) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
           coord_cartesian(ylim = c(100, 200)) +
           theme_classic())
}
greenup_plot_all("kbs")
greenup_plot_all("umbs")
```

## Box plot for greenup for KBS and UMBS - Species half cover date
```{r, echo = F}
gr_species$year <- as.character(gr_species$year)
greenup_plot_box <- function(loc) { 
  greenup_spp <- subset(gr_species, site == loc)
  return(ggplot(greenup_spp, aes(x = year, y = spp_half_cover_date, fill = state)) +
                 facet_grid(.~insecticide) +
                 geom_boxplot(color = "black") +
                 labs(x = NULL, y = NULL, title = loc) +
                 scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
                 scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
                 theme_classic())
}
spp_kbs <- greenup_plot_box("kbs")
spp_umbs <- greenup_plot_box("umbs")

spp_level <- ggarrange(spp_kbs, spp_umbs, nrow = 2, common.legend = T, legend="right")
#png("greenup_plots_L2_spp_greenup.png", units="in", width=8, height=8, res=300)
annotate_figure(spp_level,
                left = text_grob("Julian date of species-level green-up", color = "black", rot = 90),
                bottom = text_grob("Year", color = "black"))
#dev.off()
```

## Box plot for greenup for KBS and UMBS - Plot half cover date
```{r, echo = F}
gr_plot$year <- as.character(gr_plot$year)
greenup_plot_boxp <- function(loc) { 
  greenup_plot <- subset(gr_plot, site == loc)
  return(ggplot(greenup_plot, aes(x = year, y = plot_half_cover_date, fill = state)) +
           facet_grid(.~insecticide) +
           geom_boxplot(color = "black") +
           labs(x = NULL, y = NULL, title = loc) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
           theme_classic())
}
plot_kbs <- greenup_plot_boxp("KBS")
plot_umbs <- greenup_plot_boxp("UMBS")

plot_level <- ggarrange(plot_kbs, plot_umbs, nrow = 2, common.legend = T, legend="right")
#png("greenup_plots_L2_plot_greenup.png", units="in", width=8, height=8, res=300)
annotate_figure(plot_level,
                left = text_grob("Julian date of plot-level green-up", color = "black", rot = 90),
                bottom = text_grob("Year", color = "black"))
#dev.off()
```

## Averaging greenup over all years - plot level
```{r, echo=F}
greenup_overall_plot <- function(loc) { 
  greenup_plot <- subset(gr_plot, site == loc)
  return(ggplot(greenup_plot, aes(x = state, y = plot_half_cover_date, fill = state)) +
           facet_grid(.~insecticide, labeller = as_labeller(insect_labels)) +
           geom_boxplot() +
           labs(x = NULL, y = NULL, title = loc, fill="Treatment") +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = "Ambient", "warmed" = "Warmed")) +
           theme_classic()) +
          theme(text = element_text(family="AvantGarde")) # doesn't work
}
plot_overall_kbs <- greenup_overall_plot("KBS")
plot_overall_umbs <- greenup_overall_plot("UMBS")

plot_level_overall <- ggarrange(plot_overall_kbs, plot_overall_umbs, nrow = 2, legend="none")
#png("greenup_plots_L2_plot_greenup_overall.png", units="in", width=8, height=8, res=300)
annotate_figure(plot_level_overall,
                left = text_grob("Julian date of plot-level green-up", color = "black", rot = 90),
                bottom = text_grob("Treatment", color = "black"))
#dev.off()
```

## Averaging greenup over all years - species level
```{r, echo=F}
greenup_overall_spp <- function(loc) { 
  greenup_spp <- subset(gr_species, site == loc)
  return(ggplot(greenup_spp, aes(x = state, y = spp_half_cover_date)) +
           facet_grid(.~insecticide) +
           geom_boxplot(color = "black") +
           labs(x = NULL, y = NULL, title = loc) +
           #scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           #scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
           theme_classic())
}
spp_overall_kbs <- greenup_overall_spp("kbs")
spp_overall_umbs <- greenup_overall_spp("umbs")

spp_level_overall <- ggarrange(spp_overall_kbs, spp_overall_umbs, nrow = 2, common.legend = T, legend="right")
#png("greenup_plots_L2_spp_greenup_overall.png", units="in", width=8, height=8, res=300)
annotate_figure(spp_level_overall,
                left = text_grob("Julian date of species-level green-up", color = "black", rot = 90),
                bottom = text_grob("Year", color = "black"))
#dev.off()
```

## Combining greenup, flower, and seed into one figure - plot level
```{r, echo=F}
# green-up plots
greenup_overall_plot2 <- function(loc) { 
  greenup_plot <- subset(gr_plot, site == loc)
  return(ggplot(greenup_plot, aes(x = state, y = plot_half_cover_date, fill=state)) +
           facet_grid(.~insecticide, labeller = as_labeller(insect_labels)) +
           geom_boxplot(outlier.shape=NA, alpha=0.7) +
           geom_jitter(aes(alpha=0.8, color=state, fill=state), shape=16, size=2) +
           labs(x = NULL, y = "Green-up median julian date", title = loc) +
           scale_color_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = "Ambient", "warmed" = "Warmed")) +
           theme_classic()) +
          theme(text = element_text(family="AvantGarde")) # doesn't work
}
plot_overall_kbs2 <- greenup_overall_plot2("KBS")
plot_overall_kbs2 <- plot_overall_kbs2 + theme(axis.text.x=element_blank())
plot_overall_umbs2 <- greenup_overall_plot2("UMBS")
plot_overall_umbs2 <- plot_overall_umbs2 + labs(y=NULL) + theme(axis.text.x=element_blank())

# flower plots
flwr_overall_plot <- function(loc) { 
  flower_plot <- subset(flwr_plot, site == loc)
  return(ggplot(flower_plot, aes(x = state, y = julian_median, fill=state)) +
           facet_grid(.~insecticide, labeller = as_labeller(insect_labels)) +
           geom_boxplot(outlier.shape=NA, alpha=0.7) +
           geom_jitter(aes(alpha=0.8, color=state, fill=state), shape=16, size=2) +
           labs(x = NULL, y = "Flower median julian date") +
           scale_color_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = "Ambient", "warmed" = "Warmed")) +
           theme_classic()) +
          theme(text = element_text(family="AvantGarde")) # doesn't work
}
flwr_overall_kbs <- flwr_overall_plot("KBS")
flwr_overall_kbs <- flwr_overall_kbs + theme(axis.text.x=element_blank())
flwr_overall_umbs <- flwr_overall_plot("UMBS")
flwr_overall_umbs <- flwr_overall_umbs + labs(y=NULL) + theme(axis.text.x=element_blank())

# flower duration plots - not including this in final plot for now since idk if its in our analyses
flwr_dur_plot <- function(loc) { 
  flower_plot <- subset(flwr_plot, site == loc)
  return(ggplot(flower_plot, aes(x = state, y = flwr_duration, fill=state)) +
           facet_grid(.~insecticide, labeller = as_labeller(insect_labels)) +
           geom_boxplot(color = "black") +
           labs(x = NULL, y = "Flower duration") +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = "Ambient", "warmed" = "Warmed")) +
           theme_classic()) +
          theme(text = element_text(family="AvantGarde")) # doesn't work
}
flwr_dur_kbs <- flwr_dur_plot("KBS")
flwr_dur_umbs <- flwr_dur_plot("UMBS")

# seed set plots - using min date here bc can't calculate median date for seed
sd_overall_plot <- function(loc) { 
  seed_plot <- subset(sd_plot, site == loc)
  return(ggplot(seed_plot, aes(x = state, y = julian_min, fill=state)) +
           facet_grid(.~insecticide, labeller = as_labeller(insect_labels)) +
           geom_boxplot(outlier.shape=NA, alpha=0.7) +
           geom_jitter(aes(alpha=0.8, color=state, fill=state), shape=16, size=2) +
           labs(x = NULL, y = "Seed set minimum julian date") +
           scale_color_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = "Ambient", "warmed" = "Warmed")) +
           theme_classic()) +
          theme(text = element_text(family="AvantGarde")) # doesn't work
}
sd_overall_kbs <- sd_overall_plot("KBS")
sd_overall_umbs <- sd_overall_plot("UMBS")
sd_overall_umbs <- sd_overall_umbs + labs(y=NULL)

phen_overall <- ggpubr::ggarrange(plot_overall_kbs2, plot_overall_umbs2,
                          flwr_overall_kbs, flwr_overall_umbs,
                          sd_overall_kbs, sd_overall_umbs,
                          nrow = 3, ncol = 2, legend="none")
#png("greenup_plots_L2_all_phenology.png", units="in", width=8, height=8, res=300)
annotate_figure(phen_overall,
                left = text_grob("Phenological event", color = "black", rot = 90),
                bottom = text_grob("Treatment", color = "black"))
#dev.off()
```

## Combining greenup, flower, and seed into one figure - plot level
## Swapping axis
```{r, echo=F}
# green-up plots
greenup_overall_plot3 <- function(loc) { 
  greenup_plot <- subset(gr_plot, site == loc)
  return(ggplot(greenup_plot, aes(x = state, y = plot_half_cover_date, fill=state)) +
           facet_wrap(~insecticide,ncol=1) +
           geom_boxplot(color = "black") +
           labs(x = "Green-up", y = NULL, title = loc) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = NULL, "warmed" = NULL)) +
                 ylim(50,300) +
           theme_classic() +
          coord_flip())
}
plot_overall_kbs3 <- greenup_overall_plot3("KBS")
plot_overall_umbs3 <- greenup_overall_plot3("UMBS")

# flower plots
flwr_overall_plot2 <- function(loc) { 
  flower_plot <- subset(flwr_plot, site == loc)
  return(ggplot(flower_plot, aes(x = state, y = julian_median, fill=state)) +
           facet_wrap(~insecticide, ncol=1) +
           geom_boxplot(color = "black") +
           labs(x = "Flower", y = NULL) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = NULL, "warmed" = NULL)) +
                 ylim(50,300) +
          theme_classic() +
          coord_flip())
}
flwr_overall_kbs2 <- flwr_overall_plot2("KBS")
flwr_overall_umbs2 <- flwr_overall_plot2("UMBS")

# flower duration plots - not including this in final plot for now since idk if its in our analyses
flwr_dur_plot2 <- function(loc) { 
  flower_plot <- subset(flwr_plot, site == loc)
  return(ggplot(flower_plot, aes(x = state, y = flwr_duration, fill=state)) +
           facet_wrap(~insecticide, ncol=1) +
           geom_boxplot(color = "black") +
           labs(x = "Flower duration", y = NULL) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = NULL, "warmed" = NULL)) +
          theme_classic() +
          coord_flip())
}
flwr_dur_kbs2 <- flwr_dur_plot2("KBS")
flwr_dur_umbs2 <- flwr_dur_plot2("UMBS")

# seed set plots - using min date here bc can't calculate median date for seed
sd_overall_plot2 <- function(loc) { 
  seed_plot <- subset(sd_plot, site == loc)
  return(ggplot(seed_plot, aes(x = state, y = julian_min, fill=state)) +
           facet_wrap(~insecticide, ncol=1) +
           geom_boxplot(color = "black") +
           labs(x = "Seed set", y = NULL) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = NULL, "warmed" = NULL)) + 
                 ylim(50,300) +
          theme_classic() +
          coord_flip())
}
sd_overall_kbs2 <- sd_overall_plot2("KBS")
sd_overall_umbs2 <- sd_overall_plot2("UMBS")

phen_overall2 <- ggarrange(plot_overall_kbs3, plot_overall_umbs3,
                          flwr_overall_kbs2, flwr_overall_umbs2,
                          sd_overall_kbs2, sd_overall_umbs2,
                          nrow = 3, ncol = 2, common.legend = T, legend="right")
#png("greenup_plots_L2_all_phenology2.png", units="in", width=8, height=8, res=300)
annotate_figure(phen_overall2,
                left = text_grob("Phenological event", color = "black", rot = 90),
                bottom = text_grob("Julian date", color = "black"))
#dev.off()
```

## Combining greenup, flower, and seed into one figure - plot level
## Violin plot
```{r, echo=F, warning=F, message=F}
# green-up plots
greenup_violin <- function(loc) { 
  greenup_plot <- subset(gr_plot, site == loc)
  return(ggplot(greenup_plot, aes(x = state, y = plot_half_cover_date, fill=state)) +
           facet_wrap(~insecticide,ncol=1) +
           geom_violin(width=2, size=0.1) +
           labs(x = "Green-up", y = NULL, title = loc) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = NULL, "warmed" = NULL)) +
           theme_classic() +
          coord_flip())
}
green_violin_plot_k <- greenup_violin("KBS")
green_violin_plot_u <- greenup_violin("UMBS")

# flower plots
flower_violin <- function(loc) { 
  flower_plot <- subset(flwr_plot, site == loc)
  return(ggplot(flwr_plot, aes(x = state, y = julian_median, fill=state)) +
           facet_wrap(~insecticide, ncol=1) +
           geom_violin(width=2, size=0.1) +
           labs(x = "Flower", y = NULL) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = NULL, "warmed" = NULL)) +
           theme_classic() +
          coord_flip())
}
flwr_violin_plot_k <- flower_violin("KBS")
flwr_violin_plot_u <- flower_violin("UMBS")

# seed plots
seed_violin <- function(loc) { 
  seed_plot <- subset(sd_plot, site == loc)
  return(ggplot(seed_plot, aes(x = state, y = julian_min, fill=state)) +
           facet_wrap(~insecticide, ncol=1) +
           geom_violin(width=2, size=0.1) +
           labs(x = "Seed set", y = NULL) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = NULL, "warmed" = NULL)) +
           theme_classic() +
          coord_flip())
}
seed_violin_plot_k <- seed_violin("KBS")
seed_violin_plot_u <- seed_violin("UMBS")

phen_violin <- ggarrange(green_violin_plot_k, green_violin_plot_u,
                          flwr_violin_plot_k, flwr_violin_plot_u,
                          seed_violin_plot_k, seed_violin_plot_u,
                          nrow = 3, ncol = 2, common.legend = T, legend="right")
#png("greenup_plots_L2_all_phenology_violin.png", units="in", width=8, height=8, res=300)
annotate_figure(phen_violin,
                left = text_grob("Phenological event", color = "black", rot = 90),
                bottom = text_grob("Julian date", color = "black"))
#dev.off()
```

## Combining greenup, flower, and seed into one figure - plot level
## Line plot - code from Moriah
```{r}
# greenup
sum_green_plot2$year <- as.factor(sum_green_plot2$year)
gr_line <- function(loc) { 
  gr_plot <- subset(sum_green_plot2, site == loc)
  return(ggplot(gr_plot, aes(x = year, y = avg_julian, group = state)) +
                 geom_errorbar(aes(ymin=avg_julian-se, ymax=avg_julian+se), position=position_dodge(0.1), width=.25) +
           geom_line(aes(color=state), size = 1) +
           geom_point(aes(color=state), size = 2) +
           scale_color_manual(values = c("#a6bddb", "#fb6a4a"), labels=c("Ambient","Warmed")) +
           labs(x = NULL, y = "Green-up", title = loc, color="Treatment") +
           ylim(100,170) +
           theme_bw(14))
}
gr_line_kbs <- gr_line("KBS")
gr_line_kbs <- gr_line_kbs + theme(axis.text.x=element_blank())
gr_line_umbs <- gr_line("UMBS")
gr_line_umbs <- gr_line_umbs + labs(y=NULL) + theme(axis.text.x=element_blank(),
                                                    axis.title.y=element_blank(),
                                                    axis.text.y=element_blank())

#flower
sum_flwr_plot <- sum_flwr_plot[!(sum_flwr_plot$site == "UMBS" & sum_flwr_plot$year == "2021" ),] 

sum_flwr_plot$year <- as.factor(sum_flwr_plot$year)
flwr_line <- function(loc) { 
  flwr_plot <- subset(sum_flwr_plot, site == loc)
  return(ggplot(flwr_plot, aes(x = year, y = avg_julian, group = state)) +
                 geom_errorbar(aes(ymin=avg_julian-se, ymax=avg_julian+se), position=position_dodge(0.1), width=.25) +
           geom_line(aes(color=state), size = 1) +
           geom_point(aes(color=state), size = 2) +
           scale_color_manual(values = c("#a6bddb", "#fb6a4a"), labels=c("Ambient","Warmed")) +
           labs(x = NULL, y = "Flowering", title=loc, color="Treatment") +
           ylim(165,220) +
           theme_bw(14))
}
flwr_line_kbs <- flwr_line("KBS")
flwr_line_kbs <- flwr_line_kbs + theme(axis.text.x=element_blank()) + labs(title=NULL)
flwr_line_umbs <- flwr_line("UMBS")
flwr_line_umbs <- flwr_line_umbs + labs(y=NULL, title=NULL) + theme(axis.text.x=element_blank(),
                                                                    axis.title.y=element_blank(),
                                                                    axis.text.y=element_blank())

#seed
sum_sd_plot <- sum_sd_plot[!(sum_sd_plot$site == "UMBS" & sum_sd_plot$year == "2021" ),] 

sum_sd_plot$year <- as.factor(sum_sd_plot$year)
sd_line <- function(loc) { 
  sd_plot <- subset(sum_sd_plot, site == loc)
  return(ggplot(sd_plot, aes(x = year, y = avg_julian, group = state)) +
                 geom_errorbar(aes(ymin=avg_julian-se, ymax=avg_julian+se), position=position_dodge(0.1), width=.25) +
           geom_line(aes(color=state), size = 1) +
           geom_point(aes(color=state), size = 2) +
           scale_color_manual(values = c("#a6bddb", "#fb6a4a"),labels=c("Ambient","Warmed")) +
           labs(x = NULL, y = "Seed set", title=loc, color="Treatment") +
           ylim(175,250) +
           theme_bw(14))
}
sd_line_kbs <- sd_line("KBS")
sd_line_kbs <- sd_line_kbs + labs(title=NULL)
sd_line_umbs <- sd_line("UMBS")
sd_line_umbs <- sd_line_umbs + labs(y=NULL, title=NULL) + theme(axis.title.y=element_blank(),
                                                                axis.text.y=element_blank())

phen_line <- ggpubr::ggarrange(gr_line_kbs, gr_line_umbs,
                          flwr_line_kbs, flwr_line_umbs,
                          sd_line_kbs, sd_line_umbs,
                          nrow = 3, ncol = 2, common.legend = T, legend="bottom")
png("greenup_plots_L2_all_phenology_line.png", units="in", width=9, height=8, res=300)
annotate_figure(phen_line,
                left = text_grob("Phenological event julian date", color = "black", rot = 90, size=15),
                bottom = text_grob("Year", color = "black", size=15))
dev.off()
```

## Combining greenup, flower, and seed into one figure - plot level
## Line plot with insecticide - code from Moriah
```{r}
# greenup
sum_green_plot_i2_v2$year <- as.factor(sum_green_plot_i2_v2$year)
sum_green_plot_i2_v2$full_treat <- paste(sum_green_plot_i2_v2$state, sum_green_plot_i2_v2$insecticide, sep="_")
gr_line_i <- function(loc) { 
        gr_plot <- subset(sum_green_plot_i2_v2, site == loc)
        return(ggplot(gr_plot, aes(x = year, y = avg_julian, group=full_treat, linetype=full_treat, color = full_treat)) +
                       geom_errorbar(aes(ymin=avg_julian-se, ymax=avg_julian+se), color="black",linetype="solid", position=position_dodge(0.1), width=.3) +
                       geom_line(size = 1) +
                       geom_point(size = 2) +
                       scale_color_manual(name="Treatment",
                                          values = c("#a6bddb", "#a6bddb", "#fb6a4a", "#fb6a4a"),
                                          labels=c("Ambient + Herbivory","Ambient + Reduced Herbivory","Warmed + Herbivory", "Warmed + Reduced Herbivory")) +
                       scale_linetype_manual(name="Treatment",
                                             values = c("solid", "dotdash", "solid", "dotdash"),
                                             labels=c("Ambient + Herbivory","Ambient + Reduced Herbivory","Warmed + Herbivory", "Warmed + Reduced Herbivory")) +
                       labs(x = NULL, y = "Green-up", title = loc) +
                       #ylim(100,165) +
                       theme_bw(14))
}
gr_line_i_kbs <- gr_line_i("KBS")
gr_line_i_kbs <- gr_line_i_kbs + theme(axis.text.x=element_blank())
gr_line_i_umbs <- gr_line_i("UMBS")
gr_line_i_umbs <- gr_line_i_umbs + labs(y=NULL) + theme(axis.text.x=element_blank(),
                                                        axis.title.y=element_blank())
                                                        #axis.text.y=element_blank())
#flower
sum_flwr_plot_i$year <- as.factor(sum_flwr_plot_i$year)
sum_flwr_plot_i$full_treat <- paste(sum_flwr_plot_i$state, sum_flwr_plot_i$insecticide, sep="_")
flwr_line_i <- function(loc) { 
        flwr_plot <- subset(sum_flwr_plot_i, site == loc)
        return(ggplot(flwr_plot, aes(x = year, y = avg_julian, group=full_treat, linetype=full_treat, color = full_treat)) +
                       geom_errorbar(aes(ymin=avg_julian-se, ymax=avg_julian+se), color="black",linetype="solid",position=position_dodge(0.1), width=.3) +
                       geom_line(size = 1) +
                       geom_point(size = 2) +
                       scale_color_manual(name="Treatment",
                                          values = c("#a6bddb", "#a6bddb", "#fb6a4a", "#fb6a4a"),
                                          labels=c("Ambient + Herbivory","Ambient + Reduced Herbivory","Warmed + Herbivory", "Warmed + Reduced Herbivory")) +
                       scale_linetype_manual(name="Treatment",
                                             values = c("solid", "dotdash", "solid", "dotdash"),
                                             labels=c("Ambient + Herbivory","Ambient + Reduced Herbivory","Warmed + Herbivory", "Warmed + Reduced Herbivory")) +
                       labs(x = NULL, y = "Flowering", title = loc) +
                       #ylim(160,215) +
                       theme_bw(14))
}
flwr_line_i_kbs <- flwr_line_i("KBS")
flwr_line_i_kbs <- flwr_line_i_kbs + theme(axis.text.x=element_blank()) + labs(title=NULL)
flwr_line_i_umbs <- flwr_line_i("UMBS")
flwr_line_i_umbs <- flwr_line_i_umbs + labs(y=NULL, title=NULL) + theme(axis.text.x=element_blank(),
                                                        axis.title.y=element_blank())
                                                        #axis.text.y=element_blank())

#seed
sum_sd_plot_i$year <- as.factor(sum_sd_plot_i$year)
sum_sd_plot_i$full_treat <- paste(sum_sd_plot_i$state, sum_sd_plot_i$insecticide, sep="_")
sd_line_i <- function(loc) { 
        sd_plot <- subset(sum_sd_plot_i, site == loc)
        return(ggplot(sd_plot, aes(x = year, y = avg_julian, group=full_treat, linetype=full_treat, color = full_treat)) +
                       geom_errorbar(aes(ymin=avg_julian-se, ymax=avg_julian+se), color="black",linetype="solid",position=position_dodge(0.1), width=.3) +
                       geom_line(size = 1) +
                       geom_point(size = 2) +
                       scale_color_manual(name="Treatment",
                                          values = c("#a6bddb", "#a6bddb", "#fb6a4a", "#fb6a4a"),
                                          labels=c("Ambient + Herbivory","Ambient + Reduced Herbivory","Warmed + Herbivory", "Warmed + Reduced Herbivory")) +
                       scale_linetype_manual(name="Treatment",
                                             values = c("solid", "dotdash", "solid", "dotdash"),
                                             labels=c("Ambient + Herbivory","Ambient + Reduced Herbivory","Warmed + Herbivory", "Warmed + Reduced Herbivory")) +
                       labs(x = NULL, y = "Seed set", title = loc) +
                       #ylim(175,255) +
                       theme_bw(14))
}
sd_line_i_kbs <- sd_line_i("KBS")
sd_line_i_kbs <- sd_line_i_kbs + labs(title=NULL)
sd_line_i_umbs <- sd_line_i("UMBS")
sd_line_i_umbs <- sd_line_i_umbs + labs(y=NULL, title=NULL)+ theme(axis.title.y=element_blank())
                                                        #axis.text.y=element_blank())

phen_line_i <- ggpubr::ggarrange(gr_line_i_kbs, gr_line_i_umbs,
                          flwr_line_i_kbs, flwr_line_i_umbs,
                          sd_line_i_kbs, sd_line_i_umbs,
                          nrow = 3, ncol = 2, common.legend = T, legend="right")
png("greenup_plots_L2_all_phenology_line_insect.png", units="in", width=10, height=8, res=300)
annotate_figure(phen_line_i,
                left = text_grob("Phenological event julian date", color = "black", rot = 90, size=15),
                bottom = text_grob("Year", color = "black", size=15))
dev.off()
```

## Bar plot for greenup for KBS and UMBS - Species min cover date
```{r, echo = F}
greenup_plot_all <- function(loc) { 
  greenup_spp <- subset(sum_green_site_min, site == loc)
  return(ggplot(greenup_spp, aes(x = state, y = avg_julian, fill = state)) +
           facet_grid(.~year) +
           geom_bar(position = "identity", stat = "identity", color = "black") +
           geom_errorbar(aes(ymin = avg_julian - se, ymax = avg_julian + se), width = 0.2,
                         position = "identity") +
           labs(x = "State", y = "Julian Day of Greenup", title = loc) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
           theme_classic())
}
greenup_plot_all("kbs")
greenup_plot_all("umbs")
```

## Box plot for greenup for KBS and UMBS - Species min cover date
```{r, echo = F}
greenup_plot_box <- function(loc) { 
  greenup_spp <- subset(gr_species, site == loc)
  return(ggplot(greenup_spp, aes(x = state, y = min_green_date, fill = state)) +
           facet_grid(.~year) +
           geom_boxplot(color = "black") +
           labs(x = "State", y = "Julian Day of Greenup", title = loc) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
           theme_classic())
}
greenup_plot_box("kbs")
greenup_plot_box("umbs")
```

## Plot for warmed vs ambient greenup between native and exotic - Species half cover date
```{r, echo = F}
greenup_plot_org <- function(loc) { 
  greenup_spp <- subset(sum_green_org, site == loc)
  return(ggplot(greenup_spp, aes(x = origin, y = avg_julian, fill = state)) +
           #facet_grid(.~year) +
           geom_bar(position = "dodge", stat = "identity", color = "black") +
           geom_errorbar(aes(ymin = avg_julian - se, ymax = avg_julian + se), width = 0.2,
                         position = position_dodge(0.9)) +
           labs(x = "State", y = "Julian Day of Greenup", title = loc) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
           coord_cartesian(ylim = c(100, 200)) +
           theme_classic())
}
greenup_plot_org("kbs")
greenup_plot_org("umbs")     
```

## Plot for warmed vs ambient greenup between native and exotic - Plot half cover date
```{r, echo = F}
greenup_plot_org2 <- function(loc) { 
  greenup_plot <- subset(gr_origin, site == loc)
  return(ggplot(greenup_plot, aes(x = origin, y = origin_half_cover_date, fill = state)) +
           #facet_grid(.~year) +
           geom_boxplot(color = "black") +
           labs(x = "State", y = "Julian Day of Greenup", title = loc) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
           theme_classic())
}

greenup_plot_org2("kbs")
greenup_plot_org2("umbs")     
```

## Plot for warmed vs ambient greenup between growth types - Species half cover date
```{r, echo = F}
greenup_plot_habit <- function(loc) { 
  greenup_spp <- subset(sum_green_habit, site == loc)
  return(ggplot(greenup_spp, aes(x = growth_habit, y = avg_julian, fill = state)) +
           #facet_grid(.~year) +
           geom_bar(position = "dodge", stat = "identity", color = "black") +
           geom_errorbar(aes(ymin = avg_julian - se, ymax = avg_julian + se), width = 0.2,
                         position = position_dodge(0.9)) +
           labs(x = "State", y = "Julian Day of Greenup", title = loc) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
           coord_cartesian(ylim = c(100, 200)) +
           theme_classic())
}
greenup_plot_habit("kbs")
greenup_plot_habit("umbs")  
```

## Plot for warmed vs ambient greenup between growth types - Plot half cover date
```{r, echo = F}
greenup_plot_habit2 <- function(loc) { 
  greenup_plot <- subset(gr_growth, site == loc)
  return(ggplot(greenup_plot, aes(x = growth_habit, y = habit_half_cover_date, fill = state)) +
           #facet_grid(.~year) +
           geom_boxplot(color = "black") +
           labs(x = "State", y = "Julian Day of Greenup", title = loc) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
           theme_classic())
}

greenup_plot_habit2("kbs")
greenup_plot_habit2("umbs")     
```

## Greenup plot for a given site and species - half cover date
### Ex: Soca at KBS, Cest at UMBS
```{r, echo = F}
greenup_plot <- function(spp, loc) { 
  greenup_spp <- subset(sum_green_spp, species == spp & site == loc)
  return(ggplot(greenup_spp, aes(x = state, y = avg_julian, fill = state)) +
           geom_bar(position = "identity", stat = "identity", color = "black") +
           geom_errorbar(aes(ymin = avg_julian - se, ymax = avg_julian + se), width = 0.2,
                         position = "identity") +
           labs(x = "State", y = "Julian Day of Greenup", title = spp) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           #coord_cartesian(ylim = c(100, 250)) +
           scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
           theme_classic())
}
greenup_plot("Soca", "kbs")
greenup_plot("Cest", "umbs")
```

## Greenup plot for a given site
```{r, echo = F}
greenup_plot_overall <- function(loc) { 
  greenup_spp <- subset(sum_green_spp, site == loc)
  return(ggplot(greenup_spp, aes(x = state, y = avg_julian, fill = state)) +
                 facet_wrap(~species, ncol=4) +
           geom_bar(position = "identity", stat = "identity", color = "black") +
           geom_errorbar(aes(ymin = avg_julian - se, ymax = avg_julian + se), width = 0.2,
                         position = "identity") +
           labs(x = NULL, y = NULL, title=loc) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           #coord_cartesian(ylim = c(100, 250)) +
           scale_x_discrete(labels=c("ambient" = "Ambient", "warmed" = "Warmed")) +
           theme_bw()) +
          theme(legend.position = "none")
}
kbs_green_spp <- greenup_plot_overall("KBS")
umbs_green_spp <- greenup_plot_overall("UMBS")
green_overall_merge <- ggpubr::ggarrange(kbs_green_spp, umbs_green_spp,
                          ncol = 2, legend="none")
png("greenup_species.png", units="in", width=12, height=8, res=300)
annotate_figure(green_overall_merge,
                left = text_grob("Julian date of green-up", color = "black", rot = 90, size=15),
                bottom = text_grob("State", color = "black", size=15))
dev.off()
```

# GDD and temp figure
```{r, echo = F}
green_kbsp <- subset(gr_plot, site == "KBS")
green_umbsp <- subset(gr_plot, site == "UMBS")

# Add in GDD and temp data for each year + treatment
green_kbsp <- left_join(green_kbsp, temps_KBS, by=c('year','state'))
green_umbsp <- left_join(green_umbsp, temps_UMBS, by=c('year','state'))
# cutoff dates based on HOBO_GDD_L1.R script
# basing cutoff for GDD KBS at julian date 178
GDD_green_KBS <- GDD_KBS %>%
        filter(julian == 178) %>%
        select(-max_temp, -min_temp, -mean_GDD_temp, -GDD_base_10, -julian)
green_kbsp <- left_join(green_kbsp, GDD_green_KBS, by=c('year','state'))
# basing cutoff for GDD UMBS at julian date 167
GDD_green_UMBS <- GDD_UMBS %>%
        filter(julian == 167) %>%
        select(-max_temp, -min_temp, -mean_GDD_temp, -GDD_base_10, -julian)
green_umbsp <- left_join(green_umbsp, GDD_green_UMBS, by=c('year','state'))

# looking to see which temp variable best correlates with greenup dates
# note: when testing this for min dates, there are less data points because all plots had the same 
# min date of greenup per site, per year, whereas the plots had different half cover dates
kbs_gdd <- ggplot(green_kbsp, aes(x = GDD_cumulative, y = plot_half_cover_date, color = state))+
        geom_point() +
        geom_smooth(method = 'lm', aes(fill = state)) + 
        labs(x = "Cumulative growing degree days (GDD)",y=NULL) +
        scale_color_manual(values = c("#a6bddb", "#fb6a4a"),
                           labels = c("Ambient","Warmed"),
                           name="Treatment") +
        scale_fill_manual(values = c("#a6bddb", "#fb6a4a"),
                          labels = c("Ambient","Warmed"),
                          name = "Treatment") +
       theme_classic() +
        theme(legend.title=element_text(size=12), 
              legend.text=element_text(size=12))
umbs_gdd <- ggplot(green_umbsp, aes(x = GDD_cumulative, y = plot_half_cover_date, color = state))+
        geom_point() +
        geom_smooth(method = 'lm', aes(fill = state)) + 
        labs(x = "Cumulative growing degree days (GDD)",y=NULL) +
        scale_color_manual(values = c("#a6bddb", "#fb6a4a"),
                           labels = c("Ambient","Warmed"),
                           name="Treatment") +
        scale_fill_manual(values = c("#a6bddb", "#fb6a4a"),
                          labels = c("Ambient","Warmed"),
                          name = "Treatment") +
        theme_classic() +
        theme(legend.title=element_text(size=12), 
              legend.text=element_text(size=12))
kbs_mean <- ggplot(green_kbsp, aes(x = mean_temp, y = plot_half_cover_date, color = state))+
        geom_point() +
        geom_smooth(method = 'lm', aes(fill = state)) + 
        labs(x = "Mean temperature (°C)",y=NULL) +
        scale_color_manual(values = c("#a6bddb", "#fb6a4a"),
                           labels = c("Ambient","Warmed"),
                           name="Treatment") +
        scale_fill_manual(values = c("#a6bddb", "#fb6a4a"),
                          labels = c("Ambient","Warmed"),
                          name = "Treatment") +
        theme_classic() +
        theme(legend.title=element_text(size=12), 
              legend.text=element_text(size=12))
umbs_mean <- ggplot(green_umbsp, aes(x = mean_temp, y = plot_half_cover_date, color = state))+
        geom_point() +
        geom_smooth(method = 'lm', aes(fill = state)) + 
        labs(x = "Mean temperature (°C)",y=NULL) +
        scale_color_manual(values = c("#a6bddb", "#fb6a4a"),
                           labels = c("Ambient","Warmed"),
                           name="Treatment") +
        scale_fill_manual(values = c("#a6bddb", "#fb6a4a"),
                          labels = c("Ambient","Warmed"),
                          name = "Treatment") +
        theme_classic() +
        theme(legend.title=element_text(size=12), 
              legend.text=element_text(size=12))
kbs_med <- ggplot(green_kbsp, aes(x = median_temp, y = plot_half_cover_date, color = state))+
        geom_point() +
        geom_smooth(method = 'lm', aes(fill = state)) + 
        labs(x = "Median temperature (°C)",y=NULL) +
        scale_color_manual(values = c("#a6bddb", "#fb6a4a"),
                           labels = c("Ambient","Warmed"),
                           name="Treatment") +
        scale_fill_manual(values = c("#a6bddb", "#fb6a4a"),
                          labels = c("Ambient","Warmed"),
                          name = "Treatment") +
        theme_classic() +
        theme(legend.title=element_text(size=12), 
              legend.text=element_text(size=12))
umbs_med <- ggplot(green_umbsp, aes(x = median_temp, y = plot_half_cover_date, color = state))+
        geom_point() +
        geom_smooth(method = 'lm', aes(fill = state)) + 
        labs(x = "Median temperature (°C)",y=NULL) +
        scale_color_manual(values = c("#a6bddb", "#fb6a4a"),
                           labels = c("Ambient","Warmed"),
                           name="Treatment") +
        scale_fill_manual(values = c("#a6bddb", "#fb6a4a"),
                          labels = c("Ambient","Warmed"),
                          name = "Treatment") +
        theme_classic() +
        theme(legend.title=element_text(size=12), 
              legend.text=element_text(size=12))
kbs_max <- ggplot(green_kbsp, aes(x = max_temp, y = plot_half_cover_date, color = state))+
        geom_point() +
        geom_smooth(method = 'lm', aes(fill = state)) + 
        labs(x = "Max temperature (°C)",y=NULL) +
        scale_color_manual(values = c("#a6bddb", "#fb6a4a"),
                           labels = c("Ambient","Warmed"),
                           name="Treatment") +
        scale_fill_manual(values = c("#a6bddb", "#fb6a4a"),
                          labels = c("Ambient","Warmed"),
                          name = "Treatment") +
        theme_classic() +
        theme(legend.title=element_text(size=12), 
              legend.text=element_text(size=12))
umbs_max <- ggplot(green_umbsp, aes(x = max_temp, y = plot_half_cover_date, color = state))+
        geom_point() +
        geom_smooth(method = 'lm', aes(fill = state)) + 
        labs(x = "Max temperature (°C)",y=NULL) +
        scale_color_manual(values = c("#a6bddb", "#fb6a4a"),
                           labels = c("Ambient","Warmed"),
                           name="Treatment") +
        scale_fill_manual(values = c("#a6bddb", "#fb6a4a"),
                          labels = c("Ambient","Warmed"),
                          name = "Treatment") +
        theme_classic() +
        theme(legend.title=element_text(size=12), 
              legend.text=element_text(size=12))

gdd_temp_merge <- ggpubr::ggarrange(kbs_gdd,umbs_gdd,
                                    kbs_mean,umbs_mean,
                                    kbs_med,umbs_med,
                                    kbs_max,umbs_max,
                          ncol = 2, nrow=4,common.legend=T,legend="bottom")
png("greenup_gdd_temp.png", units="in", width=7, height=8, res=300)
annotate_figure(gdd_temp_merge,
                left = text_grob("Green-up half cover julian date", color = "black", rot = 90, size=15),
                top = text_grob("KBS                                                      UMBS", color = "black", size=15))
dev.off()

```


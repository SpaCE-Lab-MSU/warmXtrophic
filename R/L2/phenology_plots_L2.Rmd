---
title: "Phenology Visualization"
author: "Moriah Young"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  pdf_document: default
---

COLLABORATORS: Phoebe Zarnetske, Mark Hammond, Pat Bills, Kara Dobson  
DATA INPUT: Cleaned phenology data csv from the shared Google drive  
DATA OUTPUT: Code and Rmd are in the scripts folder in Github  
PROJECT: warmXtrophic  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy.opts = list(width.cutoff=80), tidy=TRUE)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Clear existing data
rm(list=ls())

# Load packages
library(tidyverse)
library(plotrix)

# Set working directory to Google Drive
setwd("/Volumes/GoogleDrive/Shared drives/SpaCE_Lab_warmXtrophic/data/")

# Read in data 
phen_data <- read.csv("/Volumes/GoogleDrive/Shared drives/SpaCE_Lab_warmXtrophic/data/L1/phenology/final_flw_sd_L1.csv", stringsAsFactors=FALSE)
phen_data <- phen_data %>% 
        select(-X) # get rid of "X" column that shows up

# Create separate data frames for flowering and seeding
phen_flwr <- subset(phen_data, action == "flower")
phen_sd <- subset(phen_data, action == "seed")

# This creates a data frame that returns the first date of flower for every species and plot
# Filter data to contain the date of first occurrence for each species
FirstFlower_all <- phen_flwr %>%
        group_by(plot, year, species, state, site, action, origin) %>%
        summarize(julian = min(julian, na.rm=T))

# This creates a data frame that returns the mean julian date of first flower by site, state, species and year      
sum_FirstFlower <- FirstFlower_all %>%
        group_by(site, state, species, year) %>%
        summarize(avg_julian = mean(julian, na.rm = TRUE),
                  se = std.error(julian, na.rm = TRUE))

# This gives the average julian day of first flower for all species for each site and year for warmed and ambient
sum_FirstFlwr_state <- FirstFlower_all %>%
        group_by(site, state, year) %>%
        summarize(avg_julian = mean(julian, na.rm = TRUE),
                  se = std.error(julian, na.rm = TRUE)) 

# Native vs Exotic
sum_flwr_org <- FirstFlower_all %>%
        group_by(site, origin, state, year) %>%
        summarize(avg_julian = mean(julian, na.rm = TRUE),
                  se = std.error(julian, na.rm = TRUE))
sum_flwr_org <- subset(sum_flwr_org, origin == "Exotic" | origin == "Native")

# Flower duration
flwr_duration <- phen_flwr %>% 
        group_by(site, plot, species, year, state, action, origin) %>%
        summarise(flwr_duration = max(julian) - min(julian)) 

sum_flwrduration_state <- flwr_duration %>% 
        group_by(site, state, action, year) %>% 
        summarise(mean_duration = mean(flwr_duration),
                  se = std.error(flwr_duration, na.rm = TRUE))

# This creates a data frame that returns the first date of seed for every species and plot
# Filter data to contain the date of first occurrence for each species
FirstSeed_all <- phen_sd %>%
        group_by(plot, year, species, state, site, action) %>%
        summarize(julian = min(julian, na.rm=T))

# This creates a data frame that returns the mean julian date of first seed by site, state, species and year        
sum_FirstSeed <- FirstSeed_all %>%
        group_by(site, state, species, year) %>%
        summarize(avg_julian = mean(julian, na.rm = TRUE),
                  se = std.error(julian, na.rm = TRUE))

# This gives the average julian day of first flower for all species for each site and year for warmed and ambient
sum_FirstSeed_state <- FirstSeed_all %>%
        group_by(site, state, year) %>%
        summarize(avg_julian = mean(julian, na.rm = TRUE),
                  se = std.error(julian, na.rm = TRUE)) 
```

# Plots to Visualize Flowering
## This creates a plot for a given species and site and for every year
```{r, echo = FALSE, warning=FALSE, message=FALSE}
FirstFlower_plot <- function(spp, loc) { 
        FirstFlower_spp <- subset(sum_FirstFlower, species == spp & site == loc)
        return(ggplot(FirstFlower_spp, aes(x = state, y = avg_julian, fill = state)) +
                       facet_grid(.~year) +
                       geom_bar(position = "identity", stat = "identity") +
                       geom_errorbar(aes(ymin = avg_julian - se, ymax = avg_julian + se), width = 0.2,
                                     position = "identity") +
                       labs(x = "State", y = "Julian Date", title = spp, subtitle = loc) +
                       coord_cartesian(ylim = c(100, 250)) +
                       scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
                       scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
                       theme_grey())
}
FirstFlower_plot("Popr", "umbs")
FirstFlower_plot("Popr", "kbs")
```

## Plots for a given site and year for average first date of flower comparing ambient vs warmed plots
```{r, echo = FALSE, warning=FALSE, message=FALSE}
sum_FirstFlwr_plot <- function(loc) { 
        FirstFlwr_sub <- subset(sum_FirstFlwr_state, site == loc)
        return(ggplot(FirstFlwr_sub, aes(x = state, y = avg_julian, fill = state)) +
                       facet_grid(.~year) +
                       geom_bar(position = "identity", stat = "identity") +
                       geom_errorbar(aes(ymin = avg_julian - se, ymax = avg_julian + se), width = 0.2,
                                     position = "identity") +
                       labs(x = "State", y = "Julian DaTE", title = "Average Julian Date of First Flower", 
                            subtitle = loc) +
                       #coord_cartesian(ylim = c(150, 180)) +
                       scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
                       scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
                       theme_grey())
}
sum_FirstFlwr_plot("kbs")
sum_FirstFlwr_plot("umbs")
```

## Flowering Duration
```{r, echo=FALSE, warning=FALSE, message=FALSE}
sum_FlwrDurState_plot <- function(loc) { 
        flwr_Duration <- subset(sum_flwrduration_state, site == loc)
        return(ggplot(flwr_Duration, aes(x = state, y = mean_duration, fill = state)) +
                       facet_grid(.~year) +
                       geom_bar(position = "identity", stat = "identity") +
                       geom_errorbar(aes(ymin = mean_duration - se, ymax = mean_duration + se), width = 0.2,
                                     position = "identity") +
                       labs(x = "State", y = "Julian Date", title = "Average Duration of Flowering", 
                            subtitle = loc) +
                       #coord_cartesian(ylim = c(150, 200)) +
                       scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
                       scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
                       theme_grey())
}

sum_FlwrDurState_plot("kbs")
sum_FlwrDurState_plot("umbs")
```
```{r, echo=FALSE}
flwr_org_plot <- function(loc) { 
        flwr_spp <- subset(sum_flwr_org, site == loc)
        return(ggplot(flwr_spp, aes(x = origin, y = avg_julian, fill = state)) +
                       facet_grid(.~year) +
                       geom_bar(position = "dodge", stat = "identity", color = "black") +
                       geom_errorbar(aes(ymin = avg_julian - se, ymax = avg_julian + se), width = 0.2,
                                     position = position_dodge(0.9)) +
                       labs(x = "State", y = "Julian Date", 
                            title = "Native vs Exotic Avg Julian Date of First Flower", subtitle = loc) +
                       scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
                       scale_x_discrete(labels=c("Exotic" = "E", "Native" = "N")) +
                       #coord_cartesian(ylim = c(100, 200)) +
                       theme_grey())
}
flwr_org_plot("kbs")
flwr_org_plot("umbs")
```

# Plots to Visualize Seed Set
# Plots for a given species and site and it's mean julian day of first seed for every year of data collection
```{r, echo=FALSE}
FirstSeed_plot <- function(spp, loc) { 
        FirstSeed_spp <- subset(sum_FirstSeed, species == spp & site == loc)
        return(ggplot(FirstSeed_spp, aes(x = state, y = avg_julian, fill = state)) +
                       facet_grid(.~year) +
                       geom_bar(position = "identity", stat = "identity") +
                       geom_errorbar(aes(ymin = avg_julian - se, ymax = avg_julian + se), width = 0.2,
                                     position = "identity") +
                       labs(x = "State", y = "Julian Date", title = spp, subtitle = loc) +
                       #coord_cartesian(ylim = c(150, 300)) +
                       scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
                       scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
                       theme_grey())
}
FirstSeed_plot("Popr", "umbs")
FirstSeed_plot("Popr", "kbs")
```

## Plots for a given site and year for average first date of seed comparing ambient vs warmed plots
```{r, echo=FALSE}
sum_FirstSeed_plot <- function(loc) { 
        FirstSeed_sub <- subset(sum_FirstSeed_state, site == loc)
        return(ggplot(FirstSeed_sub, aes(x = state, y = avg_julian, fill = state)) +
                       facet_grid(.~year) +
                       geom_bar(position = "identity", stat = "identity") +
                       geom_errorbar(aes(ymin = avg_julian - se, ymax = avg_julian + se), width = 0.2,
                                     position = "identity") +
                       labs(x = "State", y = "Julian Date", title = "Average Julian Date of First Seed", 
                            subtitle = loc) +
                       coord_cartesian(ylim = c(150, 250)) +
                       scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
                       scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
                       theme_grey())
}
sum_FirstSeed_plot("kbs")
sum_FirstSeed_plot("umbs")

```


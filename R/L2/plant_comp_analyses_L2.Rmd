---
title: "warmXtrophic Project: Plant Composition Analyses"
author: "Moriah Young"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=80),tidy=TRUE)
```

Load in packages & data
```{r, message = F}
rm(list=ls()) # clear all existing data

#Load packages
library(tidyverse)
library(ggplot2)
library(lme4)
library(lmerTest)
library(emmeans)
library(vegan)
library(car)
library(rstatix)
library(scales)
library(fitdistrplus)
library(moments)# for calculating skewness of data
library(ggpubr)
library(jtools) # summ() function
library(predictmeans)
library(olsrr)
library(car)
library(fitdistrplus)
library(ggpubr)
library(interactions)
library(sjPlot)
library(effects)
library(glmmTMB)
library(GGally) # ggpairs() function
library(bbmle) # AICtab() function
library(knitr)
library(GLMMadaptive)
library(MuMIn)

# Set working directory
Sys.getenv("L1DIR")
L0_dir <- Sys.getenv("L0DIR")
L1_dir <- Sys.getenv("L1DIR")
L2_dir <- Sys.getenv("L2DIR")

# Read in data
comp_plot <- read.csv(file.path(L2_dir, "plant_composition/final_plant_comp_plot_L2.csv")) # plot level data
comp_plot$year_factor <- as.factor(comp_plot$year_factor)
origin_plot <- read.csv(file.path(L2_dir, "plant_composition/final_plant_comp_origin_plot_L2.csv")) # origin plot level data
origin_plot$year_factor <- as.factor(origin_plot$year_factor)
growth_plot <- read.csv(file.path(L2_dir, "plant_composition/final_plant_comp_growth_habit_plot_L2.csv")) # growth habit plot level data
growth_plot$year_factor <- as.factor(growth_plot$year_factor)

# species level plant comp
# note: the species data frame is only used to demonstrate that plant relative abundance differs between species (for the supplement)
comp_spp <- read.csv(file.path(L2_dir, "plant_composition/final_plant_comp_species_L2.csv"))
```

```{r}
# plot specific dataframes for kbs and umbs
umbs_comp_plot <- subset(comp_plot, site == "umbs") # pull out umbs only data 
kbs_comp_plot <- subset(comp_plot, site == "kbs") # pull out kbs only data 
umbs_origin_plot <- subset(origin_plot, site == "umbs") # pull out umbs only data 
kbs_origin_plot <- subset(origin_plot, site == "kbs") # pull out kbs only data 
umbs_growth_plot <- subset(growth_plot, site == "umbs") # pull out umbs only data 
kbs_growth_plot <- subset(growth_plot, site == "kbs") # pull out kbs only data 

# for origin and growth habit, subset out each into separate dataframes
kbs_exotic_plot <- subset(kbs_origin_plot, origin == "Exotic")
kbs_native_plot <- subset(kbs_origin_plot, origin == "Native")
umbs_exotic_plot <- subset(umbs_origin_plot, origin == "Exotic")
umbs_native_plot <- subset(umbs_origin_plot, origin == "Native")

kbs_forb_plot <- subset(kbs_growth_plot, growth_habit == "Forb")
kbs_graminoid_plot <- subset(kbs_growth_plot, growth_habit == "Graminoid")
umbs_forb_plot <- subset(umbs_growth_plot, growth_habit == "Forb")
umbs_graminoid_plot <- subset(umbs_growth_plot, growth_habit == "Graminoid")

# species specific dataframes for kbs and umbs
comp_kbs_spp <- subset(comp_spp, site == "kbs")
comp_umbs_spp <- subset(comp_spp, site == "umbs")

comp_kbs_native_spp <- subset(comp_kbs_spp, origin == "Native")
comp_kbs_exotic_spp <- subset(comp_kbs_spp, origin == "Exotic")
comp_kbs_forb_spp <- subset(comp_kbs_spp, growth_habit == "Forb")
comp_kbs_graminoid_spp <- subset(comp_kbs_spp, growth_habit == "Graminoid")

comp_umbs_native_spp <- subset(comp_umbs_spp, origin == "Native")
comp_umbs_exotic_spp <- subset(comp_umbs_spp, origin == "Exotic")
comp_umbs_forb_spp <- subset(comp_umbs_spp, growth_habit == "Forb")
comp_umbs_graminoid_spp <- subset(comp_umbs_spp, growth_habit == "Graminoid")

```

#KBS Plot Level
```{r}
### KBS ###
hist(kbs_comp_plot$avg_pc) # slightly right skewed
qqnorm(kbs_comp_plot$avg_pc)
shapiro.test(kbs_comp_plot$avg_pc) # pvalue is < 0.05 so we reject the null hypothesis that the data is normal (aka not normally distributed) 

# Exploring distributions:
descdist(kbs_comp_plot$avg_pc, discrete = FALSE)

# Gamma distribution 
fit.gamma <- fitdist(kbs_comp_plot$avg_relative_abundance, "gamma")
plot(fit.gamma)

# Weibull distribution
fit.weibull  <- fitdist(kbs_comp_plot$avg_relative_abundance, "weibull")
plot(fit.weibull)

# Lognormal distribution 
fit.ln <- fitdist(kbs_comp_plot$avg_relative_abundance, "lnorm")
plot(fit.ln)

par(mfrow=c(2,2))
plot.legend <- c("Gamma", "Weibull", "Log Normal")
denscomp(list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
cdfcomp (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
qqcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
ppcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
dev.off()

# Goodness of fit comparisons across fits (can't include the log normal bc it becomes diff response values)
gofstat(list(fit.gamma, fit.weibull, fit.ln), fitnames = c("Gamma", "Weibull", "Log Normal"))
# log normal best fit 
```

Leverage plots and detecting outliers
```{r}
# Plot level data
# KBS State-only model
fit_plot_state_kbs <- lm(log(avg_pc) ~ state, data = kbs_comp_plot)
outlierTest(fit_plot_state_kbs) # one outlier
qqPlot(fit_plot_state_kbs, main="QQ Plot") 
hist(fit_plot_state_kbs$residuals)
leveragePlots(fit_plot_state_kbs)
ols_test_normality(fit_plot_state_kbs) # looks ok besides Kolmogorov-Smirnov test

# KBS State and year model
fit_plot_stateyear_kbs <- lm(log(avg_pc) ~ state + year_factor, data = kbs_comp_plot)
outlierTest(fit_plot_stateyear_kbs) # no outliers 
qqPlot(fit_plot_stateyear_kbs, main="QQ Plot") 
hist(fit_plot_stateyear_kbs$residuals)
leveragePlots(fit_plot_stateyear_kbs)
ols_test_normality(fit_plot_stateyear_kbs) # a couple tests say not normal 

# Interaction plot (ignore for now the repeated measures with species); see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(log(avg_pc) ~ state * year, data = kbs_comp_plot)
interact_plot(fit3, pred = year, modx = state) # this looks very strange to me

# remove outlier, line 141
kbs_comp_plot_nooutlier <- kbs_comp_plot[!rownames(kbs_comp_plot) == '141', ]
# KBS State-only model
fit_plot_state_kbs <- lm(log(avg_pc) ~ state, data = kbs_comp_plot_nooutlier)
outlierTest(fit_plot_state_kbs) # no outliers
qqPlot(fit_plot_state_kbs, main="QQ Plot") 
hist(fit_plot_state_kbs$residuals)
leveragePlots(fit_plot_state_kbs)
ols_test_normality(fit_plot_state_kbs)

```

Mixed Effects Model
```{r}
# KBS PLOT LEVEL
modfull <- lmer(log(avg_pc) ~ state*insecticide*year_factor + (1|plot), kbs_comp_plot_nooutlier, REML = FALSE)

# Check Assumptions:
# (1) Linearity: if covariates are not categorical (year isn't)
# (2) Homogeneity: Need to Check by plotting residuals vs predicted values.
plot(modfull)
# Check for homogeneity of variances (true if p>0.05). If the result is not significant, the assumption of equal variances (homoscedasticity) is met (no significant difference between the group variances).
# *****Leveneâ€™s Test - tests whether or not the variance among two or more groups is equal - If the p-value is less than our chosen significance level, we can reject the null hypothesis and conclude that we have enough evidence to state that the variance among the groups is not equal (which we want).

kbs_comp_plot_nooutlier$state <- as.factor(kbs_comp_plot_nooutlier$state)
leveneTest(residuals(modfull) ~ kbs_comp_plot_nooutlier$state)
# Assumption not met
kbs_comp_plot_nooutlier$insecticide <- as.factor(kbs_comp_plot_nooutlier$insecticide)
leveneTest(residuals(modfull) ~ kbs_comp_plot_nooutlier$insecticide) 
# Assumption met
kbs_comp_plot_nooutlier$plot <- as.factor(kbs_comp_plot_nooutlier$plot)
leveneTest(residuals(modfull) ~ kbs_comp_plot_nooutlier$plot)
# Assumption met

# (3) Normality of error term: need to check by histogram, QQplot of residuals, could do Kolmogorov-Smirnov test.
# Check for normal residuals
qqPlot(resid(modfull))
hist(residuals(modfull))
shapiro.test(resid(modfull)) # normally distributed resids bc p>0.05
outlierTest(modfull) # no outliers
```

```{r}
# testing if year as continuous or year as a factor makes more sense (test models)
year.mod.test1 <- lmer(log(avg_pc) ~ state + year + (1|plot), kbs_comp_plot_nooutlier, REML=FALSE)
year.mod.test2 <- lmer(log(avg_pc) ~ state + as.factor(year_factor) + (1|plot), kbs_comp_plot_nooutlier, REML=FALSE)
anova(year.mod.test1, year.mod.test2) #year.mod.test2
```

Hypothesized model
```{r}
#Our hypothesized model is:
mod_k_full <- lmer(log(avg_pc) ~ state * insecticide * as.factor(year_factor) + (1|plot), kbs_comp_plot, REML=FALSE) #hypothesized model
summary(mod_k_full)
anova(mod_k_full)
exp(2.763627)
exp(2.763627+0.013714)

# comparisons
contrast.k1 <- contrast(emmeans(mod_k_full, ~state*year_factor), "pairwise", simple = "each", combine = F, adjust = "mvt", type = "response")
# KD: back transforming ratio (https://www.reddit.com/r/statistics/comments/t6ph7o/comment/hzl704x/)
# ambient plots had 0.61 times the cover of warmed in 2021

result1 = as.data.frame(contrast.k1)

result1 <- result1 %>%
mutate_if(is.numeric, round, digits=2)

# table
kable(result1) %>% kableExtra::kable_styling()

# comparisons
contrast.k2 <- contrast(emmeans(mod_k_full, ~insecticide*year_factor), "pairwise", simple = "each", combine = F, adjust = "mvt", type = "response")
(0.720 - 1) * 100 # 28% decrease in herbivory, or, 28% increase in reduced herbivory
# but, saying % increase/decrease is confusing since our response variable is a percent
# i.e., 20% --> 16% is a 20% decrease, but if we say there was a 20% decrease, it sounds like 20% --> 0%
# so maybe it makes more sense to say herbivory plots had 0.72 times the amount of percent cover as reduced herbivory?
35*0.72 # 25, % cover decreases by 10
20*0.72 # 14, percent cover decreases by 6

result2 = as.data.frame(contrast.k2)

result2 <- result2 %>%
mutate_if(is.numeric, round, digits=2)

# table
kable(result2) %>% kableExtra::kable_styling()

# calculating effect size of warming - accounting for log transformation
exp((2.763627) +  (0.013714)*0) # 15.85725 
exp((2.763627) +  (0.013714)*1) # 16.07622
# effect:
16.07622 - 15.85725 # effect of warming - warmed plots had 0.21897 or 0.22% more percent cover than ambient plots

# adding in our temp data into some models
# note: including state, year, and temp data into a model leads to rank deficiency
# so below, we test for green-up as a function of just temp to see how real temp data affects green-up
kbs_comp_plot_amb <- kbs_comp_plot %>%
        filter(state == "ambient")
modtest1k <- lmer(log(avg_pc) ~ mean_temp + (1|plot), kbs_comp_plot_amb, REML=FALSE)
modtest2k <- lmer(log(avg_pc) ~ GDD_cumulative + (1|plot), kbs_comp_plot_amb, REML=FALSE)

AICtab(modtest1k,modtest2k)
anova(modtest1k)
summary(modtest1k)

r.squaredGLMM(modtest1k)

# making a table
kable(anova(modtest1k)) %>% kableExtra::kable_styling()

# species model for supp
mod_spp_k <- lmer(cover ~ state * insecticide * as.factor(year_factor) + species + (1|plot), comp_kbs_spp, REML=FALSE)
anova(mod_spp_k)
# making a table
kable(anova(mod_spp_k), digits = 2) %>% kableExtra::kable_styling()
```

#UMBS Plot Level
```{r}
### UMBS ###
hist(umbs_comp_plot$avg_pc)
qqnorm(umbs_comp_plot$avg_pc)
shapiro.test(umbs_comp_plot$avg_pc) # pvalue is < 0.05 so we reject the null hypothesis that the data is normal (aka not normally distributed) 

# Exploring distributions:
descdist(umbs_comp_plot$avg_pc, discrete = FALSE)

# Gamma distribution 
fit.gamma <- fitdist(umbs_comp_plot$avg_pc, "gamma")
plot(fit.gamma)

# Weibull distribution
fit.weibull  <- fitdist(umbs_comp_plot$avg_pc, "weibull")
plot(fit.weibull)

# Lognormal distribution 
fit.ln <- fitdist(umbs_comp_plot$avg_pc, "lnorm")
plot(fit.ln)

par(mfrow=c(2,2))
plot.legend <- c("Gamma", "Weibull", "Log Normal")
denscomp(list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
cdfcomp (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
qqcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
ppcomp  (list(fit.gamma, fit.weibull, fit.ln), legendtext = plot.legend)
dev.off()

# Goodness of fit comparisons across fits (can't include the log normal bc it becomes diff response values)
gofstat(list(fit.gamma, fit.weibull, fit.ln), fitnames = c("Gamma", "Weibull", "Log Normal"))
# log normal best fit 
```

Leverage plots and detecting outliers
```{r}
# Plot level data
# UMBS State-only model
fit_plot_state_umbs <- lm(log(avg_pc) ~ state, data = umbs_comp_plot)
outlierTest(fit_plot_state_umbs) # no outliers
qqPlot(fit_plot_state_umbs, main="QQ Plot") 
hist(fit_plot_state_umbs$residuals)
leveragePlots(fit_plot_state_umbs)
ols_test_normality(fit_plot_state_umbs) # looks ok 

# UMBS State and year model
fit_plot_stateyear_umbs <- lm(log(avg_pc) ~ state + year_factor, data = umbs_comp_plot)
outlierTest(fit_plot_stateyear_umbs) # no outliers 
qqPlot(fit_plot_stateyear_umbs, main="QQ Plot") 
hist(fit_plot_stateyear_umbs$residuals)
leveragePlots(fit_plot_stateyear_umbs)
ols_test_normality(fit_plot_stateyear_umbs) 

# Interaction plot - see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(log(avg_pc) ~ state * year, data = umbs_comp_plot)
interact_plot(fit3, pred = year, modx = state) 
```

Mixed Effects Model
```{r}
# UMBS PLOT LEVEL
modfullu <- lmer(log(avg_pc) ~ state*insecticide*year_factor + (1|plot), umbs_comp_plot, REML = FALSE)

# Check Assumptions:
# (1) Linearity: if covariates are not categorical (year isn't)
# (2) Homogeneity: Need to Check by plotting residuals vs predicted values.
plot(modfullu)
# Check for homogeneity of variances (true if p>0.05). If the result is not significant, the assumption of equal variances (homoscedasticity) is met (no significant difference between the group variances).
# *****Leveneâ€™s Test - tests whether or not the variance among two or more groups is equal - If the p-value is less than our chosen significance level, we can reject the null hypothesis and conclude that we have enough evidence to state that the variance among the groups is not equal (which we want).

leveneTest(residuals(modfullu) ~ umbs_comp_plot$state)
# Assumption met
umbs_comp_plot$insecticide <- as.factor(umbs_comp_plot$insecticide)
leveneTest(residuals(modfullu) ~ umbs_comp_plot$insecticide) 
# Assumption met
umbs_comp_plot$plot <- as.factor(umbs_comp_plot$plot)
leveneTest(residuals(modfullu) ~ umbs_comp_plot$plot)
# Assumption met

# (3) Normality of error term: need to check by histogram, QQplot of residuals, could do Kolmogorov-Smirnov test.
# Check for normal residuals
qqPlot(resid(modfullu))
hist(residuals(modfullu))
shapiro.test(resid(modfullu)) #normally distributed resids bc p>0.05
outlierTest(modfullu) # no outliers
```

```{r}
#Our hypothesized model is:
mod_u_full <- lmer(log(avg_pc) ~ state * insecticide * as.factor(year_factor) + (1|plot), umbs_comp_plot, REML=FALSE)
summary(mod_u_full)
anova(mod_u_full)

# making a table
kable(anova(mod_u_full), digits = 2) %>% kableExtra::kable_styling()

# adding in our temp data into some models
# note: including state, year, and temp data into a model leads to rank deficiency
# so below, we test for green-up as a function of just temp to see how real temp data affects green-up
umbs_comp_plot_amb <- umbs_comp_plot %>%
        filter(state == "ambient")
modtest1u <- lmer(log(avg_pc) ~ mean_temp + (1|plot), umbs_comp_plot_amb, REML=FALSE)
modtest2u <- lmer(log(avg_pc) ~ GDD_cumulative + (1|plot), umbs_comp_plot_amb, REML=FALSE)

AICtab(modtest1u,modtest2u)
anova(modtest1u)
summary(modtest1u)

r.squaredGLMM(modtest1u)

# making a table
kable(anova(modtest1u)) %>% kableExtra::kable_styling()

# calculating effect size - accounting for log transformation
exp((-1.78002) +  (0.31009)*0) # 0.1686348 
exp((-1.78002) +  (0.31009)*1) # 0.2299416
# effect:
0.2299416 - 0.1686348 # effect of warming - warmed plots had 0.0613068 more percent cover than ambient plots

# species model for supp
mod_spp_u <- lmer(cover ~ state * insecticide * as.factor(year_factor) + species + (1|plot), comp_umbs_spp, REML=FALSE)
anova(mod_spp_u)
# making a table
kable(anova(mod_spp_u), digits = 2) %>% kableExtra::kable_styling()
```

#KBS native plants
```{r}
hist(kbs_native_plot$avg_origin_pc) # slightly right skewed
qqnorm(kbs_native_plot$avg_origin_pc)
shapiro.test(kbs_native_plot$avg_origin_pc) # pvalue is < 0.05 so we reject the null hypothesis that the data is normal (aka not normally distributed) 

# Exploring distributions:
descdist(kbs_native_plot$avg_origin_pc, discrete = FALSE) # going to try log transformation
```

Leverage plots and detecting outliers
```{r}
# Plot level data
# KBS State-only model
fit_plot_state_kbs <- lm(log(avg_origin_pc) ~ state, data = kbs_native_plot)
outlierTest(fit_plot_state_kbs) 
qqPlot(fit_plot_state_kbs, main="QQ Plot") 
hist(fit_plot_state_kbs$residuals)
leveragePlots(fit_plot_state_kbs)
ols_test_normality(fit_plot_state_kbs) # looks ok besides Kolmogorov-Smirnov test

# KBS State and year model
fit_plot_stateyear_kbs <- lm(log(avg_origin_pc) ~ state + year_factor, data = kbs_native_plot)
outlierTest(fit_plot_stateyear_kbs) # no outliers 
qqPlot(fit_plot_stateyear_kbs, main="QQ Plot") 
hist(fit_plot_stateyear_kbs$residuals)
leveragePlots(fit_plot_stateyear_kbs)
ols_test_normality(fit_plot_stateyear_kbs) # a couple tests say not normal 

# Interaction plot (ignore for now the repeated measures with species); see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(log(avg_origin_pc) ~ state * year, data = kbs_native_plot)
interact_plot(fit3, pred = year, modx = state)
```

Mixed Effects Model
```{r}
# KBS PLOT LEVEL
mod_native_k <- lmer(log(avg_origin_pc) ~ state*insecticide*year_factor + (1|plot), kbs_native_plot, REML = FALSE)

# Check Assumptions:
# (1) Linearity: if covariates are not categorical (year isn't)
# (2) Homogeneity: Need to Check by plotting residuals vs predicted values.
plot(mod_native_k)

# Check for homogeneity of variances (true if p>0.05). If the result is not significant, the assumption of equal variances (homoscedasticity) is met (no significant difference between the group variances).
# *****Leveneâ€™s Test - tests whether or not the variance among two or more groups is equal - If the p-value is less than our chosen significance level, we can reject the null hypothesis and conclude that we have enough evidence to state that the variance among the groups is not equal (which we want).

leveneTest(residuals(mod_native_k) ~ kbs_native_plot$state)
# Assumption met
kbs_native_plot$insecticide <- as.factor(kbs_native_plot$insecticide)
leveneTest(residuals(mod_native_k) ~ kbs_native_plot$insecticide) 
# Assumption met
kbs_native_plot$plot <- as.factor(kbs_native_plot$plot)
leveneTest(residuals(mod_native_k) ~ kbs_native_plot$plot)
# Assumption met

# (3) Normality of error term: need to check by histogram, QQplot of residuals, could do Kolmogorov-Smirnov test.
# Check for normal residuals
qqPlot(resid(mod_native_k))
hist(residuals(mod_native_k))
shapiro.test(resid(mod_native_k)) # normally distributed resids bc p>0.05
outlierTest(mod_native_k) # no outliers
```

```{r}
# testing if year as continuous or year as a factor makes more sense (test models)
year.mod.test1 <- lmer(log(avg_origin_pc) ~ state + year + (1|plot), kbs_native_plot, REML=FALSE)
year.mod.test2 <- lmer(log(avg_origin_pc) ~ state + as.factor(year_factor) + (1|plot), kbs_native_plot, REML=FALSE)
anova(year.mod.test1, year.mod.test2) #year.mod.test2

#Our hypothesized model 
mod_native_k <- lmer(log(avg_origin_pc) ~ state * insecticide * as.factor(year_factor) + (1|plot), kbs_native_plot, REML=FALSE) #hypothesized model
summary(mod_native_k)
anova(mod_native_k)

# comparisons
contrast.k <- contrast(emmeans(mod_native_k, ~state*year_factor), "pairwise", simple = "each", combine = F, adjust = "mvt", type = "response")

result = as.data.frame(contrast.k)

result <- result %>%
mutate_if(is.numeric, round, digits=2)

# table
kable(result) %>% kableExtra::kable_styling()

# calculating effect size - accounting for log transformation
exp((2.926657) +  (-0.66037)*0) # 18.66513 
exp((2.926657) +  (-0.66037)*1) # 9.643528
# effect:
9.643528 - 18.66513 # effect of warming in 2021 - 9% more native species percent cover than ambient plots

# species model for supp
mod_spp_kn <- lmer(cover ~ state * insecticide * as.factor(year_factor) + species  + (1|plot), comp_kbs_native_spp, REML=FALSE)
anova(mod_spp_kn)
# making a table
kable(anova(mod_spp_kn), digits = 2) %>% kableExtra::kable_styling()
```

#KBS Exotic plants
```{r}
hist(kbs_exotic_plot$avg_origin_pc) # right skewed
qqnorm(kbs_exotic_plot$avg_origin_pc)
shapiro.test(kbs_exotic_plot$avg_origin_pc) # pvalue is < 0.05 so we reject the null hypothesis that the data is normal (aka not normally distributed) 

# Exploring distributions:
descdist(kbs_exotic_plot$avg_origin_pc, discrete = FALSE) # pretty close to normal, will try log transformation
```

Leverage plots and detecting outliers
```{r}
# Plot level data
# KBS State-only model
fit_plot_state_kbs <- lm(log(avg_origin_pc) ~ state, data = kbs_exotic_plot)
outlierTest(fit_plot_state_kbs) 
qqPlot(fit_plot_state_kbs, main="QQ Plot") 
hist(fit_plot_state_kbs$residuals)
leveragePlots(fit_plot_state_kbs)
ols_test_normality(fit_plot_state_kbs) # looks ok besides Kolmogorov-Smirnov test

# KBS State and year model
fit_plot_stateyear_kbs <- lm(log(avg_origin_pc) ~ state + year_factor, data = kbs_exotic_plot)
outlierTest(fit_plot_stateyear_kbs) # no outliers 
qqPlot(fit_plot_stateyear_kbs, main="QQ Plot") 
hist(fit_plot_stateyear_kbs$residuals)
leveragePlots(fit_plot_stateyear_kbs)
ols_test_normality(fit_plot_stateyear_kbs) # a couple tests say not normal 

# Interaction plot (ignore for now the repeated measures with species); see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(log(avg_origin_pc) ~ state * year, data = kbs_exotic_plot)
interact_plot(fit3, pred = year, modx = state)
```

Mixed Effects Model
```{r}
# KBS PLOT LEVEL
mod_exotic_k <- lmer(log(avg_origin_pc) ~ state*insecticide*year_factor + (1|plot), kbs_exotic_plot, REML = FALSE)

# Check Assumptions:
# (1) Linearity: if covariates are not categorical (year isn't)
# (2) Homogeneity: Need to Check by plotting residuals vs predicted values.
plot(mod_exotic_k)

# Check for homogeneity of variances (true if p>0.05). If the result is not significant, the assumption of equal variances (homoscedasticity) is met (no significant difference between the group variances).
# *****Leveneâ€™s Test - tests whether or not the variance among two or more groups is equal - If the p-value is less than our chosen significance level, we can reject the null hypothesis and conclude that we have enough evidence to state that the variance among the groups is not equal (which we want).

leveneTest(residuals(mod_exotic_k) ~ kbs_exotic_plot$state)
# Assumption met
kbs_exotic_plot$insecticide <- as.factor(kbs_exotic_plot$insecticide)
leveneTest(residuals(mod_exotic_k) ~ kbs_exotic_plot$insecticide) 
# Assumption met
kbs_exotic_plot$plot <- as.factor(kbs_exotic_plot$plot)
leveneTest(residuals(mod_exotic_k) ~ kbs_exotic_plot$plot)
# Assumption met

# (3) Normality of error term: need to check by histogram, QQplot of residuals, could do Kolmogorov-Smirnov test.
# Check for normal residuals
qqPlot(resid(mod_exotic_k))
hist(residuals(mod_exotic_k))
shapiro.test(resid(mod_exotic_k)) # normally distributed resids bc p>0.05
outlierTest(mod_exotic_k) # no outliers
```

```{r}
# testing if year as continuous or year as a factor makes more sense (test models)
year.mod.test1 <- lmer(log(avg_origin_pc) ~ state + year + (1|plot), kbs_exotic_plot, REML=FALSE)
year.mod.test2 <- lmer(log(avg_origin_pc) ~ state + as.factor(year_factor) + (1|plot), kbs_exotic_plot, REML=FALSE)
anova(year.mod.test1, year.mod.test2) #year.mod.test2

#Our hypothesized model 
mod_exotic_k <- lmer(log(avg_origin_pc) ~ state * insecticide * as.factor(year_factor) + (1|plot), kbs_exotic_plot, REML=FALSE) #hypothesized model
summary(mod_exotic_k)
anova(mod_exotic_k)

# calculating effect size of warming - accounting for log transformation
exp((1.66121) +  (-0.07345)*0) # 5.265678 
exp((1.66121) +  (-0.07345)*1) # 4.892777
# effect:
4.892777 - 5.265678 # effect of warming - warmed plots had -0.372901 or .37% less exotic species percent cover than ambient plots

# comparison 1
contrast1 <- contrast(emmeans(mod_exotic_k, ~state*year_factor), "pairwise", simple = "each", combine = F, adjust = "mvt", type="response")
# 2018
(0.364 - 1) *100 # 64% increase in warmed plots
# 2019 
(0.252 - 1) *100 # 75% increase in warmed plots
# 2020
(0.280 - 1) *100 # 72%

result1 = as.data.frame(contrast1)

result1 <- result1 %>%
mutate_if(is.numeric, round, digits=2)

# table
kable(result1) %>% kableExtra::kable_styling()

# comparison 2
contrast2 <- contrast(emmeans(mod_exotic_k, ~insecticide*year_factor), "pairwise", simple = "each", combine = F, adjust = "mvt", type = "response")

result2 = as.data.frame(contrast2)

result2 <- result2 %>%
mutate_if(is.numeric, round, digits=2)

# table
kable(result2) %>% kableExtra::kable_styling()

# comparison 3
contrast3 <- contrast(emmeans(mod_exotic_k, ~state*insecticide*year_factor), "pairwise", simple = "each", combine = F, adjust = "mvt")

result3 = as.data.frame(contrast3)

result3 <- result3 %>%
mutate_if(is.numeric, round, digits=2)

# table
kable(result3) %>% kableExtra::kable_styling()

# species model for supp
mod_spp_ke <- lmer(cover ~ state * insecticide + species + as.factor(year_factor) + (1|plot), comp_kbs_exotic_spp, REML=FALSE)
anova(mod_spp_ke)
# making a table
kable(anova(mod_spp_ke), digits = 2) %>% kableExtra::kable_styling()
```

#UMBS native plants
```{r}
hist(umbs_native_plot$avg_origin_pc) # right skewed
qqnorm(umbs_native_plot$avg_origin_pc)
shapiro.test(umbs_native_plot$avg_origin_pc) # pvalue is < 0.05 so we reject the null hypothesis that the data is normal (aka not normally distributed) 

# Exploring distributions:
descdist(umbs_native_plot$avg_origin_pc, discrete = FALSE) # going to try log transformation
```

Leverage plots and detecting outliers
```{r}
# Plot level data
# UMBS State-only model
fit_plot_state_umbs <- lm(log(avg_origin_pc) ~ state, data = umbs_native_plot)
outlierTest(fit_plot_state_umbs) # no outliers
qqPlot(fit_plot_state_umbs, main="QQ Plot") 
hist(fit_plot_state_umbs$residuals)
leveragePlots(fit_plot_state_umbs)
ols_test_normality(fit_plot_state_umbs) # looks ok besides Kolmogorov-Smirnov test

# UMBS State and year model
fit_plot_stateyear_umbs <- lm(log(avg_origin_pc) ~ state + year_factor, data = umbs_native_plot)
outlierTest(fit_plot_stateyear_umbs) # no outliers 
qqPlot(fit_plot_stateyear_umbs, main="QQ Plot") 
hist(fit_plot_stateyear_umbs$residuals)
leveragePlots(fit_plot_stateyear_umbs)
ols_test_normality(fit_plot_stateyear_umbs) # a couple tests say not normal 

# Interaction plot (ignore for now the repeated measures with species); see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(log(avg_origin_pc) ~ state * year, data = umbs_native_plot)
interact_plot(fit3, pred = year, modx = state)
```

Mixed Effects Model
```{r}
# UMBS PLOT LEVEL
mod_native_u <- lmer(log(avg_origin_pc) ~ state*insecticide*year_factor + (1|plot), umbs_native_plot, REML = FALSE)

# Check Assumptions:
# (1) Linearity: if covariates are not categorical (year isn't)
# (2) Homogeneity: Need to Check by plotting residuals vs predicted values.
plot(mod_native_u)

# Check for homogeneity of variances (true if p>0.05). If the result is not significant, the assumption of equal variances (homoscedasticity) is met (no significant difference between the group variances).
# *****Leveneâ€™s Test - tests whether or not the variance among two or more groups is equal - If the p-value is less than our chosen significance level, we can reject the null hypothesis and conclude that we have enough evidence to state that the variance among the groups is not equal (which we want).

leveneTest(residuals(mod_native_u) ~ umbs_native_plot$state)
# Assumption met
umbs_native_plot$insecticide <- as.factor(umbs_native_plot$insecticide)
leveneTest(residuals(mod_native_u) ~ umbs_native_plot$insecticide) 
# Assumption met
umbs_native_plot$plot <- as.factor(umbs_native_plot$plot)
leveneTest(residuals(mod_native_u) ~ umbs_native_plot$plot)
# Assumption met

# (3) Normality of error term: need to check by histogram, QQplot of residuals, could do Kolmogorov-Smirnov test.
# Check for normal residuals
qqPlot(resid(mod_native_u))
hist(residuals(mod_native_u))
shapiro.test(resid(mod_native_u)) # normally distributed resids bc p>0.05
outlierTest(mod_native_u) # no outliers
```

```{r}
# testing if year as continuous or year as a factor makes more sense (test models)
year.mod.test1 <- lmer(log(avg_origin_pc) ~ state + year + (1|plot), umbs_native_plot, REML=FALSE)
year.mod.test2 <- lmer(log(avg_origin_pc) ~ state + as.factor(year_factor) + (1|plot), umbs_native_plot, REML=FALSE)
anova(year.mod.test1, year.mod.test2) #year.mod.test2

#Our hypothesized model 
mod_native_u <- lmer(log(avg_origin_pc) ~ state * insecticide * as.factor(year_factor) + (1|plot), umbs_native_plot, REML=FALSE) #hypothesized model
summary(mod_native_u)
anova(mod_native_u)

# making a table
kable(anova(mod_native_u), digits = 2) %>% kableExtra::kable_styling()

# species model for supp
mod_spp_un <- lmer(cover ~ state * insecticide * as.factor(year_factor) + species + (1|plot), comp_umbs_native_spp, REML=FALSE)
anova(mod_spp_un)
# making a table
kable(anova(mod_spp_un), digits = 2) %>% kableExtra::kable_styling()
```

#UMBS Exotic plants
```{r}
hist(umbs_exotic_plot$avg_origin_pc) # right skewed
qqnorm(umbs_exotic_plot$avg_origin_pc)
shapiro.test(umbs_exotic_plot$avg_origin_pc) # pvalue is < 0.05 so we reject the null hypothesis that the data is normal (aka not normally distributed) 

# Exploring distributions:
descdist(umbs_exotic_plot$avg_origin_pc, discrete = FALSE) # pretty close to normal, will try log transformation
```

Leverage plots and detecting outliers
```{r}
# Plot level data
# UMBS State-only model
fit_plot_state_umbs <- lm(log(avg_origin_pc) ~ state, data = umbs_exotic_plot)
outlierTest(fit_plot_state_umbs) # no outliers
qqPlot(fit_plot_state_umbs, main="QQ Plot") 
hist(fit_plot_state_umbs$residuals)
leveragePlots(fit_plot_state_umbs)
ols_test_normality(fit_plot_state_umbs) # looks ok besides Kolmogorov-Smirnov test

# UMBS State and year model
fit_plot_stateyear_umbs <- lm(log(avg_origin_pc) ~ state + year_factor, data = umbs_exotic_plot)
outlierTest(fit_plot_stateyear_umbs) # no outliers 
qqPlot(fit_plot_stateyear_umbs, main="QQ Plot") 
hist(fit_plot_stateyear_umbs$residuals)
leveragePlots(fit_plot_stateyear_umbs)
ols_test_normality(fit_plot_stateyear_umbs) # a couple tests say not normal 

# Interaction plot (ignore for now the repeated measures with species); see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(log(avg_origin_pc) ~ state * year, data = umbs_exotic_plot)
interact_plot(fit3, pred = year, modx = state) # this looks very strange to me
```

Mixed Effects Model
```{r}
# UMBS PLOT LEVEL
mod_exotic_u <- lmer(log(avg_origin_pc) ~ state*insecticide*year_factor + (1|plot), umbs_exotic_plot, REML = FALSE)

# Check Assumptions:
# (1) Linearity: if covariates are not categorical (year isn't)
# (2) Homogeneity: Need to Check by plotting residuals vs predicted values.
plot(mod_exotic_u)

# Check for homogeneity of variances (true if p>0.05). If the result is not significant, the assumption of equal variances (homoscedasticity) is met (no significant difference between the group variances).
# *****Leveneâ€™s Test - tests whether or not the variance among two or more groups is equal - If the p-value is less than our chosen significance level, we can reject the null hypothesis and conclude that we have enough evidence to state that the variance among the groups is not equal (which we want).

leveneTest(residuals(mod_exotic_u) ~ umbs_exotic_plot$state)
# Assumption met
umbs_exotic_plot$insecticide <- as.factor(umbs_exotic_plot$insecticide)
leveneTest(residuals(mod_exotic_u) ~ umbs_exotic_plot$insecticide) 
# Assumption met
umbs_exotic_plot$plot <- as.factor(umbs_exotic_plot$plot)
leveneTest(residuals(mod_exotic_u) ~ umbs_exotic_plot$plot)
# Assumption met

# (3) Normality of error term: need to check by histogram, QQplot of residuals, could do Kolmogorov-Smirnov test.
# Check for normal residuals
qqPlot(resid(mod_exotic_u))
hist(residuals(mod_exotic_u))
shapiro.test(resid(mod_exotic_u)) # normally distributed resids bc p>0.05
outlierTest(mod_exotic_u) # no outliers
```

```{r}
# testing if year as continuous or year as a factor makes more sense (test models)
year.mod.test1 <- lmer(log(avg_origin_pc) ~ state + year + (1|plot), umbs_exotic_plot, REML=FALSE)
year.mod.test2 <- lmer(log(avg_origin_pc) ~ state + as.factor(year_factor) + (1|plot), umbs_exotic_plot, REML=FALSE)
anova(year.mod.test1, year.mod.test2) #year.mod.test2

#Our hypothesized model 
mod_exotic_u <- lmer(log(avg_origin_pc) ~ state * insecticide * as.factor(year_factor) + (1|plot), umbs_exotic_plot, REML=FALSE) #hypothesized model
summary(mod_exotic_u)
anova(mod_exotic_u)

# comparison 3
contrast3 <- contrast(emmeans(mod_exotic_u, ~state*insecticide*year_factor), "pairwise", simple = "each", combine = F, adjust = "mvt")

result3 = as.data.frame(contrast3)

result3 <- result3 %>%
mutate_if(is.numeric, round, digits=2)

# table
kable(result3) %>% kableExtra::kable_styling()

# species model for supp
mod_spp_ue <- lmer(cover ~ state * insecticide * as.factor(year_factor) + species + (1|plot), comp_umbs_exotic_spp, REML=FALSE)
anova(mod_spp_ue)
# making a table
kable(anova(mod_spp_ue), digits = 2) %>% kableExtra::kable_styling()
```

#KBS forbs
```{r}
hist(kbs_forb_plot$avg_growth_pc) # slightly right skewed
qqnorm(kbs_forb_plot$avg_growth_pc)
shapiro.test(kbs_forb_plot$avg_growth_pc) # pvalue is < 0.05 so we reject the null hypothesis that the data is normal (aka not normally distributed) 

# Exploring distributions:
descdist(kbs_forb_plot$avg_growth_pc, discrete = FALSE) # going to try log transformation
```

Leverage plots and detecting outliers
```{r}
# Plot level data
# KBS State-only model
fit_plot_state_kbs <- lm(log(avg_growth_pc) ~ state, data = kbs_forb_plot)
outlierTest(fit_plot_state_kbs) 
qqPlot(fit_plot_state_kbs, main="QQ Plot") 
hist(fit_plot_state_kbs$residuals)
leveragePlots(fit_plot_state_kbs)
ols_test_normality(fit_plot_state_kbs) # looks ok besides Kolmogorov-Smirnov test

# KBS State and year model
fit_plot_stateyear_kbs <- lm(log(avg_growth_pc) ~ state + year_factor, data = kbs_forb_plot)
outlierTest(fit_plot_stateyear_kbs) # no outliers 
qqPlot(fit_plot_stateyear_kbs, main="QQ Plot") 
hist(fit_plot_stateyear_kbs$residuals)
leveragePlots(fit_plot_stateyear_kbs)
ols_test_normality(fit_plot_stateyear_kbs) # a couple tests say not normal 

# Interaction plot (ignore for now the repeated measures with species); see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(log(avg_growth_pc) ~ state * year, data = kbs_forb_plot)
interact_plot(fit3, pred = year, modx = state) # this looks very strange to me
```

Mixed Effects Model
```{r}
# KBS PLOT LEVEL
mod_forb_k <- lmer(log(avg_growth_pc) ~ state*insecticide*year_factor + (1|plot), kbs_forb_plot, REML = FALSE)

# Check Assumptions:
# (1) Linearity: if covariates are not categorical (year isn't)
# (2) Homogeneity: Need to Check by plotting residuals vs predicted values.
plot(mod_forb_k)

# Check for homogeneity of variances (true if p>0.05). If the result is not significant, the assumption of equal variances (homoscedasticity) is met (no significant difference between the group variances).
# *****Leveneâ€™s Test - tests whether or not the variance among two or more groups is equal - If the p-value is less than our chosen significance level, we can reject the null hypothesis and conclude that we have enough evidence to state that the variance among the groups is not equal (which we want).

leveneTest(residuals(mod_forb_k) ~ kbs_forb_plot$state)
# Assumption met
kbs_forb_plot$insecticide <- as.factor(kbs_forb_plot$insecticide)
leveneTest(residuals(mod_forb_k) ~ kbs_forb_plot$insecticide) 
# Assumption met
kbs_forb_plot$plot <- as.factor(kbs_forb_plot$plot)
leveneTest(residuals(mod_forb_k) ~ kbs_forb_plot$plot)
# Assumption met

# (3) Normality of error term: need to check by histogram, QQplot of residuals, could do Kolmogorov-Smirnov test.
# Check for normal residuals
qqPlot(resid(mod_forb_k))
hist(residuals(mod_forb_k))
shapiro.test(resid(mod_forb_k)) # normally distributed resids bc p>0.05
outlierTest(mod_forb_k) # no outliers
```

```{r}
# testing if year as continuous or year as a factor makes more sense (test models)
year.mod.test1 <- lmer(log(avg_growth_pc) ~ state + year + (1|plot), kbs_forb_plot, REML=FALSE)
year.mod.test2 <- lmer(log(avg_growth_pc) ~ state + as.factor(year_factor) + (1|plot), kbs_forb_plot, REML=FALSE)
anova(year.mod.test1, year.mod.test2) #year.mod.test2

#Our hypothesized model 
mod_forb_k <- lmer(log(avg_growth_pc) ~ state * insecticide * as.factor(year_factor) + (1|plot), kbs_forb_plot, REML=FALSE) #hypothesized model
summary(mod_forb_k)
anova(mod_forb_k)

kable(anova(mod_forb_k)) %>% kableExtra::kable_styling()

# comparison
contrast <- contrast(emmeans(mod_forb_k, ~state*year_factor), "pairwise", simple = "each", combine = F, adjust = "mvt")

result = as.data.frame(contrast)

result <- result %>%
mutate_if(is.numeric, round)

# table
kable(result) %>% kableExtra::kable_styling()

## calculating effect size - accounting for log transformation
exp(2.45884 + (0.18695)*0) # 11.69124 
exp(2.45884 + (0.18695)*1) # 14.09458
## effect:
14.09458 - 11.69124 # effect of warming - forbs in warmed plots had 2.40334 more percent cover than ambient plots

# species model for supp
mod_spp_kf <- lmer(cover ~ state * insecticide * as.factor(year_factor) + species + (1|plot), comp_kbs_forb_spp, REML=FALSE)
anova(mod_spp_kf)
# making a table
kable(anova(mod_spp_kf), digits = 2) %>% kableExtra::kable_styling()
```

#KBS graminoids
```{r}
hist(kbs_graminoid_plot$avg_growth_pc) # right skewed
qqnorm(kbs_graminoid_plot$avg_growth_pc)
shapiro.test(kbs_graminoid_plot$avg_growth_pc) # pvalue is < 0.05 so we reject the null hypothesis that the data is normal (aka not normally distributed) 

# Exploring distributions:
descdist(kbs_graminoid_plot$avg_growth_pc, discrete = FALSE) # going to try log transformation
```

Leverage plots and detecting outliers
```{r}
# Plot level data
# KBS State-only model
fit_plot_state_kbs <- lm(log(avg_growth_pc) ~ state, data = kbs_graminoid_plot)
outlierTest(fit_plot_state_kbs) 
qqPlot(fit_plot_state_kbs, main="QQ Plot") 
hist(fit_plot_state_kbs$residuals)
leveragePlots(fit_plot_state_kbs)
ols_test_normality(fit_plot_state_kbs) # looks ok besides Kolmogorov-Smirnov test

# KBS State and year model
fit_plot_stateyear_kbs <- lm(log(avg_growth_pc) ~ state + year_factor, data = kbs_graminoid_plot)
outlierTest(fit_plot_stateyear_kbs) # no outliers 
qqPlot(fit_plot_stateyear_kbs, main="QQ Plot") 
hist(fit_plot_stateyear_kbs$residuals)
leveragePlots(fit_plot_stateyear_kbs)
ols_test_normality(fit_plot_stateyear_kbs) # a couple tests say not normal 

# Interaction plot (ignore for now the repeated measures with species); see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(log(avg_growth_pc) ~ state * year, data = kbs_graminoid_plot)
interact_plot(fit3, pred = year, modx = state)
```

Mixed Effects Model
```{r}
# KBS PLOT LEVEL
mod_graminoid_k <- lmer(log(avg_growth_pc) ~ state*insecticide*year_factor + (1|plot), kbs_graminoid_plot, REML = FALSE)

# Check Assumptions:
# (1) Linearity: if covariates are not categorical (year isn't)
# (2) Homogeneity: Need to Check by plotting residuals vs predicted values.
plot(mod_graminoid_k)

# Check for homogeneity of variances (true if p>0.05). If the result is not significant, the assumption of equal variances (homoscedasticity) is met (no significant difference between the group variances).
# *****Leveneâ€™s Test - tests whether or not the variance among two or more groups is equal - If the p-value is less than our chosen significance level, we can reject the null hypothesis and conclude that we have enough evidence to state that the variance among the groups is not equal (which we want).

leveneTest(residuals(mod_graminoid_k) ~ kbs_graminoid_plot$state)
# Assumption met
kbs_graminoid_plot$insecticide <- as.factor(kbs_graminoid_plot$insecticide)
leveneTest(residuals(mod_graminoid_k) ~ kbs_graminoid_plot$insecticide) 
# Assumption met
kbs_graminoid_plot$plot <- as.factor(kbs_graminoid_plot$plot)
leveneTest(residuals(mod_graminoid_k) ~ kbs_graminoid_plot$plot)
# Assumption met

# (3) Normality of error term: need to check by histogram, QQplot of residuals, could do Kolmogorov-Smirnov test.
# Check for normal residuals
qqPlot(resid(mod_graminoid_k))
hist(residuals(mod_graminoid_k))
shapiro.test(resid(mod_graminoid_k)) # normally distributed resids bc p>0.05
outlierTest(mod_graminoid_k) # no outliers
```

```{r}
# testing if year as continuous or year as a factor makes more sense (test models)
year.mod.test1 <- lmer(log(avg_growth_pc) ~ state + year + (1|plot), kbs_graminoid_plot, REML=FALSE)
year.mod.test2 <- lmer(log(avg_growth_pc) ~ state + as.factor(year_factor) + (1|plot), kbs_graminoid_plot, REML=FALSE)
anova(year.mod.test1, year.mod.test2) #year.mod.test2

#Our hypothesized model 
mod_graminoid_k <- lmer(log(avg_growth_pc) ~ state * insecticide * as.factor(year_factor) + (1|plot), kbs_graminoid_plot, REML=FALSE) #hypothesized model
summary(mod_graminoid_k)
anova(mod_graminoid_k)

# comparison 1
contrast1 <- contrast(emmeans(mod_graminoid_k, ~state*year_factor), "pairwise", simple = "each", combine = F, adjust = "mvt")

result1 = as.data.frame(contrast1)

result1 <- result1 %>%
mutate_if(is.numeric, round, digits=2)

# table
kable(result1) %>% kableExtra::kable_styling()

# comparison 2
contrast2 <- contrast(emmeans(mod_graminoid_k, ~state*insecticide*year_factor), "pairwise", simple = "each", combine = F, adjust = "mvt")

result2 = as.data.frame(contrast2)

result2 <- result2 %>%
mutate_if(is.numeric, round, digits=2)

# table
kable(result2) %>% kableExtra::kable_styling()

# species model for supp
mod_spp_kg <- lmer(cover ~ state * insecticide * as.factor(year_factor) + species + (1|plot), comp_kbs_graminoid_spp, REML=FALSE)
anova(mod_spp_kg)
# making a table
kable(anova(mod_spp_kg), digits = 2) %>% kableExtra::kable_styling()
```

#UMBS forbs
```{r}
hist(umbs_forb_plot$avg_growth_pc) # slightly right skewed
qqnorm(umbs_forb_plot$avg_growth_pc)
shapiro.test(umbs_forb_plot$avg_growth_pc) # pvalue is < 0.05 so we reject the null hypothesis that the data is normal (aka not normally distributed) 

# Exploring distributions:
descdist(umbs_forb_plot$avg_growth_pc, discrete = FALSE) # going to try log transformation
```

Leverage plots and detecting outliers
```{r}
# Plot level data
# UMBS State-only model
fit_plot_state_umbs <- lm(log(avg_growth_pc) ~ state, data = umbs_forb_plot)
outlierTest(fit_plot_state_umbs) # outliers lines 344 and 356
qqPlot(fit_plot_state_umbs, main="QQ Plot") 
hist(fit_plot_state_umbs$residuals)
leveragePlots(fit_plot_state_umbs)
ols_test_normality(fit_plot_state_umbs) # looks ok besides Kolmogorov-Smirnov test

# UMBS State and year model
fit_plot_stateyear_umbs <- lm(log(avg_growth_pc) ~ state + year_factor, data = umbs_forb_plot)
outlierTest(fit_plot_stateyear_umbs) # no outliers 
qqPlot(fit_plot_stateyear_umbs, main="QQ Plot") 
hist(fit_plot_stateyear_umbs$residuals)
leveragePlots(fit_plot_stateyear_umbs)
ols_test_normality(fit_plot_stateyear_umbs) # a couple tests say not normal 

# Interaction plot (ignore for now the repeated measures with species); see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(log(avg_growth_pc) ~ state * year, data = umbs_forb_plot)
qqPlot(fit3, main="QQ Plot") 
outlierTest(fit3) # no outliers 
interact_plot(fit3, pred = year, modx = state)

# remove outliers, lines 344 and 356
umbs_forb_plot_nooutlier <- umbs_forb_plot[!rownames(umbs_forb_plot) == '344', ]
umbs_forb_plot_nooutlier <- umbs_forb_plot_nooutlier[!rownames(umbs_forb_plot_nooutlier) == '356', ]
# KBS State-only model
fit_plot_state_umbs <- lm(log(avg_growth_pc) ~ state*year_factor, data = umbs_forb_plot_nooutlier)
outlierTest(fit_plot_state_umbs) # no outliers
qqPlot(fit_plot_state_umbs, main="QQ Plot") 
hist(fit_plot_state_umbs$residuals)
leveragePlots(fit_plot_state_umbs)
ols_test_normality(fit_plot_state_umbs)
```

Mixed Effects Model
```{r}
# UMBS PLOT LEVEL
mod_forb_u <- lmer(log(avg_growth_pc) ~ state*insecticide*year_factor + (1|plot), umbs_forb_plot_nooutlier, REML = FALSE)

# Check Assumptions:
# (1) Linearity: if covariates are not categorical (year isn't)
# (2) Homogeneity: Need to Check by plotting residuals vs predicted values.
plot(mod_forb_u)

# Check for homogeneity of variances (true if p>0.05). If the result is not significant, the assumption of equal variances (homoscedasticity) is met (no significant difference between the group variances).
# *****Leveneâ€™s Test - tests whether or not the variance among two or more groups is equal - If the p-value is less than our chosen significance level, we can reject the null hypothesis and conclude that we have enough evidence to state that the variance among the groups is not equal (which we want).

leveneTest(residuals(mod_forb_u) ~ umbs_forb_plot_nooutlier$state)
# Assumption met
umbs_forb_plot_nooutlier$insecticide <- as.factor(umbs_forb_plot_nooutlier$insecticide)
leveneTest(residuals(mod_forb_u) ~ umbs_forb_plot_nooutlier$insecticide) 
# Assumption met
umbs_forb_plot_nooutlier$plot <- as.factor(umbs_forb_plot_nooutlier$plot)
leveneTest(residuals(mod_forb_u) ~ umbs_forb_plot_nooutlier$plot)
# Assumption met

# (3) Normality of error term: need to check by histogram, QQplot of residuals, could do Kolmogorov-Smirnov test.
# Check for normal residuals
qqPlot(resid(mod_forb_u))
hist(residuals(mod_forb_u))
shapiro.test(resid(mod_forb_u)) # normally distributed resids bc p>0.05
outlierTest(mod_forb_u) # no outliers
```

```{r}
# testing if year as continuous or year as a factor makes more sense (test models)
year.mod.test1 <- lmer(log(avg_growth_pc) ~ state + year + (1|plot), umbs_forb_plot_nooutlier, REML=FALSE)
year.mod.test2 <- lmer(log(avg_growth_pc) ~ state + as.factor(year_factor) + (1|plot), umbs_forb_plot_nooutlier, REML=FALSE)
anova(year.mod.test1, year.mod.test2) #year.mod.test2

#Our hypothesized model 
mod_forb_u <- lmer(log(avg_growth_pc) ~ state * insecticide * as.factor(year_factor) + (1|plot), umbs_forb_plot_nooutlier, REML=FALSE) #hypothesized model
summary(mod_forb_u)
anova(mod_forb_u)

# making a table
kable(anova(mod_forb_u), digits = 2) %>% kableExtra::kable_styling()

# species model for supp
mod_spp_uf <- lmer(cover ~ state * insecticide + species + as.factor(year_factor) + (1|plot), comp_umbs_forb_spp, REML=FALSE)
anova(mod_spp_uf)
# making a table
kable(anova(mod_spp_uf)) %>% kableExtra::kable_styling()
```

#UMBS graminoids
```{r}
hist(umbs_graminoid_plot$avg_growth_pc) # right skewed
qqnorm(umbs_graminoid_plot$avg_growth_pc)
shapiro.test(umbs_graminoid_plot$avg_growth_pc) # pvalue is < 0.05 so we reject the null hypothesis that the data is normal (aka not normally distributed) 

# Exploring distributions:
descdist(umbs_graminoid_plot$avg_growth_pc, discrete = FALSE) # going to try log transformation
```

Leverage plots and detecting outliers
```{r}
# Plot level data
# UMBS State-only model
fit_plot_state_umbs <- lm(log(avg_growth_pc) ~ state, data = umbs_graminoid_plot)
outlierTest(fit_plot_state_umbs) 
qqPlot(fit_plot_state_umbs, main="QQ Plot") 
hist(fit_plot_state_umbs$residuals)
leveragePlots(fit_plot_state_umbs)
ols_test_normality(fit_plot_state_umbs) # looks ok besides Kolmogorov-Smirnov test

# UMBS State and year model
fit_plot_stateyear_umbs <- lm(log(avg_growth_pc) ~ state + year_factor, data = umbs_graminoid_plot)
outlierTest(fit_plot_stateyear_umbs) # no outliers 
qqPlot(fit_plot_stateyear_umbs, main="QQ Plot") 
hist(fit_plot_stateyear_umbs$residuals)
leveragePlots(fit_plot_stateyear_umbs)
ols_test_normality(fit_plot_stateyear_umbs) # a couple tests say not normal 

# Interaction plot (ignore for now the repeated measures with species); see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(log(avg_growth_pc) ~ state * year, data = umbs_graminoid_plot)
interact_plot(fit3, pred = year, modx = state)
```

Mixed Effects Model
```{r}
# UMBS PLOT LEVEL
mod_graminoid_u <- lmer(log(avg_growth_pc) ~ state*insecticide*year_factor + (1|plot), umbs_graminoid_plot, REML = FALSE)

# Check Assumptions:
# (1) Linearity: if covariates are not categorical (year isn't)
# (2) Homogeneity: Need to Check by plotting residuals vs predicted values.
plot(mod_graminoid_u)

# Check for homogeneity of variances (true if p>0.05). If the result is not significant, the assumption of equal variances (homoscedasticity) is met (no significant difference between the group variances).
# *****Leveneâ€™s Test - tests whether or not the variance among two or more groups is equal - If the p-value is less than our chosen significance level, we can reject the null hypothesis and conclude that we have enough evidence to state that the variance among the groups is not equal (which we want).

leveneTest(residuals(mod_graminoid_u) ~ umbs_graminoid_plot$state)
# Assumption met
umbs_graminoid_plot$insecticide <- as.factor(umbs_graminoid_plot$insecticide)
leveneTest(residuals(mod_graminoid_u) ~ umbs_graminoid_plot$insecticide) 
# Assumption met
umbs_graminoid_plot$plot <- as.factor(umbs_graminoid_plot$plot)
leveneTest(residuals(mod_graminoid_u) ~ umbs_graminoid_plot$plot)
# Assumption met

# (3) Normality of error term: need to check by histogram, QQplot of residuals, could do Kolmogorov-Smirnov test.
# Check for normal residuals
qqPlot(resid(mod_graminoid_u))
hist(residuals(mod_graminoid_u))
shapiro.test(resid(mod_graminoid_u)) # normally distributed resids bc p>0.05
outlierTest(mod_graminoid_u) # no outliers
```

```{r}
# testing if year as continuous or year as a factor makes more sense (test models)
year.mod.test1 <- lmer(log(avg_growth_pc) ~ state + year + (1|plot), umbs_graminoid_plot, REML=FALSE)
year.mod.test2 <- lmer(log(avg_growth_pc) ~ state + as.factor(year_factor) + (1|plot), umbs_graminoid_plot, REML=FALSE)
anova(year.mod.test1, year.mod.test2) #year.mod.test2

#Our hypothesized model 
mod_graminoid_u <- lmer(log(avg_growth_pc) ~ state * insecticide * as.factor(year_factor) + (1|plot), umbs_graminoid_plot, REML=FALSE) #hypothesized model
summary(mod_graminoid_u)
anova(mod_graminoid_u)

# comparisons
emmeans(mod_graminoid_u, list(pairwise ~ state*insecticide), adjust = "tukey")
mod_graminoid_u.emm <- emmeans(mod_graminoid_u, ~ state*insecticide)
contrast(mod_graminoid_u.emm, "consec", simple = "each", combine = F, adjust = "mvt")
emmip(mod_graminoid_u, insecticide~state)

# making a table
kable(anova(mod_graminoid_u), digits = 2) %>% kableExtra::kable_styling()

# species model for supp
mod_spp_ug <- lmer(cover ~ state * insecticide * as.factor(year_factor) + species + (1|plot), comp_umbs_graminoid_spp, REML=FALSE)
anova(mod_spp_ug)
# making a table
kable(anova(mod_spp_ug), digits = 2) %>% kableExtra::kable_styling()
```

Sum of 2021 cover measurements - Table S1
```{r}
# Read in data
comp_spp <- read.csv(file.path(L1_dir, "plant_composition/final_plantcomp_L1.csv"))

comp_spp <- comp_spp %>%
        filter(year == 2021 & state == "ambient") %>%
        filter(!(cover == "<1"))
comp_spp$cover <- as.numeric(comp_spp$cover)

avg_comp <- comp_spp %>%
        group_by(site, species) %>%
        summarize(totalsum = sum(cover))
```







#KBS and UMBS models not used in manuscript

KBS Plot-level Mixed Effects Models
```{r}
#Our hypothesized model is  mod9p
mod9p <- lmer(log(avg_pc) ~ state * insecticide + as.factor(year_factor) + (1|plot), kbs_comp_plot, REML=FALSE) #hypothesized model
summary(mod9p)
anova(mod9p)

# making a table
kable(anova(mod9p)) %>% kableExtra::kable_styling()

# calculating effect size - accounting for log transformation
exp((2.717016) +  (0.182115)*0) # 15.13509 
exp((2.717016) +  (0.182115)*1) # 18.15836
# effect:
18.15836 - 15.13509 # effect of warming - warmed plots had 3.02327 or 3.02327% more percent cover than ambient plots
```

UMBS Plot-level Mixed Effects Models
```{r}
#Our hypothesized model is  mod9p
mod9pu <- lmer(log(avg_pc) ~ state * insecticide + as.factor(year_factor) + (1|plot), umbs_comp_plot, REML=FALSE)
summary(mod9pu)
anova(mod9pu)

# making a table
kable(anova(mod9pu)) %>% kableExtra::kable_styling()
```


```{r}
# KBS plot-level
# plot-level models 
modfull <- lmer(log(avg_pc) ~ state*as.factor(year_factor) + insecticide*year_factor + (1|plot), kbs_comp_plot, REML=F)
mod1p <- lmer(log(avg_pc) ~ state + (1|plot), kbs_comp_plot, REML=FALSE)
mod2p <- lmer(log(avg_pc) ~ insecticide + (1|plot), kbs_comp_plot, REML=FALSE)
mod3p <- lmer(log(avg_pc) ~ insecticide + state + (1|plot), kbs_comp_plot, REML=FALSE)
mod4p <- lmer(log(avg_pc) ~ insecticide * state + (1|plot), kbs_comp_plot, REML=FALSE)
mod5p <- lmer(log(avg_pc) ~ state + as.factor(year_factor) + (1|plot), kbs_comp_plot, REML=FALSE)
mod6p <- lmer(log(avg_pc) ~ state + as.factor(year_factor) + insecticide + (1|plot), kbs_comp_plot, REML=FALSE)
mod7p <- lmer(log(avg_pc) ~ state * as.factor(year_factor) + (1|plot), kbs_comp_plot, REML=FALSE)
mod8p <- lmer(log(avg_pc) ~ state * as.factor(year_factor) + insecticide + (1|plot), kbs_comp_plot, REML=FALSE)
mod9p <- lmer(log(avg_pc) ~ state * insecticide + as.factor(year_factor) + (1|plot), kbs_comp_plot, REML=FALSE) #hypothesized model
mod10p <- lmer(log(avg_pc) ~ state + insecticide * as.factor(year_factor) + (1|plot), kbs_comp_plot, REML=FALSE)
mod11p <- lmer(log(avg_pc) ~ state * as.factor(year_factor) * insecticide + (1|plot), kbs_comp_plot, REML=FALSE)

AICtab(modfull, mod1p, mod2p, mod3p, mod4p, mod5p, mod6p, mod7p, mod8p, mod9p, mod10p, mod11p, weights=T)
anova(mod5p, mod6p)

AICctab(mod5p, mod6p, weights=T) # 5p
summ(mod5p)
summary(mod5p)
anova(mod5p)
emmeans(mod5p, list(pairwise ~ state + year_factor), adjust = "tukey")
emmeans(mod5p, list(pairwise ~ state), adjust = "tukey")

# comparisons
emmeans(mod9p, list(pairwise ~ state*insecticide), adjust = "tukey")
mod9p.emm <- emmeans(mod9p, ~ state*insecticide)
contrast(mod9p.emm, "consec", simple = "each", combine = F, adjust = "mvt")
emmip(mod9p, insecticide~state)

##############################################################
# UMBS plot-level
# plot-level models 
modfullu <- lmer(log(avg_pc) ~ state*as.factor(year_factor) + insecticide*year_factor + (1|plot), umbs_comp_plot, REML=F)
mod1pu <- lmer(log(avg_pc) ~ state + (1|plot), umbs_comp_plot, REML=FALSE)
mod2pu <- lmer(log(avg_pc) ~ insecticide + (1|plot), umbs_comp_plot, REML=FALSE)
mod3pu <- lmer(log(avg_pc) ~ insecticide + state + (1|plot), umbs_comp_plot, REML=FALSE)
mod4pu <- lmer(log(avg_pc) ~ insecticide * state + (1|plot), umbs_comp_plot, REML=FALSE)
mod5pu <- lmer(log(avg_pc) ~ state + as.factor(year_factor) + (1|plot), umbs_comp_plot, REML=FALSE)
mod6pu <- lmer(log(avg_pc) ~ state + as.factor(year_factor) + insecticide + (1|plot), umbs_comp_plot, REML=FALSE)
mod7pu <- lmer(log(avg_pc) ~ state * as.factor(year_factor) + (1|plot), umbs_comp_plot, REML=FALSE)
mod8pu <- lmer(log(avg_pc) ~ state * as.factor(year_factor) + insecticide + (1|plot), umbs_comp_plot, REML=FALSE)
mod9pu <- lmer(log(avg_pc) ~ state * insecticide + as.factor(year_factor) + (1|plot), umbs_comp_plot, REML=FALSE)
mod10pu <- lmer(log(avg_pc) ~ state + insecticide * as.factor(year_factor) + (1|plot), umbs_comp_plot, REML=FALSE)
mod11pu <- lmer(log(avg_pc) ~ state * as.factor(year_factor) * insecticide + (1|plot), umbs_comp_plot, REML=FALSE)
AICtab(modfullu, mod1pu, mod2pu, mod3pu, mod4pu, mod5pu, mod6pu, mod7pu, mod8pu, mod9pu, mod10pu, mod11pu, weights=T)
anova(mod5pu, mod6pu)
AICctab(mod5pu, mod6pu, weights=T) # 5p
summ(mod5pu)
summary(mod5pu)
anova(mod5pu)
emmeans(mod5pu, list(pairwise ~ state + as.factor(year_factor)), adjust = "tukey")

# comparisons
emmeans(mod9pu, list(pairwise ~ state*insecticide), adjust = "tukey")
mod9pu.emm <- emmeans(mod9pu, ~ state*insecticide)
contrast(mod9pu.emm, "consec", simple = "each", combine = F, adjust = "mvt")
emmip(mod9pu, insecticide~state)
```


---
title: "warmXtrophic Project: Plant Composition Data Analyses"
author: "Kara Dobson, Moriah Young"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=80),tidy=TRUE)
```

Main questions (for now): how does plant composition differ between native & exotic species over time? In general, how does relative % cover change over time btwn each treatment?

# Load in packages & data
```{r, message = F}
# Clear all existing data
rm(list=ls())

#Load packages
library(tidyverse)
library(ggplot2)
library(lme4)
library(olsrr)
library(predictmeans)
library(car)
library(fitdistrplus)
library(ggpubr)
library(rstatix)
library(vegan)
library(interactions)
library(sjPlot)
library(effects)
library(glmmTMB)
library(labdsv) # used with Vegan package, the matrify() and matrify2() functions
library(agricolae) # HSD.test() function

# Set working directory
Sys.getenv("L1DIR")
L0_dir <- Sys.getenv("L0DIR")
L1_dir <- Sys.getenv("L1DIR")
L2_dir <- Sys.getenv("L2DIR")
list.files(L1_dir)

# read in plant comp data
comp <- read.csv(file.path(L1_dir, "plant_composition/final_plantcomp_L1.csv"))
comp <- comp %>% select(-X) # get rid of "X" column that shows up

# read in meta data
meta <- read.csv(file.path(L0_dir, "plot.csv"))
```


```{r}
# adding sequential year variable starting at 1: this is because the years (e.g. 2015, 2016, etc) are large numbers compared with other values in the dataset. We can always label axes with these real years.
comp$year_factor[comp$year == 2015] <- 1
comp$year_factor[comp$year == 2016] <- 2
comp$year_factor[comp$year == 2017] <- 3
comp$year_factor[comp$year == 2018] <- 4
comp$year_factor[comp$year == 2019] <- 5
comp$year_factor[comp$year == 2020] <- 6

# Remove non-plant data
comp <- comp[!(comp$species=="Bare_Ground" | 
                       comp$species=="Unknown" | 
                       comp$species=="Brown" | 
                       comp$species=="Litter" | 
                       comp$species=="Vert_Litter" | 
                       comp$species=="Animal_Disturbance"), ]
```

Setting up dataframe for diversity indices
```{r}
# Getting data in wide format to work in Vegan package

# attempt 1
comp1 <- comp %>%
        select(plot, species, cover, year, site)
comp1$concatenated <- paste(comp1$site, ".", comp1$plot, ".", comp1$year)
comp1 <- comp1 %>% 
        select(concatenated, species, cover)
comp1_wide <- matrify(comp1)


# attempt 2
#comp1 <- comp %>% 
#        select(plot, species, cover, year, site)
#
#comp_kbs <- subset(comp1, site == "kbs")
#comp_kbs <- comp_kbs %>% 
#        select(plot, species, cover, year)
#
#comp_umbs <- subset(comp1, site == "umbs")
#comp_umbs <- comp_umbs %>% 
#        select(plot, species, cover, year)
#
## https://stackoverflow.com/questions/50691393/transform-community-data-into-wide-format-for-vegan-package
#matrify2 <-  function(data) { 
#   #Data must have columns: plot, SPEC, abundance measure,Year 
#   if (ncol(data) != 4) 
#       stop("data frame must have four column format")
#   plt <- factor(data[, 1]) 
#   spc <- factor(data[, 2])
#   abu <- data[, 3]
#   yrs <- factor(data[, 4])
#   plt.codes <- sort(levels(factor(plt)))##object with sorted plot numbers
#   spc.codes <- levels(factor(spc))##object with sorted SPEC names
#   yrs.codes <- sort(levels(factor(yrs)))##object with sorted sampling Years
#   taxa <- matrix(0, nrow = length(plt.codes)*length(yrs.codes), ncol = length(spc.codes))##Create empty matrix with #proper dimensions (unique(plotxYear) by # of SPEC)
#   plt.list <- rep(plt.codes,length(yrs.codes))##Create a list of all the plot numbers (in order of input data) to add #as an ID column at end of function
#   yrs.list <- rep(yrs.codes,each=length(plt.codes))##Create a list of all the Year numbers (in order of input data) to #add as an ID column at end of function
#   col <- match(spc, spc.codes)##object that determines the alphabetical order ranking of each SPEC in the spc.code #list
#   row.plt <- match(plt, plt.codes)##object that determines the rank order ranking of each plot of the input data in #the plt.code list
#   row.yrs <- match(yrs,yrs.codes)##object that determines the rank order ranking of each Year of the input data in the #yrs.code list
#   for (i in 1:length(abu)) {
#       row <- (row.plt[i])+length(plt.codes)*(row.yrs[i]-1)##Determine row number by assuming each row represents a #specific plot & year in an object of rep(plot,each=Year)
#       if(!is.na(abu[i])) {##ONly use value if !is.na .. [ignore all is.NA values]
#         taxa[row, col[i]] <- sum(taxa[row, col[i]], abu[i])##Add abundance measure of row i to the proper SPEC column #and plot/Year row. Sum across all identical individuals.
#       }
#   }
#   taxa <- data.frame(taxa)##Convert to data.frame for easier manipulation
#   taxa <- cbind(plt.list,yrs.list,taxa)##Add ID columns for plot and Year to each row already representing the #abundance of Each SPEC of that given plot/Year.
#   names(taxa) <- c('Plot','Year',spc.codes)
#   taxa
#}
#
#comp_wide_kbs <- matrify2(comp_kbs)
#comp_wide_umbs <- matrify2(comp_umbs)
```

Calculating Diversity Indices
```{r}
# species richness
sppr <- specnumber(comp1_wide)

sppr_aov <- aov(sppr ~ state, data = meta)
summary(sppr_aov)
```

Calculating Absolute Abundance
```{r}
# calculating total composition sums - proxy for most common species
comp_yearly_totals <- comp %>%
        group_by(site, year, plot, species) %>%
        summarize(comp_sum = sum(cover, na.rm = T))

```
Calculating Relative Abundance
```{r}
comp1 <- comp %>% 
        select(species, site, year, plot, cover, state, insecticide, growth_habit, origin)
# calculate plot cover mean by species-plot per year
plot_mean <- aggregate(cover ~ plot*species*year*site*state*insecticide*growth_habit*origin, data = comp1, FUN = mean, na.rm = T)
names(plot_mean)[names(plot_mean) == "cover"] <- "plot_mean" # change "cover" column name to "plot_mean"
View(plot_mean)

# convert cover to relative abundance 
# first get summed cover for all plants per plot
plot_cover_total = aggregate(plot_mean ~ plot*year*site*state*insecticide*growth_habit*origin, data = plot_mean, FUN = sum, na.rm = T)
names(plot_cover_total)[names(plot_cover_total) == "plot_mean"] <- "plot_cover_total"
View(plot_cover_total)
comp2 <- merge(plot_mean, plot_cover_total, by = c("plot","year","site", "state", "insecticide", "growth_habit", "origin"))

#calculate relative percent cover per species in each quadrat (="relative abundance")
comp2$relabun <- comp2$plot_mean/comp2$plot_cover_total
summary(comp2)

# create dataframes for kbs and umbs - remember that these contain species within plots
comp_kbs <- subset(comp2, site == "kbs")
comp_umbs <- subset(comp2, site == "umbs")
```


Relative Abundance for comparisons between native and exotic species
```{r}
# getting relative % cover for comparisons between native & exotic 
# most code from Kileigh's old script
# average sub-quadrats for plots - MY: what are sub quadrats? Just plots?
comp_org <- subset(comp, origin == "Exotic" | origin == "Native")
plot_mean_org <- aggregate(cover ~ plot*origin*species*year*site*state, data = comp_org, FUN = mean, na.rm = T)
names(plot_mean_org)[names(plot_mean_org)=="cover"]<-"plot_mean_org"
head(plot_mean_org)

# convert cover to relative abundance 
# first get summed cover for all plants per plot
cover_sum = aggregate(plot_mean_org ~ plot*origin*year*site*state, data = plot_mean_org, FUN = sum, na.rm = T)
names(cover_sum)[names(cover_sum) == "plot_mean_org"] <- "cover_sum"
head(cover_sum)
comp2 <- merge(plot_mean_org, cover_sum, by = c("plot","origin","year","site", "state"))

#calculate relative percent cover per species in each quadrat (="relative abundance")
comp2$relabun <- comp2$plot_mean_org/comp2$cover_sum
summary(comp2)

# create dataframes for kbs and umbs - remember that these contain species within plots
comp_org_kbs <- subset(comp2, site == "kbs")
comp_org_umbs <- subset(comp2, site == "umbs")
```

```{r}
# https://rfunctions.blogspot.com/2016/08/comparing-and-estimating-species.html

# rarefired species richness
#rarecurve(comp2$species)

#specpool(comp2)
```


```{r}
# checking for normality in raw data
hist(log(comp_kbs$relabun))
qqnorm(log(comp_kbs$relabun))
shapiro.test(log(comp_kbs$relabun))

hist(comp_kbs$relabun[comp_kbs$state == "ambient"])
hist(comp_kbs$relabun[comp_kbs$state == "warmed"])
```



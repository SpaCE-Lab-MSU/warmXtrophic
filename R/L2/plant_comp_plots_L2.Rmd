---
title: "Plant Comp Plots"
author: "Kara Dobson, Moriah"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: pdf_document
---

COLLABORATORS: Phoebe Zarnetske, Mark Hammond, Pat Bills 
DATA INPUT: Clean & plot plant comp csv from the shared Google drive  
DATA OUTPUT: Code and Rmd are in the scripts folder in Github  
PROJECT: warmXtrophic 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=F}
# Clear all existing data
rm(list=ls())

# Load packages
library(tidyverse)
library(plotrix)
library(ggpubr)

# Set working directory
Sys.getenv("L0DIR")
L0_dir <- Sys.getenv("L0DIR")
L1_dir <- Sys.getenv("L1DIR")
L2_dir <- Sys.getenv("L2DIR")

# Read in plant comp data and meta-data
comp <- read.csv(file.path(L1_dir, "plant_composition/final_plantcomp_L1.csv"))
meta <- read.csv(file.path(L0_dir, "plot.csv"))
taxon <- read.csv(file.path(L0_dir,"taxon.csv"))
str(comp)

comp$X <- NULL # remove uneeded X column
str(comp)

# adding sequential year variable starting at 1: this is because the years (e.g. 2015, 2016, etc) are large numbers compared with other values in the dataset. We can always label axes with these real years.
comp$year_factor[comp$year == 2015] <- 1
comp$year_factor[comp$year == 2016] <- 2
comp$year_factor[comp$year == 2017] <- 3
comp$year_factor[comp$year == 2018] <- 4
comp$year_factor[comp$year == 2019] <- 5
comp$year_factor[comp$year == 2020] <- 6

# Remove non-plant data - MY: not sure if I should remove these?
comp <- comp[!(comp$species=="Bare_Ground" | 
                       comp$species=="Unknown" | 
                       comp$species=="Brown" | 
                       comp$species=="Litter" | 
                       comp$species=="Vert_Litter" | 
                       comp$species=="Animal_Disturbance"), ]
#comp <- na.omit(comp)
```
```{r}
# subset out a date in August (one in late July) for each site to look at biomass w/o repeating measurements
comp_peak <- subset(comp, date == "2015-08-25" | date == "2015-07-28" | # first date is kbs, second is umbs
                      date == "2016-08-19" | date == "2016-08-13" |
                      date == "2017-08-02" | date == "2017-08-10" |
                      date == "2018-08-23" | date == "2018-08-09" |
                      date == "2019-08-12" | date == "2019-08-14" |
                      date == "2020-08-15" | date == "2020-08-04")

# filter data to contain the averages and std error for each site
comp_peak$species[comp_peak$species == "Litter"] <- NA
comp_peak$species[comp_peak$species == "Vert_Litter"] <- NA
sum_comp_site <- comp_peak %>%
  group_by(site, state, year) %>%
  summarize(avg_cover = mean(cover, na.rm = TRUE),
            se = std.error(cover, na.rm = TRUE))
```


```{r, echo=F, message=FALSE, warning=FALSE}
# filter data to contain the averages and std error for each site
sum_comp_site <- comp %>%
  group_by(site, state, year) %>%
  summarize(avg_cover = mean(cover, na.rm = TRUE),
            se = std.error(cover, na.rm = TRUE))

# by plant origin (native/exotic) - no grouping by year
sum_comp_org <- comp %>%
  group_by(site, state, origin) %>%
  summarize(avg_comp = mean(cover, na.rm = TRUE),
            se = std.error(cover, na.rm = TRUE))
sum_comp_org <- subset(sum_comp_org, origin == "Exotic" | origin == "Native")

# by plant origin (native/exotic) - grouped by year
sum_compyear_org <- comp %>%
  group_by(site, state, origin, year) %>%
  summarize(avg_comp = mean(cover, na.rm = TRUE),
            se = std.error(cover, na.rm = TRUE))
sum_compyear_org <- subset(sum_compyear_org, origin == "Exotic" | origin == "Native")

# by plant growth habit (forb, graminoid, shrub) - no grouping by year
sum_comp_habit <- comp %>%
  group_by(site, growth_habit, state) %>%
  summarize(avg_cover = mean(cover, na.rm = TRUE),
            se = std.error(cover, na.rm = TRUE))
sum_comp_habit <- subset(sum_comp_habit, growth_habit == "Forb" | growth_habit == "Graminoid")
```

## Plot for plant cover between warmed and ambient treatments
```{r, echo = F}
# Plot for all species between warmed and ambient
comp_plot_all <- function(loc) { 
  comp_spp <- subset(sum_comp_site, site == loc)
  return(ggplot(comp_spp, aes(x = state, y = avg_cover, fill = state)) +
           facet_grid(.~year) +
           geom_bar(position = "identity", stat = "identity", color = "black") +
           geom_errorbar(aes(ymin = avg_cover - se, ymax = avg_cover + se), width = 0.2,
                         position = "identity") +
           labs(x = "State", y = "Percent Cover", title = loc) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
           theme_classic())
}
comp_plot_all("kbs")
comp_plot_all("umbs")
```

## Plot for percent cover between native/exotic for warmed and ambient
```{r, echo = F}
comp_plot_org <- function(loc) { 
  comp_spp <- subset(sum_comp_org, site == loc)
  return(ggplot(comp_spp, aes(x = origin, y = avg_comp, fill = state)) +
           #facet_grid(.~year) +
           geom_bar(position = "dodge", stat = "identity", color = "black") +
           geom_errorbar(aes(ymin = avg_comp - se, ymax = avg_comp + se), width = 0.2,
                         position = position_dodge(0.9)) +
           labs(x = "State", y = "Percent Cover", title = loc) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
           theme_classic())
}
comp_plot_org("kbs")
comp_plot_org("umbs")
```

## Plot for percent cover between native/exotic for warmed and ambient, separated by year
```{r, echo = F}
compyear_plot_org <- function(loc) { 
  comp_spp <- subset(sum_compyear_org, site == loc)
  return(ggplot(comp_spp, aes(x = origin, y = avg_comp, fill = state)) +
           facet_grid(.~year) +
           geom_bar(position = "dodge", stat = "identity", color = "black") +
           geom_errorbar(aes(ymin = avg_comp - se, ymax = avg_comp + se), width = 0.2,
                         position = position_dodge(0.9)) +
           labs(x = "State", y = "Percent Cover", title = loc) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           scale_x_discrete(labels=c("Exotic" = "E", "Native" = "N")) +
           theme_classic())
}
compyear_plot_org("kbs")
compyear_plot_org("umbs")
```

## Plot for percent cover between forb/graminoid for warmed and ambient
```{r, echo = F}
comp_plot_habit <- function(loc) { 
  comp_spp <- subset(sum_comp_habit, site == loc)
  return(ggplot(comp_spp, aes(x = growth_habit, y = avg_cover, fill = state)) +
           #facet_grid(.~year) +
           geom_bar(position = "dodge", stat = "identity", color = "black") +
           geom_errorbar(aes(ymin = avg_cover - se, ymax = avg_cover + se), width = 0.2,
                         position = position_dodge(0.9)) +
           labs(x = "State", y = "Percent Cover", title = loc) +
           scale_fill_manual(values = c("#a6bddb", "#fb6a4a")) +
           theme_classic())
}
comp_plot_habit("kbs")
comp_plot_habit("umbs")  
```

```{r}
site_df <- data.frame(site = comp$site, plot_id =  comp$plot, species = as.character(comp$species), 
                      year = comp$year, stringsAsFactors = FALSE )

# set of unique species per plot
species_sets <- aggregate(species ~ site + plot_id + year, site_df, function(x) unique(x))

# cardinality  of unique species per plot
species_cardinalities <- aggregate(species ~ site + plot_id + year, site_df, function(x) length(unique(x)))

# smush together 
species_summary <- merge(species_sets,species_cardinalities, by.x = c("site", "plot_id", "year"),by.y  = c("site", "plot_id", "year"))

# rename the columns 
names(species_summary) <- c("site", "plot_id", "year", "species_list", "species_cardinality")

View(species_summary)

# The "species_list" column is a list of lists. To get a vector of unique species for all plots for that 
# whole year do:
unique(unlist(species_summary$species_list))

# to get just one of those you need to use double brackets, other wise you get a list with one element, 
# and that element is the list of species. for example to get a vector of species on row four, use
species_summary[4,]$species_list[[1]]

```


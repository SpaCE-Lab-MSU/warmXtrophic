---
title: "Plant Comp Plots"
author: "Moriah Young"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

COLLABORATORS: Kara Dobson, Phoebe Zarnetske, Mark Hammond, Pat Bills 
DATA INPUT: Clean & plot plant comp csv from the shared Google drive  
DATA OUTPUT: Code and Rmd are in the scripts folder in Github  
PROJECT: warmXtrophic 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=F}
# Clear all existing data
rm(list=ls())

# Load packages
library(tidyverse)
library(plotrix)
library(ggpubr)

# Set working directory
Sys.getenv("L0DIR")
L0_dir <- Sys.getenv("L0DIR")
L1_dir <- Sys.getenv("L1DIR")
L2_dir <- Sys.getenv("L2DIR")

# Read in plant comp data and meta-data
comp <- read.csv(file.path(L2_dir, "plant_composition/final_plant_comp_plot_L2.csv"))
growth <- read.csv(file.path(L2_dir, "plant_composition/final_plant_comp_growth_habit_plot_L2.csv"))
origin <- read.csv(file.path(L2_dir, "plant_composition/final_plant_comp_origin_plot_L2.csv"))
```

Set ggplot2 plotting
```{r}
# This code for ggplot2 sets the theme to mostly black and white 
# (Arial font, and large font, base size=24)
#theme_set(theme_bw(14))
#theme_update(axis.text.x = element_text(size = 12, angle = 90),
#             axis.text.y = element_text(size = 12))

# making site names capital for cleaner plots
change_site <- function(df){
        df$site[df$site == "umbs"] <- "UMBS"
        df$site[df$site == "kbs"] <- "KBS"
        return(df)
}
comp <- change_site(comp)
growth <- change_site(growth)
origin <- change_site(origin)

# creating a vector with cleaned up insecticide labels for plotting
insect_labels <- c("insects" = "Herbivory", "no_insects" = "Reduced Herbivory")
```

Averages + std error for plot level data + insecticide treatment across all years
```{r}
sum_comp_plot_i <- comp %>%
        group_by(site, state, insecticide) %>%
        summarize(avg_relabun = mean(avg_relative_abundance, na.rm = TRUE),
                  se = std.error(avg_relative_abundance, na.rm = TRUE))

sum_origin_plot_i <- origin %>%
        group_by(site, state, insecticide, origin) %>%
        summarize(avg_relabun = mean(avg_relative_abundance, na.rm = TRUE),
                  se = std.error(avg_relative_abundance, na.rm = TRUE))

sum_growth_plot_i <- growth %>%
        group_by(site, state, insecticide, growth_habit) %>%
        summarize(avg_relabun = mean(avg_relative_abundance, na.rm = TRUE),
                  se = std.error(avg_relative_abundance, na.rm = TRUE))
```

Dot plot with insecticide
```{r}
# plant composition
sum_comp_plot_i$full_treat <- paste(sum_comp_plot_i$state, sum_comp_plot_i$insecticide, sep="_")
comp_dot_i <- function(loc) { 
       comp_plot <- subset(sum_comp_plot_i, site == loc)
        return(ggplot(comp_plot, aes(x = state, y = avg_relabun, fill=insecticide)) +
                       #geom_point(stat = "identity",position=position_dodge(0.2),size=5) +
                       geom_pointrange(aes(ymin=avg_relabun-se, ymax=avg_relabun+se), pch=21,size=1,position=position_dodge(0.3)) +
                       #scale_shape_manual(name="Treatment",
                       #                   values = c(1, 19),
                       #                   labels=c("Herbivory","Reduced Herbivory")) +
                       scale_fill_manual(name="Treatment",
                                         values = c("#FFB451", "#0b0055"),
                                         labels=c("Herbivory","Reduced Herbivory")) +
                               labs(x = NULL, y = NULL, title = loc) +
                       scale_x_discrete(labels=c("ambient" = "Ambient", "warmed" = "Warmed")) +
                       coord_cartesian(ylim=c(0.10,0.25)) +
                       theme_bw(14))
}
comp_dot_i_kbs <- comp_dot_i("KBS")
comp_dot_i_kbs <- comp_dot_i_kbs + theme(plot.title = element_text(size=20),
                                     axis.text.y = element_text(size=14),
                                     axis.title.y = element_text(size=14),
                                     legend.text = element_text(size=14),
                                     legend.title = element_text(size=14))
comp_dot_i_umbs <- comp_dot_i("UMBS")
comp_dot_i_umbs <- comp_dot_i_umbs + labs(y=NULL) + theme(axis.title.y=element_blank(),
                                                      plot.title = element_text(size=20),
                                                      axis.text.y = element_blank(),
                                                      legend.text = element_text(size=14),
                                                      legend.title = element_text(size=14))

comp_all_dot_i <- ggpubr::ggarrange(comp_dot_i_kbs, comp_dot_i_umbs,
                                nrow = 1, ncol = 2, common.legend = T, legend="right",
                                widths = c(1.1, 0.9))
png("relative_abundance_plots_L2_all_plant_comp_dot_insect.png", units="in", width=8, height=6, res=300)
annotate_figure(comp_all_dot_i,
                left = text_grob("Relative Abundance", color = "black", rot = 90, size=17))
dev.off()
```

Origin
```{r}
# origin
sum_origin_plot_i$full_treat <- paste(sum_origin_plot_i$state, sum_origin_plot_i$insecticide, sep="_")
origin_dot_i <- function(loc) { 
       origin_plot <- subset(sum_origin_plot_i, site == loc)
        return(ggplot(origin_plot, aes(x = state, y = avg_relabun, color=insecticide, shape=origin)) +
                       #geom_point(stat = "identity",position=position_dodge(0.2),size=5) +
                       geom_pointrange(aes(ymin=avg_relabun-se, ymax=avg_relabun+se),size=1,position=position_dodge(0.3)) +
                       scale_shape_manual(name="Origin",
                                          values = c(1, 19),
                                          labels=c("Exotic","Native")) +
                       scale_color_manual(name="Treatment",
                                         values = c("#FFB451", "#0b0055"),
                                         labels=c("Herbivory","Reduced Herbivory")) +
                               labs(x = NULL, y = "Origin", title = loc) +
                       scale_x_discrete(labels=c("ambient" = "Ambient", "warmed" = "Warmed")) +
                       coord_cartesian(ylim=c(0.1,0.7)) +
                       theme_bw(14))
}
origin_dot_i_kbs <- origin_dot_i("KBS")
origin_dot_i_kbs
origin_dot_i_kbs <- origin_dot_i_kbs + theme(plot.title = element_text(size=20),
                                     axis.text.y = element_text(size=14),
                                     axis.title.y = element_text(size=14),
                                     legend.text = element_text(size=14),
                                     legend.title = element_text(size=14))
origin_dot_i_umbs <- origin_dot_i("UMBS")
origin_dot_i_umbs <- origin_dot_i_umbs + labs(y=NULL) + theme(axis.title.y=element_blank(),
                                                      plot.title = element_text(size=20),
                                                      axis.text.y = element_blank(),
                                                      legend.text = element_text(size=14),
                                                      legend.title = element_text(size=14))

comp_origin_dot_i <- ggpubr::ggarrange(origin_dot_i_kbs, origin_dot_i_umbs,
                                nrow = 1, ncol = 2, common.legend = T, legend="right",
                                widths = c(1.1, 0.9))
png("relative_abundance_plots_L2_origin_dot_insect.png", units="in", width=9, height=6, res=300)
annotate_figure(comp_origin_dot_i,
                left = text_grob("Relative Abundance", color = "black", rot = 90, size=17))
dev.off()
```

Growth Habit
```{r}
# growth
sum_growth_plot_i$full_treat <- paste(sum_growth_plot_i$state, sum_growth_plot_i$insecticide, sep="_")
growth_dot_i <- function(loc) { 
       origin_plot <- subset(sum_growth_plot_i, site == loc)
        return(ggplot(origin_plot, aes(x = state, y = avg_relabun, color=insecticide, shape=growth_habit)) +
                       #geom_point(stat = "identity",position=position_dodge(0.2),size=5) +
                       geom_pointrange(aes(ymin=avg_relabun-se, ymax=avg_relabun+se),size=1,position=position_dodge(0.3)) +
                       scale_shape_manual(name="Growth Habit",
                                          values = c(1, 19),
                                          labels=c("Forb","Graminoid")) +
                       scale_color_manual(name="Treatment",
                                         values = c("#FFB451", "#0b0055"),
                                         labels=c("Herbivory","Reduced Herbivory")) +
                               labs(x = NULL, y = "Growth Habit", title = loc) +
                       scale_x_discrete(labels=c("ambient" = "Ambient", "warmed" = "Warmed")) +
                       coord_cartesian(ylim=c(0.2,0.7)) +
                       theme_bw(14))
}
growth_dot_i_kbs <- growth_dot_i("KBS")
growth_dot_i_kbs
growth_dot_i_kbs <- growth_dot_i_kbs + theme(plot.title = element_text(size=20),
                                     axis.text.y = element_text(size=14),
                                     axis.title.y = element_text(size=14),
                                     legend.text = element_text(size=14),
                                     legend.title = element_text(size=14))
growth_dot_i_umbs <- growth_dot_i("UMBS")
growth_dot_i_umbs <- growth_dot_i_umbs + labs(y=NULL) + theme(axis.title.y=element_blank(),
                                                      plot.title = element_text(size=20),
                                                      axis.text.y = element_blank(),
                                                      legend.text = element_text(size=14),
                                                      legend.title = element_text(size=14))

comp_growth_dot_i <- ggpubr::ggarrange(growth_dot_i_kbs, growth_dot_i_umbs,
                                nrow = 1, ncol = 2, common.legend = T, legend="right",
                                widths = c(1.1, 0.9))
png("relative_abundance_plots_L2_growth_dot_insect.png", units="in", width=8, height=6, res=300)
annotate_figure(comp_growth_dot_i,
                left = text_grob("Relative Abundance", color = "black", rot = 90, size=17))
dev.off()
```


For the supplemental document - line graph by site and year (need to work on)
```{r}
# filter the data to contain the mean and std error for relabun of each site
relabun_avg <- comp %>%
  group_by(site, state, year) %>%
  summarize(avg_relabun = mean(avg_relative_abundance, na.rm = TRUE),
            se = std.error(avg_relative_abundance, na.rm = TRUE))

# filter the data to contain the mean and std error for relabun of each site for origin
origin_relabun_avg <- origin %>%
  group_by(site, state, origin, year) %>%
  summarize(avg_relabun = mean(avg_relative_abundance, na.rm = TRUE),
            se = std.error(avg_relative_abundance, na.rm = TRUE))

# filter the data to contain the mean and std error for relabun of each site for growth habit
growth_relabun_avg <- growth %>%
  group_by(site, state, growth_habit, year) %>%
  summarize(avg_relabun = mean(avg_relative_abundance, na.rm = TRUE),
            se = std.error(avg_relative_abundance, na.rm = TRUE))

# adding empty values for 2021 to umbs so the x-axis matches the other plots
relabun_avg2 <- relabun_avg
de<-data.frame("UMBS", NA, "2021", NA, NA)
names(de)<-c("site","state", "year", "avg_relabun", "se")
de$year <- as.integer(de$year)
relabun_avg <- rbind(relabun_avg2, de)

origin_relabun_avg2 <- origin_relabun_avg
de<-data.frame("umbs", NA, "Native", "2021", NA, NA)
de2<-data.frame("umbs", NA, "Exotic", "2021", NA, NA)
names(de)<-c("site","state", "origin", "year", "avg_relabun", "se")
names(de2)<-c("site","state", "origin", "year", "avg_relabun", "se")
de$year <- as.integer(de$year)
de2$year <- as.integer(de2$year)
origin_relabun_avg <- rbind(origin_relabun_avg2, de, de2)

growth_relabun_avg2 <- growth_relabun_avg
de<-data.frame("umbs", NA, "Graminoid", "2021", NA, NA)
de2<-data.frame("umbs", NA, "Forb", "2021", NA, NA)
names(de)<-c("site","state", "growth_habit", "year", "avg_relabun", "se")
names(de2)<-c("site","state", "growth_habit", "year", "avg_relabun", "se")
de$year <- as.integer(de$year)
de2$year <- as.integer(de2$year)
growth_relabun_avg <- rbind(growth_relabun_avg2, de, de2)
```

General Plot Level
```{r}
plot_line <- function(loc) { 
  all_plot <- subset(relabun_avg, site == loc)
  return(ggplot(all_plot, aes(x = year, y = avg_relabun, group = state)) +
                 geom_errorbar(aes(ymin=avg_relabun-se, ymax=avg_relabun+se), position=position_dodge(0.1), width=.25) +
           geom_line(aes(color=state), size = 1) +
           geom_point(aes(color=state), size = 2) +
           scale_color_manual(values = c("#a6bddb", "#fb6a4a"), labels=c("Ambient","Warmed")) +
           labs(x = NULL, y = "Average Relative Abundance", title=loc, color="Treatment") +
           ylim(0.09, 0.35))
}

plot_line_kbs <- plot_line("KBS")
plot_line_kbs <- plot_line_kbs + labs(title="KBS", y=NULL) + theme(axis.text.x=element_blank())
plot_line_umbs <- plot_line("UMBS")
plot_line_umbs <- plot_line_umbs + labs(title="UMBS", y=NULL)

plot_line <- ggpubr::ggarrange(plot_line_kbs, plot_line_umbs,
                          nrow = 2, ncol = 1, common.legend = T, legend="bottom")
png("avg_relative_abundance_plots_by_year_L2.png", units="in", width=9, height=8, res=300)
annotate_figure(plot_line,
                left = text_grob("Average Relative Abundance", color = "black", rot = 90, size=15),
                bottom = text_grob("Year", color = "black", size=15))
dev.off()
```

Origin - Native vs. Exotic (not finished)
```{r}
native <- origin_relabun_avg[which(origin_relabun_avg$origin == "Native"),]
exotic <- origin_relabun_avg[which(origin_relabun_avg$origin == "Exotic"),]

native_line <- function(loc) { 
  native_plot <- subset(native, site == loc)
  return(ggplot(native_plot, aes(x = year, y = avg_relabun, group = state)) +
                 geom_errorbar(aes(ymin=avg_relabun-se, ymax=avg_relabun+se), position=position_dodge(0.1), width=.25) +
           geom_line(aes(color=state), size = 1) +
           geom_point(aes(color=state), size = 2) +
           scale_color_manual(values = c("#a6bddb", "#fb6a4a"), labels=c("Ambient","Warmed")) +
           labs(x = NULL, y = "Averegae Relative Abundance", title=loc, color="Treatment"))
}

native_line_kbs <- native_line("kbs")
native_line_kbs <- native_line_kbs + labs(title="KBS", subtitle= "Native", y=NULL) + theme(axis.text.x=element_blank())
native_line_umbs <- native_line("umbs")
native_line_umbs <- native_line_umbs + labs(title="UMBS", subtitle= "Native", y=NULL)

native_line <- ggpubr::ggarrange(native_line_kbs, native_line_umbs,
                          nrow = 2, ncol = 1, common.legend = T, legend="bottom")
png("native_plots_L2.png", units="in", width=9, height=8, res=300)
annotate_figure(native_line,
                left = text_grob("Average Relative Abundance", color = "black", rot = 90, size=15),
                bottom = text_grob("Year", color = "black", size=15))
dev.off()

exotic_line <- function(loc) { 
  exotic_plot <- subset(exotic, site == loc)
  return(ggplot(exotic_plot, aes(x = year, y = avg_relabun, group = state)) +
                 geom_errorbar(aes(ymin=avg_relabun-se, ymax=avg_relabun+se), position=position_dodge(0.1), width=.25) +
           geom_line(aes(color=state), size = 1) +
           geom_point(aes(color=state), size = 2) +
           scale_color_manual(values = c("#a6bddb", "#fb6a4a"), labels=c("Ambient","Warmed")) +
           labs(x = NULL, y = "Averegae Relative Abundance", title=loc, color="Treatment") +
                 ylim(0,0.75))
}

exotic_line_kbs <- exotic_line("kbs")
exotic_line_kbs <- exotic_line_kbs + labs(title="KBS", subtitle="Exotic", y=NULL) + theme(axis.text.x=element_blank())
exotic_line_umbs <- exotic_line("umbs")
exotic_line_umbs <- exotic_line_umbs + labs(title="UMBS", subtitle="Exotic", y=NULL)

origin_line <- ggpubr::ggarrange(native_line_kbs, exotic_line_kbs,
                                 native_line_umbs, exotic_line_umbs,
                          nrow = 2, ncol = 2, common.legend = T, legend="bottom")
png("origin_relative_abundance_plots_L2.png", units="in", width=9, height=8, res=300)
annotate_figure(origin_line,
                left = text_grob("Average Relative Abundance", color = "black", rot = 90, size=15),
                bottom = text_grob("Year", color = "black", size=15))
dev.off()
```

Growth Habit - Forbs vs. Graminoids (not finished)
```{r}
forb <- growth_plot_avg[which(growth_plot_avg$growth_habit == "Forb"),]
graminoid <- growth_plot_avg[which(growth_plot_avg$growth_habit == "Graminoid"),]

forb_line <- function(loc) { 
  forb_plot <- subset(forb, site == loc)
  return(ggplot(forb_plot, aes(x = year, y = avg_relabun, group = state)) +
                 geom_errorbar(aes(ymin=avg_relabun-se, ymax=avg_relabun+se), position=position_dodge(0.1), width=.25) +
           geom_line(aes(color=state), size = 1) +
           geom_point(aes(color=state), size = 2) +
           scale_color_manual(values = c("#a6bddb", "#fb6a4a"), labels=c("Ambient","Warmed")) +
           labs(x = NULL, y = "Averegae Relative Abundance", title=loc, color="Treatment") +
                 ylim(0.1,0.85))
}

forb_line_kbs <- forb_line("kbs")
forb_line_kbs <- forb_line_kbs + labs(title="KBS", subtitle= "Forb", y=NULL) + theme(axis.text.x=element_blank())
forb_line_umbs <- forb_line("umbs")
forb_line_umbs <- forb_line_umbs + labs(title="UMBS", subtitle= "Forb", y=NULL)

#forb_line <- ggpubr::ggarrange(forb_line_kbs, forb_line_umbs,
#                          nrow = 2, ncol = 1, common.legend = T, legend="bottom")
#png("forb_plots_L2.png", units="in", width=9, height=8, res=300)
#annotate_figure(forb_line,
#                left = text_grob("Average Relative Abundance", color = "black", rot = 90, size=15),
#                bottom = text_grob("Year", color = "black", size=15))
#dev.off()

graminoid_line <- function(loc) { 
  graminoid_plot <- subset(graminoid, site == loc)
  return(ggplot(graminoid_plot, aes(x = year, y = avg_relabun, group = state)) +
                 geom_errorbar(aes(ymin=avg_relabun-se, ymax=avg_relabun+se), position=position_dodge(0.1), width=.25) +
           geom_line(aes(color=state), size = 1) +
           geom_point(aes(color=state), size = 2) +
           scale_color_manual(values = c("#a6bddb", "#fb6a4a"), labels=c("Ambient","Warmed")) +
           labs(x = NULL, y = "Averegae Relative Abundance", title=loc, color="Treatment") +
                 ylim(0.1,0.85))
}

graminoid_line_kbs <- graminoid_line("kbs")
graminoid_line_kbs <- graminoid_line_kbs + labs(title="KBS", subtitle="Graminoid", y=NULL) + theme(axis.text.x=element_blank())
graminoid_line_umbs <- graminoid_line("umbs")
graminoid_line_umbs <- graminoid_line_umbs + labs(title="UMBS", subtitle="Graminoid", y=NULL)

growthhabit_line <- ggpubr::ggarrange(forb_line_kbs, graminoid_line_kbs,
                                    forb_line_umbs, graminoid_line_umbs,
                          nrow = 2, ncol = 2, common.legend = T, legend="bottom")
png("growthhabit_relative_abundance_plots_L2.png", units="in", width=9, height=8, res=300)
annotate_figure(growthhabit_line,
                left = text_grob("Average Relative Abundance", color = "black", rot = 90, size=15),
                bottom = text_grob("Year", color = "black", size=15))
dev.off()
```
Origin - Native vs. Exotic (ignore this chumk)
```{r}
origin_line <- function(loc) { 
  origin_plot <- subset(origin_plot_avg, site == loc)
  return(ggplot(origin_plot, aes(x = year, y = avg_relabun, group=interaction(state, origin))) +
                 geom_errorbar(aes(ymin=avg_relabun-se, ymax=avg_relabun+se), position=position_dodge(0.1), width=.25) +
           geom_line(aes(color=state), size = 1) +
           geom_point(aes(color=state), size = 2) +
           scale_color_manual(values = c("#a6bddb", "#fb6a4a"), labels=c("Ambient","Warmed")) +
           labs(x = NULL, y = "Averegae Relative Abundance", title=loc, color="Treatment"))
           #ylim(150,205))
}

origin_line_kbs <- origin_line("kbs")
origin_line_kbs <- origin_line_kbs + labs(title="KBS", y=NULL) + theme(axis.text.x=element_blank())
origin_line_umbs <- origin_line("umbs")
origin_line_umbs <- origin_line_umbs + labs(title="UMBS", y=NULL)

origin_line <- ggpubr::ggarrange(origin_line_kbs, origin_line_umbs,
                          nrow = 2, ncol = 1, common.legend = T, legend="bottom")

annotate_figure(origin_line,
                left = text_grob("Average Relative Abundance", color = "black", rot = 90, size=15),
                bottom = text_grob("Year", color = "black", size=15))

```

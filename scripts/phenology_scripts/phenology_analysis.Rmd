---
title: "Phenology Analysis"
author: "Moriah Young"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  pdf_document: default
---

COLLABORATORS: Phoebe Zarnetske, Mark Hammond, Pat Bills, Kara Dobson  
DATA INPUT: Cleaned phenology data csv from the shared Google drive  
DATA OUTPUT: Code and Rmd are in the scripts folder in Github  
PROJECT: warmXtrophic  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy.opts = list(width.cutoff=80), tidy=TRUE)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Clear existing data
rm(list=ls())

#Load packages
library(tidyverse)
library(lme4)
library(lmerTest)
library(emmeans)
library(vegan)
library(car)
library(rstatix)
library(scales)
library(fitdistrplus)
library(moments)# for calculating skewness of data
library(ggpubr)
library(jtools) # summ() function
library(predictmeans)

# Set working directory to Google Drive
setwd("/Volumes/GoogleDrive/Shared drives/SpaCE_Lab_warmXtrophic/data/")

# Read in data
# cleaned phenology data from L1
phen_data <- read.csv("/Volumes/GoogleDrive/Shared drives/SpaCE_Lab_warmXtrophic/data/L1/phenology/final_flw_sd_L1.csv", stringsAsFactors=FALSE)
phen_data$X <- NULL # get rid of "X" column that shows up
View(phen_data) # take a look at the data to see if looks good

# make a column that breaks down years as 1, 2, 3, 4, 5, 6 and into factors
phen_data$year_factor <- 
        ifelse(phen_data$year == 2015, "1",
               ifelse(phen_data$year == 2016, "2",
                      ifelse(phen_data$year == 2017, "3",
                             ifelse(phen_data$year == 2018, "4",
                                    ifelse(phen_data$year == 2019, "5",
                                           ifelse(phen_data$year == 2020, "6", NA))))))

# Create separate data frames for flowering and seeding
phen_flwr <- subset(phen_data, action == "flower")
phen_sd <- subset(phen_data, action == "seed")

# Separate data frame by site for flower
kbs_flwr <- subset(phen_flwr, site == "kbs")
umbs_flwr <- subset(phen_flwr, site == "umbs")

# Separate data frame by site for seed set
kbs_sd <- subset(phen_sd, site == "kbs")
umbs_sd <- subset(phen_sd, site == "umbs")

# Filter data to contain the date of first flower for each species at each plot
FirstFlower_all <- phen_flwr %>%
        group_by(plot, year, species, state, site, action, origin, insecticide, year_factor) %>%
        summarize(julian = min(julian, na.rm=T))

MedianFlwr_all <- phen_flwr %>%
        group_by(plot, year, species, state, site, action, origin, insecticide, year_factor, treatment_key) %>%
        summarize(julian = median(julian, na.rm=T))
```

## UMBS Data

First Flower
```{r}
umbs_firstflwr <- subset(FirstFlower_all, site == "umbs") # pull out umbs only data

# first flower
hist(umbs_firstflwr$julian) # poisson?
qqnorm(umbs_firstflwr$julian)
fit1 <- lm(julian ~ state, data = umbs_firstflwr)
qqPlot(fit1)
shapiro.test(umbs_firstflwr$julian) 

descdist(umbs_firstflwr$julian, discrete = FALSE) # uniform? normal?

skewness(umbs_firstflwr$julian)

umbs_firstflwr$sqrt_julian <- sqrt(umbs_firstflwr$julian)
hist(umbs_firstflwr$sqrt_julian)
skewness(umbs_firstflwr$sqrt_julian, na.rm = TRUE)
```

Median Flower 
```{r}
umbs_flwr_med <- subset(MedianFlwr_all, site == "umbs") # pull out umbs only data

hist(umbs_flwr_med$julian)
qqnorm(umbs_flwr_med$julian)
fit2 <- lm(julian ~ state, data = umbs_flwr_med)
qqPlot(fit2)
shapiro.test(umbs_flwr_med$julian)

descdist(umbs_flwr_med$julian, discrete = FALSE) # uniform?

skewness(umbs_flwr_med$julian, na.rm = TRUE)  # slight positive skew

# Because of slight positive skew I'm transforming the data by taking the square root.
umbs_flwr_med$sqrt_julian <- sqrt(umbs_flwr_med$julian) 
hist(umbs_flwr_med$sqrt_julian)
skewness(umbs_flwr_med$sqrt_julian, na.rm = TRUE)

ggdensity(umbs_flwr_med, x = "sqrt_julian", fill = "lightgray", title = "CONT") +
        stat_overlay_normal_density(color = "red", linetype = "dashed") 
# there's that weird dip around 14 on the x-axis
```

Models!
What is the effect of warming (state) on the median date of flower?
```{r}
# state, year and insecticide are fixed effects with interaction btw state and year - species and plot are random effects

# normal dist
umbsMED_norm <- lmer(sqrt_julian ~ state*year_factor + insecticide + (1|species) + (1|plot), data = umbs_flwr_med, REML=FALSE)
summary(umbsMED_norm)

umbsFF_norm <- lmer(sqrt_julian ~ state*year_factor + insecticide + (1|species) + (1|plot), data = umbs_firstflwr, REML=FALSE)
summary(umbsFF_norm)
        
#### More models! This needs more work, I need to write out what each model is doing 
# Models using median flowering julian date

# Null model?
model0 <- lmer(sqrt_julian ~ 1 # This means median flower date (julian) is predicted by the intercept
               + (1|plot), data = umbs_flwr_med, REML=FALSE) # each plot gets its own intercept
summary(model0) 

# The effects of warming/ambient (state) on median date of flowering (julian) with species (species) as a random effect.
model1 <- lmer(sqrt_julian ~ state + (1|species), data = umbs_flwr_med, REML=FALSE)
summary(model1)

# The effects of warming/ambient on median date of flowering (julian - response variable) with an interaction between warming and native vs exotic species (origin) with species and year as a random effect.
model2 <- lmer(sqrt_julian ~ state*origin + (1|species) + (1|year_factor), data = umbs_flwr_med, REML=FALSE)
summary(model2)

# The effects of warming/ambient on median date of flowering with origin and insecticide as fixed effects and species and year_factor as random effects
model3 <- lmer(sqrt_julian ~ state + origin + insecticide + (1|species) + (1|year_factor), data = umbs_flwr_med, REML=FALSE)
summary(model3)
summ(model3)
```

Permanova
```{r}
#perma1 <- adonis2(julian ~ state + (1|species), data = umbs_flwr_med, permutations = 999, by = "terms")
#summary(perma1)

permanova.lmer(model1)
```

Updated from Kileigh's script
```{r, warning=FALSE}
#should plot be a random effect?
moda <- lmer(sqrt_julian ~ state*origin + insecticide + (1|species) + (1|plot), umbs_flwr_med, REML=FALSE)
mod1 <- lmer(sqrt_julian ~ state*origin + insecticide + (1|species), umbs_flwr_med, REML=FALSE)
anova(mod1,moda)
AIC(mod1, moda)

#Do we need insects?
mod2 <- lmer(sqrt_julian ~ state*origin + (1|species), umbs_flwr_med, REML=FALSE)
anova(mod2,mod1)

#Do we need interaction term?
mod3 <- lmer(sqrt_julian ~ state + origin + (1|species), umbs_flwr_med, REML=FALSE)
anova(mod3, mod2)
anova(mod3)
summary(mod3)
confint(mod3, method="boot", nsim=999)
difflsmeans(mod3, test.effs=NULL, ddf="Satterthwaite")
```

## KBS Data

```{r}
kbs_firstflwr <- subset(FirstFlower_all, site == "kbs") # pull out kbs only data

kbs_flwr_med <- subset(MedianFlwr_all, site == "kbs") # pull out kbs only data

hist(kbs_flwr_med$julian)
qqnorm(kbs_flwr_med$julian)
fit2 <- lm(julian ~ state, data = umbs_flwr_med)
qqPlot(fit2)
shapiro.test(kbs_flwr_med$julian) #not normal

descdist(kbs_flwr_med$julian, discrete = FALSE) # beta?

skewness(kbs_flwr_med$julian, na.rm = TRUE)  # slight positive skew

ggdensity(kbs_flwr_med, x = "julian", fill = "lightgray", title = "CONT") +
        stat_overlay_normal_density(color = "red", linetype = "dashed") 

# Because of positive skew I'm transforming the data by taking the square root
kbs_flwr_med$sqrt_julian <- sqrt(kbs_flwr_med$julian) 
hist(kbs_flwr_med$sqrt_julian)
skewness(kbs_flwr_med$sqrt_julian, na.rm = TRUE)

# Now try the log of julian dates
kbs_flwr_med$log_julian <- log10(kbs_flwr_med$julian)
hist(kbs_flwr_med$log_julian)
skewness(kbs_flwr_med$log_julian, na.rm = TRUE)

# Ok now try the inverse
kbs_flwr_med$inv_julian <- 1/(kbs_flwr_med$julian)
hist(kbs_flwr_med$inv_julian)
skewness(kbs_flwr_med$inv_julian, na.rm = TRUE) 
#taking the inverse of the julian dates made the data the least skewed
qqnorm(kbs_flwr_med$inv_julian)
shapiro.test(kbs_flwr_med$inv_julian) #still not normal

#pois <- glm(julian ~ state, data = kbs_flwr_med, family="poisson")
#hist(pois$residuals)
```


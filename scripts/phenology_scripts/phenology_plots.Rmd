---
title: "Phenology Visualization"
author: "Moriah Young"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  pdf_document: default
---

COLLABORATORS: Phoebe Zarnetske, Mark Hammond, Pat Bills, Kara Dobson  
DATA INPUT: Cleaned phenology data csv from the shared Google drive  
DATA OUTPUT: Code and Rmd are in the scripts folder in Github  
PROJECT: warmXtrophic  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Clear existing data
rm(list=ls())

# Load packages
library(tidyverse)
library(plotrix)
library(cowplot)

# Set working directory to Google Drive
setwd("/Volumes/GoogleDrive/Shared drives/SpaCE_Lab_warmXtrophic/data/")

# Read in data 
phen_data <- read.csv("/Volumes/GoogleDrive/Shared drives/SpaCE_Lab_warmXtrophic/data/L1/phenology/final_flw_sd_L1.csv", stringsAsFactors=FALSE)
# Get rid of "X" column that shows up
phen_data <- phen_data %>% 
        select(-X) 

# Create separate data frames for flowering and seeding
phen_flwr <- subset(phen_data, action == "flower")
phen_sd <- subset(phen_data, action == "seed")

# This creates a data frame that returns the first date of flower per species per plot
# Filter data to contain the date of first occurrence for each species

FirstFlower <- phen_flwr %>%
        group_by(plot, year, species, state, site, action) %>%
        summarize(julian = min(julian, na.rm=T))
        
sum_FirstFlower <- FirstFlower %>%
        group_by(site, state, species, year) %>%
        summarize(avg_julian = mean(julian, na.rm = TRUE),
                  se = std.error(julian, na.rm = TRUE))

sum_FirstFlwr <- FirstFlower %>%
        group_by(site, state, year) %>%
        summarize(avg_julian = mean(julian, na.rm = TRUE),
                  se = std.error(julian, na.rm = TRUE)) 
# this gives the average julian day of first flower for each site and year for warmed and ambient
```

## This creates a plot for a given species and site and for every year
```{r}
FirstFlower_plot <- function(spp, loc) { 
        FirstFlower_spp <- subset(sum_FirstFlower, species == spp & site == loc)
        return(ggplot(FirstFlower_spp, aes(x = state, y = avg_julian, fill = state)) +
                       facet_grid(.~year) +
                       geom_bar(position = "identity", stat = "identity") +
                       geom_errorbar(aes(ymin = avg_julian - se, ymax = avg_julian + se), width = 0.2,
                                     position = "identity") +
                       labs(x = "State", y = "Julian Day of First Flower", title = spp, subtitle = loc) +
                       scale_fill_manual(values = c("blue", "darkred")) +
                       scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
                       theme_grey())
}
```

```{r out.width=c('50%', '50%'), fig.show='hold', echo=FALSE}
FirstFlower_plot("Popr", "umbs")
FirstFlower_plot("Popr", "kbs")
FirstFlower_plot("Eugr", "kbs")
FirstFlower_plot("Soca", "kbs")
```

## This creates a function that returns plots for a given site and year for average first date of flower comparing ambient vs warmed plots
```{r}
sum_FirstFlwr_plot <- function(loc, yr) { 
        FirstFlwr_sub <- subset(sum_FirstFlwr, site == loc & year == yr)
        return(ggplot(FirstFlwr_sub, aes(x = state, y = avg_julian, fill = state)) +
                       facet_grid(.~year) +
                       geom_bar(position = "identity", stat = "identity") +
                       geom_errorbar(aes(ymin = avg_julian - se, ymax = avg_julian + se), width = 0.2,
                                     position = "identity") +
                       labs(x = "State", y = "Julian Day of First Flower", title = yr, subtitle = loc) +
                       scale_fill_manual(values = c("blue", "darkred")) +
                       scale_x_discrete(labels=c("ambient" = "A", "warmed" = "W")) +
                       theme_grey())
}
```

## KBS Plots
```{r, echo=FALSE}
kbs_2015 <- sum_FirstFlwr_plot("kbs", "2015")
kbs_2016 <- sum_FirstFlwr_plot("kbs", "2016")
kbs_2017 <- sum_FirstFlwr_plot("kbs", "2017")
kbs_2018 <- sum_FirstFlwr_plot("kbs", "2018")
kbs_2019 <- sum_FirstFlwr_plot("kbs", "2019")
kbs_2020 <- sum_FirstFlwr_plot("kbs", "2020")

plot_grid(kbs_2015, kbs_2016, kbs_2017, kbs_2018, kbs_2019, kbs_2020,
          ncol = 3, nrow = 2)
```

## UMBS Plots
```{r, echo=FALSE}
umbs_2016 <- sum_FirstFlwr_plot("umbs", "2016")
umbs_2017 <- sum_FirstFlwr_plot("umbs", "2017")
umbs_2018 <- sum_FirstFlwr_plot("umbs", "2018")
umbs_2019 <- sum_FirstFlwr_plot("umbs", "2019")
umbs_2020 <- sum_FirstFlwr_plot("umbs", "2020")

plot_grid(umbs_2016, umbs_2017, umbs_2018, umbs_2019, umbs_2020,
          ncol = 3, nrow = 2)
```

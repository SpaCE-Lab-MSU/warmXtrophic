---
title: "warmXtrophic Project: Greenup Analyses"
authors: "Kara Dobson, Phoebe Zarnetske"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=80),tidy=TRUE)
```
COLLABORATORS:  Moriah Young, Mark Hammond, Pat Bills  
DATA INPUT:     Data imported as csv files from shared Google drive "SpaCE_Lab_warmXtrophic" plant comp folder  
DATA OUTPUT:    a brief description of the data output from through the script, including what format itâ€™s in
OVERVIEW:       This script ... 
REQUIRES:       any scripts or code sources that are required
NOTES: 
The final_kbs and final_umbs dataframes contain data for greenup at each site.  
"half_cover_date" is the date at which 50% of a species max cover was reached (per plot, per year)  
"state" describes each treatment - warmed or ambient  

```{r echo=FALSE, message=FALSE}
# Clear all existing data
rm(list=ls())

#Load packages
library(tidyverse)
library(lme4)
library(olsrr)
library(predictmeans)
library(car)
library(fitdistrplus)
library(ggpubr)
library(rstatix)
library(vegan)

# Set working directory to Google Drive
# **** Update with the path to your Google drive on your computer
setwd("/Volumes/GoogleDrive/Shared drives/SpaCE_Lab_warmXtrophic/data/")

# Read in plant comp data
greenup <- read.csv("L1/greenup/final_greenup_L1.csv")
# check variable types
str(greenup)

# adding sequential year variable starting at 1
greenup$year1<-greenup$year
greenup$year[greenup$year == 2015] <- 1
greenup$year[greenup$year == 2016] <- 2
greenup$year[greenup$year == 2017] <- 3
greenup$year[greenup$year == 2018] <- 4
greenup$year[greenup$year == 2019] <- 5
greenup$year[greenup$year == 2020] <- 6

# create dataframes for kbs and umbs
final_kbs <- subset(greenup, site == "kbs")
final_umbs <- subset(greenup, site == "umbs")
```

# Data Exploration: are there differences between warmed vs. ambient plots?
# *Starting with KBS*

# First, checking for normality in raw data
```{r}
hist(final_kbs$half_cover_date)
qqnorm(final_kbs$half_cover_date)
shapiro.test(final_kbs$half_cover_date)

# histograms for each treatment separately - look almost identical
hist(final_kbs$half_cover_date[final_kbs$state == "ambient"])
hist(final_kbs$half_cover_date[final_kbs$state == "warmed"])

# histograms for each year
hist(final_kbs$half_cover_date[final_kbs$year == 1])
hist(final_kbs$half_cover_date[final_kbs$year == 2])
hist(final_kbs$half_cover_date[final_kbs$year == 3])
hist(final_kbs$half_cover_date[final_kbs$year == 4])
hist(final_kbs$half_cover_date[final_kbs$year == 5])
hist(final_kbs$half_cover_date[final_kbs$year == 6])
# looks like the 225 spike is from 2018 and 2020 
kbs_2018 <- subset(final_kbs, year == 4) # many records on 235
kbs_2020 <- subset(final_kbs, year == 6) # records from 227 & 228
```

\pagebreak

# Leverage plots?
```{r}
# checking fit for date as a function of state
fit <- lm(half_cover_date~state, data = final_kbs)
hist(fit$residuals)
leveragePlots(fit)

# checking fit for date as a function of state and year
fit2 <- lm(half_cover_date~state+year, data = final_kbs)
hist(fit2$residuals)
leveragePlots(fit2)
```

\pagebreak

# Not normal, and previously attempted transformations don't help (in R script)

# Seeing what other distribution could fit
```{r}
descdist(final_kbs$half_cover_date, discrete = FALSE)
```
# While uniform looks the closest, I'll try poisson
```{r, fig.align='center'}
fit <- lm(half_cover_date~state, data = final_kbs)
residual <- fit$residuals
hist(residual, main="Raw residuals")  
pois <- glm(half_cover_date~state, data = final_kbs, family="poisson")
hist(pois$residuals, main="Poisson glm residuals")
```

\pagebreak

# Below I try a few different generalized linear models with poisson distribution:  

## An interaction between state and year, plus insecticide as a fixed effect and species and plot as random effects
```{r}
moda <- glmer(half_cover_date ~ state*year + insecticide + (1|species) + (1|plot),
              data=final_kbs, family = poisson)
summary(moda)
```

\pagebreak

## No interaction between state and year, but with state and insecticide as fixed effects and species and plot as random effects
```{r}
modb <- glmer(half_cover_date ~ state + year + insecticide + (1|species) + (1|plot),
              data=final_kbs, family = poisson)
summary(modb)
```

\pagebreak

## State and insecticide as fixed effects & year, species and plot as random effects
```{r}
modc <- glmer(half_cover_date ~ state + insecticide + (1|year) + (1|species) + (1|plot),
              data=final_kbs, family = poisson)
summary(modc)
```

\pagebreak

# Because no distributions seems to match well, I'll try a Friedman's test
```{r}
#friedman_kbs <- final_kbs %>% 
#  friedman_test(half_cover_date ~ state)
```
## Error: Must extract column with a single valid subscript. x Subscript `var` can't be `NA`
## Can't figure out what this means  

## If I include the blocks portion of the formula (from the documentation) I get this error
```{r}
#friedman_kbs <- final_kbs %>% 
#  friedman_test(half_cover_date ~ state | plot)
```
## Error in friedman.test.default(c(141L, 202L, 122L, 101L, 127L, 120L, 197L,  :  not an unreplicated complete block design

# Permanova?
```{r}
knitr::opts_chunk$set(cache = TRUE)
per1 <- adonis2(final_kbs$half_cover_date ~ state*year + insecticide, data = final_kbs)
per1
```

\pagebreak

# *UMBS*

# Checking for normality

```{r}
hist(final_umbs$half_cover_date)
qqnorm(final_umbs$half_cover_date)
shapiro.test(final_umbs$half_cover_date)
hist(final_umbs$half_cover_date[final_kbs$state == "ambient"])
hist(final_umbs$half_cover_date[final_kbs$state == "warmed"])
```

## These look pretty good

\pagebreak

# Trying log transformation
```{r}
final_umbs$date_log <- log(final_umbs$half_cover_date)
hist(final_umbs$date_log)
shapiro.test(final_umbs$date_log)
```
## I think this looks good but shapiro-wilk is lower than 0.05

\pagebreak

# Trying inverse tranformation
```{r}
final_umbs$date_inv <- 1/(final_umbs$half_cover_date)
hist(final_umbs$date_inv)
shapiro.test(final_umbs$date_inv)
```
## This also looks good but is also still low for shapiro-wilk
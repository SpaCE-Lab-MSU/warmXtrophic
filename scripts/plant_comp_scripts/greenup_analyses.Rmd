---
title: "warmXtrophic Project: Greenup Analyses"
author: "Kara Dobson, Phoebe Zarnetske"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(kableExtra)
opts_chunk$set(tidy.opts=list(width.cutoff=80),tidy=TRUE)
```

# Script Details:
```{r, message = F}
script_tbl <- data.frame(
  Item = c("OVERVIEW", "COLLABORATORS", "REQUIRES", "DATA INPUT", "DATA OUTPUT", "NOTES"),
  Details = c("This script explores and analyses the greenup data from the KBS and UMBS stations. Greenup was recorded as percent cover of each species in each plot every 3 days in the beginning of the field season. Percent cover continued to be measured until the end of the field season. For calculating greenup dates, we use the date at which 50% of a species maximum percent cover was reached for each plot, to account for variation in litter depth affecting the early season's first greenup date.",
              "Moriah Young, Mark Hammond, Pat Bills",
              "Prior to running this script, make sure plant_comp_clean_L0.R is run and up to date. That script creates the final_greenup_L1.csv in the L1 folder in the Google drive, which contains the clean greenup data",
              "Data imported as csv files from shared Google drive 'SpaCE_Lab_warmXtrophic' plant comp folder",
              "... a brief description of the data output from through the script, including what format itâ€™s in",
              "Each row in 'greenup' is the date at which spp_half_cover_date was recorded, per species. The 'green_kbs' and 'green_umbs' dataframes contain data for greenup at each site."
  )
)

kbl(script_tbl) %>%
  kable_paper(full_width = F) %>%
  column_spec(1, bold = T, border_right = T) %>%
  column_spec(2, width = "30em", background = "lightblue")

metadata_tbl <- data.frame(
  Variable = c("spp_half_cover_date", "plot_half_cover_date", "state"),
  Definition = c("date at which 50% of a species max cover was reached (per species, per plot, per year)", 
    "the date at which 50% of a plot's max cover was reached (per plot, per year)",
    "describes each treatment: warmed or ambient"
  )
)

kbl(metadata_tbl) %>%
  kable_paper(full_width = F) %>%
  column_spec(1, bold = T, border_right = T) %>%
  column_spec(2, width = "30em", background = "lightyellow")

```

```{r, message = F}
# Clear all existing data
rm(list=ls())

#Load packages
library(tidyverse)
library(lme4)
library(olsrr)
library(predictmeans)
library(car)
library(fitdistrplus)
library(ggpubr)
library(rstatix)
library(vegan)
library(interactions)

# Set working directory to Google Drive
# **** Update with the path to your Google drive on your computer
setwd("/Volumes/GoogleDrive/Shared drives/SpaCE_Lab_warmXtrophic/data/")

# Read in plant comp data - edit this in "plant_comp_clean_L0.R" so it's not an issue here with extra column.
greenup <- read.csv("L1/greenup/final_greenup_L1.csv")
# check variable types
str(greenup)
# KARA: omit this once fixed in plant_comp_clean_L0.R
# remove first column 
greenup$X<-NULL

# adding sequential year variable starting at 1
greenup$year1<-greenup$year
greenup$year[greenup$year == 2015] <- 1
greenup$year[greenup$year == 2016] <- 2
greenup$year[greenup$year == 2017] <- 3
greenup$year[greenup$year == 2018] <- 4
greenup$year[greenup$year == 2019] <- 5
greenup$year[greenup$year == 2020] <- 6

# create dataframes for kbs and umbs - remember that these contain species within plots
green_kbs <- subset(greenup, site == "kbs")
green_umbs <- subset(greenup, site == "umbs")
```

# Data Exploration: are there differences between warmed vs. ambient plots when we account for species?
# *Starting with KBS*

# First, checking for normality in raw data. This is a little weird to do because each row in the dataframe is a species-plot combo, so you're missing the influence of species below. Instead, re-run this on plot-level half cover date (re-compute this in plant_comp_clean_L0.R to get that variable first).
# *Note that since this change, some of the code below breaks because the variable name changed. Also, there seem to be some errors popping up with qqPlot, suggesting that something else changed when this new variable was created. Check* 
```{r}
# note to self - re-organize greennup csv to remove species influence for this part (merge by plot)
hist(green_kbs$plot_half_cover_date)
qqnorm(green_kbs$plot_half_cover_date)
shapiro.test(green_kbs$plot_half_cover_date)

# histograms for each treatment separately - look almost identical
hist(green_kbs$plot_half_cover_date[green_kbs$state == "ambient"])
hist(green_kbs$plot_half_cover_date[green_kbs$state == "warmed"])

# histograms for each year
hist(green_kbs$plot_half_cover_date[green_kbs$year == 1])
hist(green_kbs$plot_half_cover_date[green_kbs$year == 2])
hist(green_kbs$plot_half_cover_date[green_kbs$year == 3])
hist(green_kbs$plot_half_cover_date[green_kbs$year == 4])
hist(green_kbs$plot_half_cover_date[green_kbs$year == 5])
hist(green_kbs$plot_half_cover_date[green_kbs$year == 6])
# looks like the 225 spike is from 2018 and 2020 - what's going on here is that you are treating all species-plot records as independent observations, so the influence of species differences is likely coming through here.
kbs_2018 <- subset(green_kbs, year == 4) # many records on 235
kbs_2020 <- subset(green_kbs, year == 6) # records from 227 & 228
```

\pagebreak

# Leverage plots and detecting Outliers. https://www.statmethods.net/stats/rdiagnostics.html
# These illustrate whether certain data points have more leverage (more influence), and thus could be outliers. It's a way of detecting outliers. Leverage plots can help identify whether a point has high or low influence, based on its leverage and residual and determining model fit with and without the point in question. Ultimately you decide whether the points are outliers or not, based on the knowledge of the system and how much it changes the model when included vs. excluded from the data used to fit the model. Here is a good overview of the combination of leverage and residual: scroll down to sections beginning at "13.3 Unusual Observations": https://daviddalpiaz.github.io/appliedstats/model-diagnostics.html
```{r}
# checking fit for date as a function of state and species - bringing in species here makes it obvious that that is explaining some of the variation compared with the state-only model you had previously.

# State-only model (not really correct bc species differ)
fit<- lm(spp_half_cover_date~state, data = green_kbs)
outlierTest(fit)

# State-only model - not really correct bc species are not included
fit<- lm(spp_half_cover_date~state, data = green_kbs)
outlierTest(fit) # looks like record # 5273 is an outlier (p-value <0.05)
qqPlot(fit, main="QQ Plot") 
hist(fit$residuals)
leveragePlots(fit)

# State and species model 
fit1 <- lm(spp_half_cover_date~state + species, data = green_kbs)
outlierTest(fit1) # looks like record # 5273 is still an outlier (p-value <<0.05)

hist(fit1$residuals)
qqPlot(fit1, main="QQ Plot") 
leveragePlots(fit1)

# checking fit for date as a function of state and year
fit2 <- lm(spp_half_cover_date~state+species+year, data = green_kbs)
hist(fit2$residuals)
qqPlot(fit2, main="QQ Plot") 
leveragePlots(fit2)
```

\pagebreak

# Normal distribution after accounting for species - we will be using species as a random effect to account for their variation. Set up some linear mixed effects models to evaluate.

```{r}

# Do we need to include plot as a random effect with the KBS models? Plot accounts for the multiple observations in a plot, so it's probably not necessary because year should account for that. If we care about understanding the year - to - year variation 
mod1 <- lmer(spp_half_cover_date ~ state + insecticide + year + (1|species) + (1|plot), green_kbs, REML=FALSE)
mod2 <- lmer(spp_half_cover_date ~ state + insecticide + year + (1|species), green_kbs, REML=FALSE)
=======
# Start by replicating (almost) what we did in the Oecologia 2018 paper. The only difference here is that we have multiple years, so we are also including year as a fixed effect. Later we'll add it as fixed and random (see below).

# Do we need to include plot as a random effect with the KBS models? Plot accounts for the multiple observations in a plot, so it's probably not necessary because year should account for that. 

mod1 <- lmer(half_cover_date ~ state + insecticide + year + (1|species) + (1|plot), green_kbs, REML=FALSE)
mod2 <- lmer(half_cover_date ~ state + insecticide + year + (1|species), green_kbs, REML=FALSE)

# Run an anova on 2 models to see if models differ.
# For interpretation of this test, see: https://bookdown.org/ndphillips/YaRrr/comparing-regression-models-with-anova.html
anova(mod2, mod1) # They aren't different so select more parsimonious (mod2)
summary(mod1) 
summary(mod2)

# Do we need to include insecticide? See: for interpretation of this test: https://bookdown.org/ndphillips/YaRrr/comparing-regression-models-with-anova.html
mod3 <- lmer(spp_half_cover_date ~ state + year + (1|species), green_kbs, REML=FALSE)

#Do we need to include insecticide? 
mod3 <- lmer(half_cover_date ~ state + year + (1|species), green_kbs, REML=FALSE)
anova(mod2, mod3)
# Looks like yes, insecticide improves model fit so we will continue to include it. 
```
Let's think about how the model should be set up given that species are measured in every year (they are repeated measures). Instead of adding year as a fixed effect only, we should acknowledge that species are measured within every year. So a better way to set the model up is below, accounting for species nested within year. 

We should also think about how we're treating year. The formulation below also has a state * year interaction as a fixed effect, which means that the warming or ambient treatment could affect the half_cover_date differently over time (there would be a different slope for each state in the relationship between half_cover_date (y) and year (x)). If we just had state + year, the states would have the same slope, indicating that they have no interaction in their effect on half_cover_date.

```{r}
# Interaction plot (ignore for now the repeated measures with species); see: https://cran.r-project.org/web/packages/interactions/vignettes/interactions.html and: https://interactions.jacob-long.com/

fit3 <- lm(plot_half_cover_date ~ state + year, data = green_kbs)
interact_plot(fit3, pred = year, modx = state)
fit4 <- lm(plot_half_cover_date ~ state * year, data = green_kbs)
interact_plot(fit4, pred = year, modx = state)

# New version of our model incorporating interaction term and species within year so that there is a separate intercept and slope for each species. The issue here is that there are some species that are not found each year. Easiest to remove those from another version of this dataframe before running below. Otherwise, it's not a balanced design.
mod4 <- lmer(spp_half_cover_date ~ state * year + (1+year|species), green_kbs)

# So another version of this model would include the interaction but not include the nesting (and thus would assume that species aren't observed ea yr)
mod5 <- lmer(spp_half_cover_date ~ state * year + (1|species), green_kbs)
summary(mod5) 

```

# *ORIGINAL CODE BELOW; not edited by Phoebe* ##

# Seeing what other distribution could fit
```{r}
descdist(green_kbs$spp_half_cover_date, discrete = FALSE)
```
# While uniform looks the closest, I'll try poisson
```{r, fig.align='center'}
fit <- lm(spp_half_cover_date~state, data = green_kbs)
residual <- fit$residuals
hist(residual, main="Raw residuals")  
pois <- glm(spp_half_cover_date~state, data = green_kbs, family="poisson")
hist(pois$residuals, main="Poisson glm residuals")
```

\pagebreak

# Below I try a few different generalized linear models with poisson distribution:  

## An interaction between state and year, plus insecticide as a fixed effect and species and plot as random effects
```{r}
moda <- glmer(spp_half_cover_date ~ state*year + insecticide + (1|species) + (1|plot),
              data=green_kbs, family = poisson)
summary(moda)
```

\pagebreak

## No interaction between state and year, but with state and insecticide as fixed effects and species and plot as random effects
```{r}
modb <- glmer(spp_half_cover_date ~ state + year + insecticide + (1|species) + (1|plot),
              data=green_kbs, family = poisson)
summary(modb)
```

\pagebreak

## State and insecticide as fixed effects & year, species and plot as random effects
```{r}
modc <- glmer(spp_half_cover_date ~ state + insecticide + (1|year) + (1|species) + (1|plot),
              data=green_kbs, family = poisson)
summary(modc)
```

\pagebreak

# Because no distributions seems to match well, I'll try a Friedman's test
```{r}
#friedman_kbs <- green_kbs %>% 
#  friedman_test(spp_half_cover_date ~ state)
```
## Error: Must extract column with a single valid subscript. x Subscript `var` can't be `NA`
## Can't figure out what this means  

## If I include the blocks portion of the formula (from the documentation) I get this error
```{r}
#friedman_kbs <- green_kbs %>% 
#  friedman_test(spp_half_cover_date ~ state | plot)
```
## Error in friedman.test.default(c(141L, 202L, 122L, 101L, 127L, 120L, 197L,  :  not an unreplicated complete block design

# Permanova?
```{r, cache = T}
per1 <- adonis2(green_kbs$spp_half_cover_date ~ state*year + insecticide, data = green_kbs)
per1
per2 <- adonis(formula = green_kbs$spp_half_cover_date ~ state*year + insecticide, strata = green_kbs$plot, data = green_kbs)
per2
```
# With per2, when controlling for "plot", there is a difference btwn treatments

\pagebreak

# *UMBS*

# Checking for normality

```{r}
hist(green_umbs$spp_half_cover_date)
qqnorm(green_umbs$spp_half_cover_date)
shapiro.test(green_umbs$spp_half_cover_date)
hist(green_umbs$spp_half_cover_date[green_kbs$state == "ambient"])
hist(green_umbs$spp_half_cover_date[green_kbs$state == "warmed"])
```

## These look pretty good

\pagebreak

# Trying log transformation
```{r}
green_umbs$date_log <- log(green_umbs$spp_half_cover_date)
hist(green_umbs$date_log)
shapiro.test(green_umbs$date_log)
```
## I think this looks good but shapiro-wilk is lower than 0.05

\pagebreak

# Trying inverse tranformation
```{r}
green_umbs$date_inv <- 1/(green_umbs$spp_half_cover_date)
hist(green_umbs$date_inv)
shapiro.test(green_umbs$date_inv)
```
## This also looks good but is also still low for shapiro-wilk